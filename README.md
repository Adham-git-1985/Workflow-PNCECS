# Workflow‑PNCECS (مسار + البوابة الإدارية)

مشروع Flask/SQLAlchemy يجمع بين:
- **نظام مسار (Workflow Engine)** لإدارة الطلبات/المعاملات والموافقات والتنبيهات والتقارير.
- **البوابة الإدارية (Portal/HR)** لتقديم خدمات الموظف (دوام/حضور/مغادرات/إجازات/مستودع… حسب الصلاحيات).

> **ملاحظة:** هذا المستودع مخصص للتطوير الداخلي. تأكد من ضبط الإعدادات الأمنية قبل النشر.

---

## المتطلبات
- Python **3.11+** (يعمل على Windows وLinux)
- SQLite (افتراضيًا) — ويمكن التبديل لاحقًا إلى PostgreSQL

---

## تشغيل سريع (Development)

### 1) إنشاء بيئة وتشغيل المتطلبات
```bash
python -m venv .venv
# Windows
.venv\Scripts\activate
# Linux/macOS
source .venv/bin/activate

pip install -r requirements.txt
```

### 2) تهيئة قاعدة البيانات + Seed
```bash
python init_db.py
```
سيقوم السكربت بإنشاء الجداول + الفهارس + Seed من ملف `seed.xlsx` (إن وجد) وإضافة مستخدمين افتراضيين.

### 3) تشغيل التطبيق
```bash
python app.py
# أو
flask --app app run --debug
```

---

## أهم الروابط داخل النظام
- **مسار (Workflow)**: 
  - صندوق الوارد: `/workflow/inbox`
  - إنشاء طلب: `/workflow/request/new`
- **الأرشيف (Archive)**:
  - رفع ملف: `/archive/upload`
- **البوابة الإدارية (Portal)**:
  - الصفحة الرئيسية: `/portal/`
  - الموارد البشرية (أمثلة): `/portal/hr/*`

---

## تحديثات (Highlights)

### 1) شعبة (Division) بعد الأقسام
- تمت إضافة كيان **Division** في الهيكل التنظيمي.
- **الشعبة اختيارية** ويمكن أن تتبع:
  - **قسم (Section)** أو
  - **دائرة (Department)**
- تم ربطها مع صفحات **Master Data** والصلاحيات والواجهات بنفس نمط المنظمات/الإدارات/الدوائر/الأقسام.

### 2) تحسينات العلاقات في الهيكل التنظيمي
- دعم إسناد **القسم (Section)** إلى **إدارة (Directorate)** أو **دائرة (Department)** (اختياريًا).

### 3) Timeclock Auto‑Sync (قراءة ملف الدوام تلقائيًا)
- بدل تحميل ملف الدوام يدويًا، يمكن للنظام قراءة الملف مباشرة من **مسار ثابت على السيرفر**.
- يتم تشغيل مهمة مزامنة تلقائية (Scheduler) وتحديث بيانات الحضور.
- **ملاحظة Flask 3:** تم استبدال `before_first_request` (الذي أزيل في Flask 3) بمنطق تشغيل مرّة واحدة على أول Request.

> الإعدادات المهمة في `config.py` أو Environment:
- `TIME_CLOCK_FILE` : مسار ملف الدوام على السيرفر
- `TIME_CLOCK_SYNC_ENABLED` : تفعيل/تعطيل المزامنة
- `TIME_CLOCK_SYNC_INTERVAL_SECONDS` : فترة التحديث

### 4) تحسينات UX عامة للبوابة
- **ترتيب (Sorting) Server‑Side** لكل جداول البوابة عبر الضغط على عنوان العمود.
- **بحث عام** يدعم البحث في **كل الأعمدة** (وليس عمود الاسم فقط).
- **قوائم منسدلة قابلة للبحث** (Searchable Dropdowns) في مسار + البوابة لتسهيل اختيار الدوائر/الأقسام… إلخ.

### 5) CTA موحد في الشريط الجانبي
- توحيد مظهر اختصارات **طلب جديد** و **رفع ملف** بنفس اللون (Primary) مع تصميم مميز (`nav-cta`) و Responsive.

---

## ملفات تشغيل/تسليم (Handover)
- راجع الملف: `docs/HANDOVER.md`

---

## ملاحظات
- يفضل تشغيل النظام خلف Reverse Proxy في الإنتاج مع HTTPS.
- راجع إعدادات رفع الملفات وقيود الامتدادات وCSRF قبل النشر.

