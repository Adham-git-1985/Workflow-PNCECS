{% extends "layout.html" %}
{% block title %}Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª | Ø§Ù„Ù…Ø±Ø³Ù„Ø©{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="mb-1">ğŸ“¤ Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª - Ø§Ù„Ù…Ø±Ø³Ù„Ø©</h3>
      <small class="text-muted">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙŠ Ø£Ø±Ø³Ù„ØªÙ‡Ø§</small>
    </div>
    <div class="d-flex gap-2">
      <a href="{{ url_for('messages.compose') }}" class="btn btn-primary">âœ‰ï¸ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</a>
      <a href="{{ url_for('messages.inbox') }}" class="btn btn-outline-secondary">ğŸ“¥ Ø§Ù„ÙˆØ§Ø±Ø¯</a>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      {% if messages %}
        <div class="table-responsive">
          <table class="table align-middle mb-0">
            <thead>
              <tr>
                <th>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</th>
                <th style="width:170px">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th style="width:180px">Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</th>
                <th style="width:160px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody>
              {% for m in messages %}
                <tr>
                  <td>
                    <a href="{{ url_for('messages.view_message', message_id=m.id) }}" class="text-decoration-none">
                      <strong>{{ m.subject or 'Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ¶ÙˆØ¹' }}</strong>
                      <div class="text-muted small text-truncate" style="max-width:720px">{{ m.body }}</div>
                    </a>
                  </td>
                  <td class="text-muted">{{ m.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                  <td>
                    {% set unread_recs = (m.recipients | selectattr('is_read', 'equalto', False) | list) %}
                    {% set read_recs = (m.recipients | selectattr('is_read', 'equalto', True) | list) %}

                    {% if unread_recs|length > 0 %}
                      <span class="badge bg-warning text-dark">ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡Ø© Ù„Ø¯Ù‰ {{ unread_recs|length }}</span>
                      <div class="small text-muted mt-1">
                        {% for r in unread_recs[:2] %}
                          <div>â€¢ {{ r.recipient.full_name }} <span class="text-muted">({{ r.recipient.email }})</span></div>
                        {% endfor %}
                        {% if unread_recs|length > 2 %}
                          <div>â€¦ Ùˆ {{ unread_recs|length - 2 }} Ø¢Ø®Ø±ÙŠÙ†</div>
                        {% endif %}
                      </div>
                    {% else %}
                      <span class="badge bg-success">Ù…Ù‚Ø±ÙˆØ¡Ø©</span>
                      <div class="small text-muted mt-1">
                        {% for r in read_recs[:2] %}
                          <div>
                            â€¢ {{ r.recipient.full_name }} <span class="text-muted">({{ r.recipient.email }})</span>
                            {% if r.read_at %}<span class="text-muted"> â€” {{ r.read_at.strftime('%Y-%m-%d %H:%M') }}</span>{% endif %}
                          </div>
                        {% endfor %}
                        {% if read_recs|length > 2 %}
                          <div>â€¦ Ùˆ {{ read_recs|length - 2 }} Ø¢Ø®Ø±ÙŠÙ†</div>
                        {% endif %}
                      </div>
                    {% endif %}
                  </td>
                  <td>
                    <div class="d-flex gap-1">
                      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('messages.view_message', message_id=m.id) }}">Ø¹Ø±Ø¶</a>
                      <form method="post" action="{{ url_for('messages.delete_message', message_id=m.id) }}" onsubmit="return confirm('Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø±Ø³Ù„Ø©ØŸ')">
                        <button type="submit" class="btn btn-sm btn-outline-danger">Ø­Ø°Ù</button>
                      </form>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        {% if pagination.pages > 1 %}
        <nav class="mt-3">
          <ul class="pagination justify-content-center mb-0">
            {% if pagination.has_prev %}
              <li class="page-item"><a class="page-link" href="{{ url_for('messages.sent', page=pagination.prev_num) }}">Ø§Ù„Ø³Ø§Ø¨Ù‚</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Ø§Ù„Ø³Ø§Ø¨Ù‚</span></li>
            {% endif %}

            <li class="page-item disabled"><span class="page-link">{{ pagination.page }} / {{ pagination.pages }}</span></li>

            {% if pagination.has_next %}
              <li class="page-item"><a class="page-link" href="{{ url_for('messages.sent', page=pagination.next_num) }}">Ø§Ù„ØªØ§Ù„ÙŠ</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Ø§Ù„ØªØ§Ù„ÙŠ</span></li>
            {% endif %}
          </ul>
        </nav>
        {% endif %}
      {% else %}
        <div class="alert alert-info mb-0">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ù…Ø±Ø³Ù„Ø©.</div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
