{% extends "layout.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h3 class="mb-1">ğŸ§‘â€ğŸ¤â€ğŸ§‘ {% if can_manage %}Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª{% else %}ØªÙÙˆÙŠØ¶ÙŠ{% endif %}</h3>
    <small class="text-muted">ØªØ­Ø¯ÙŠØ¯ ØªÙÙˆÙŠØ¶ Ø¨ØªØ§Ø±ÙŠØ® Ù…Ø­Ø¯Ø¯ Ø£Ùˆ Ù„Ù…Ø¯Ø© (Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù…) Ø£Ùˆ Ø¨ÙˆÙ‚Øª Ø§Ù†ØªÙ‡Ø§Ø¡ (Expiry).</small>
  </div>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-header bg-light">
    <strong>Ø¥Ù†Ø´Ø§Ø¡ ØªÙÙˆÙŠØ¶ Ø¬Ø¯ÙŠØ¯</strong>
  </div>
  <div class="card-body">
    <form method="post" action="{{ url_for('delegation.create') }}" class="row g-3">
      {% if can_manage %}
      <div class="col-md-4">
        <label class="form-label">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£ØµÙŠÙ„ (Delegator)</label>
        <select name="from_user_id" class="form-select" required>
          <option value="">â€” Ø§Ø®ØªØ± â€”</option>
          {% for u in users %}
            {% if u.id != current_user.id %}
              <option value="{{ u.id }}">{{ u.email }}{% if u.name %} â€” {{ u.name }}{% endif %}</option>
            {% endif %}
          {% endfor %}
        </select>
      </div>
      {% else %}
      <div class="col-md-4">
        <label class="form-label">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£ØµÙŠÙ„ (Delegator)</label>
        <input type="text" class="form-control" value="{{ current_user.email }}{% if current_user.name %} â€” {{ current_user.name }}{% endif %}" disabled>
        <input type="hidden" name="from_user_id" value="{{ current_user.id }}">
      </div>
      {% endif %}

      <div class="col-md-4">
        <label class="form-label">Ø§Ù„Ù…ÙÙˆÙ‘Ø¶ Ø¥Ù„ÙŠÙ‡ (Delegatee)</label>
        <select name="to_user_id" class="form-select" required>
          <option value="">â€” Ø§Ø®ØªØ± â€”</option>
          {% for u in users %}
            {% if u.id != current_user.id %}
              <option value="{{ u.id }}">{{ u.email }}{% if u.name %} â€” {{ u.name }}{% endif %}</option>
            {% endif %}
          {% endfor %}
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label">Ø·Ø±ÙŠÙ‚Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¯Ø©</label>
        <select name="mode" id="modeSelect" class="form-select">
          <option value="days" selected>Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù…</option>
          <option value="day">ÙŠÙˆÙ… Ù…Ø­Ø¯Ø¯</option>
          <option value="expiry">Expiry (ÙˆÙ‚Øª Ø¨Ø¯Ø§ÙŠØ©/Ù†Ù‡Ø§ÙŠØ©)</option>
        </select>
      </div>

      <!-- days -->
      <div class="col-md-4 mode mode-days">
        <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label>
        <input type="date" name="start_day" class="form-control">
      </div>
      <div class="col-md-4 mode mode-days">
        <label class="form-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…</label>
        <input type="number" name="days_count" min="1" class="form-control" placeholder="Ù…Ø«Ø§Ù„: 3">
      </div>

      <!-- day -->
      <div class="col-md-4 mode mode-day d-none">
        <label class="form-label">Ø§Ù„ÙŠÙˆÙ…</label>
        <input type="date" name="day" class="form-control">
      </div>

      <!-- expiry -->
      <div class="col-md-4 mode mode-expiry d-none">
        <label class="form-label">Ø¨Ø¯Ø§ÙŠØ© (datetime)</label>
        <input type="datetime-local" name="start_dt" class="form-control">
      </div>
      <div class="col-md-4 mode mode-expiry d-none">
        <label class="form-label">Ù†Ù‡Ø§ÙŠØ© (datetime)</label>
        <input type="datetime-local" name="end_dt" class="form-control">
      </div>

      <div class="col-md-12">
        <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <textarea name="note" rows="2" class="form-control" placeholder="Ø³Ø¨Ø¨ Ø§Ù„ØªÙÙˆÙŠØ¶ Ø£Ùˆ ØªØ¹Ù„ÙŠÙ…Ø§Øª..."></textarea>
      </div>

      <div class="col-12">
        <button class="btn btn-primary">
          <i class="bi bi-check2-circle"></i>
          Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙÙˆÙŠØ¶
        </button>
      </div>
    </form>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-header bg-light">
    <strong>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª</strong>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Ø§Ù„Ø£ØµÙŠÙ„</th>
            <th>Ø§Ù„Ù…ÙÙˆÙ‘Ø¶ Ø¥Ù„ÙŠÙ‡</th>
            <th>Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
            <th>Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th class="text-end">Ø¥Ø¬Ø±Ø§Ø¡</th>
          </tr>
        </thead>
        <tbody>
        {% for d in delegations %}
          {% set status = "Ù…Ù†ØªÙ‡ÙŠ" %}
          {% set badge = "secondary" %}
          {% if not d.is_active %}
            {% set status = "Ù…Ù„ØºÙ‰" %}
            {% set badge = "danger" %}
          {% else %}
            {% if d.starts_at and d.expires_at and now >= d.starts_at and now <= d.expires_at %}
              {% set status = "Ù†Ø´Ø·" %}
              {% set badge = "success" %}
            {% elif d.starts_at and now < d.starts_at %}
              {% set status = "Ù‚Ø§Ø¯Ù…" %}
              {% set badge = "warning" %}
            {% else %}
              {% set status = "Ù…Ù†ØªÙ‡ÙŠ" %}
              {% set badge = "secondary" %}
            {% endif %}
          {% endif %}

          <tr>
            <td>{{ d.id }}</td>
            <td>
              {% if d.from_user %}<strong>{{ d.from_user.email }}</strong>{% else %}#{{ d.from_user_id }}{% endif %}
            </td>
            <td>
              {% if d.to_user %}<strong>{{ d.to_user.email }}</strong>{% else %}#{{ d.to_user_id }}{% endif %}
            </td>
            <td>{{ d.starts_at.strftime("%Y-%m-%d %H:%M") if d.starts_at else "-" }}</td>
            <td>{{ d.expires_at.strftime("%Y-%m-%d %H:%M") if d.expires_at else "-" }}</td>
            <td><span class="badge bg-{{ badge }}">{{ status }}</span></td>
            <td class="text-end">
              {% if d.is_active %}
                <form method="post" action="{{ url_for('delegation.revoke', delegation_id=d.id) }}" onsubmit="return confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙÙˆÙŠØ¶ØŸ');">
                  <button class="btn btn-sm btn-outline-danger">
                    <i class="bi bi-x-circle"></i>
                    Ø¥Ù„ØºØ§Ø¡
                  </button>
                </form>
              {% else %}
                <span class="text-muted small">â€”</span>
              {% endif %}
            </td>
          </tr>
          {% if d.note %}
            <tr class="table-light">
              <td></td>
              <td colspan="6">
                <small class="text-muted">ğŸ“ {{ d.note }}</small>
              </td>
            </tr>
          {% endif %}
        {% else %}
          <tr>
            <td colspan="7" class="text-center py-4 text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙÙˆÙŠØ¶Ø§Øª.</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
(function() {
  const mode = document.getElementById('modeSelect');
  const toggle = () => {
    const v = (mode.value || 'days');
    document.querySelectorAll('.mode').forEach(el => el.classList.add('d-none'));
    document.querySelectorAll('.mode-' + v).forEach(el => el.classList.remove('d-none'));
  };
  if (mode) {
    mode.addEventListener('change', toggle);
    toggle();
  }
})();
</script>

{% endblock %}
