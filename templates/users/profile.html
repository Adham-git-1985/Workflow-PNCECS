{% extends "layout.html" %}
{% block title %}ุงูููู ุงูุดุฎุตู{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
  <div>
    <h3 class="mb-1">๐ค ุงูููู ุงูุดุฎุตู</h3>
    <small class="text-muted">ููููู ุชุญุฏูุซ ุจูุงูุงุช ุญุณุงุจู (ุงูุงุณู/ุงููุณูู/ุงูุจุฑูุฏ/ูููุฉ ุงููุฑูุฑ). ุจูุงูุงุช ุงูููุธู ุชูุฏุงุฑ ูู ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ ูู ุงูุจูุงุจุฉ ุงูุฅุฏุงุฑูุฉ.</small>
  </div>
  <div class="btn-group">
    <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('portal.index') }}">
      <i class="bi bi-building"></i> ูุชุญ ุงูุจูุงุจุฉ ุงูุฅุฏุงุฑูุฉ
    </a>
    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('portal.hr_me_home') }}">
      <i class="bi bi-person-lines-fill"></i> ุฎุฏูุงุช ุงูููุธู (ุงูุจูุงุจุฉ)
    </a>
    {# HR/Admin shortcut: open the employee file page for self. #}
    {% if current_user.has_perm('HR_EMPLOYEE_READ') or current_user.has_perm('HR_EMPLOYEE_MANAGE') %}
      <a class="btn btn-sm btn-outline-dark" href="{{ url_for('portal.hr_employee_file', user_id=current_user.id) }}">
        <i class="bi bi-folder2-open"></i> ูููู (HR)
      </a>
    {% endif %}
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-6">

    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h5 class="mb-3">๐ผ๏ธ ุตูุฑุฉ ุงูููู ุงูุดุฎุตู</h5>

        <div class="d-flex align-items-center gap-3 flex-wrap">
          <img
            src="{% if current_user.avatar_filename %}{{ url_for('static', filename='uploads/avatars/' ~ current_user.avatar_filename) }}{% else %}{{ url_for('static', filename='images/avatar_default.svg') }}{% endif %}"
            alt="Avatar"
            style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:1px solid rgba(0,0,0,.15);"
          >

          <form method="post" enctype="multipart/form-data" class="flex-grow-1">
            <input type="hidden" name="form_type" value="avatar">
            <input class="form-control mb-2" type="file" name="avatar" accept="image/*" required>
            <button class="btn btn-outline-primary btn-sm">ุชุญุฏูุซ ุงูุตูุฑุฉ</button>
            <div class="text-muted mt-2" style="font-size:0.9rem">ุงูุงูุชุฏุงุฏุงุช ุงููุณููุญุฉ: png, jpg, jpeg, gif, webp</div>
          </form>
        </div>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="mb-3">๐งพ ุจูุงูุงุช ุงูุญุณุงุจ</h5>
        <form method="post">
          <input type="hidden" name="form_type" value="profile">

          <div class="mb-3">
            <label class="form-label">ุงูุงุณู</label>
            <input type="text" name="name" class="form-control" value="{{ current_user.name or '' }}">
          </div>

          <div class="mb-3">
            <label class="form-label">ุงููุณูู ุงููุธููู</label>
            <input type="text" name="job_title" class="form-control" value="{{ current_user.job_title or '' }}">
          </div>

          <div class="mb-3">
            <label class="form-label">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
            <input type="email" name="email" class="form-control" value="{{ current_user.email }}" required>
          </div>

          <div class="mb-3">
            <label class="form-label">ุงูุฏูุฑ (ุบูุฑ ูุงุจู ููุชุนุฏูู)</label>
            <input type="text" class="form-control" value="{{ current_user.role }}" readonly>
          </div>

          <div class="mb-3">
            <label class="form-label">ูููุฉ ุงููุฑูุฑ ุงูุญุงููุฉ (ูุชุฃููุฏ ุงูุชุนุฏูู)</label>
            <input type="password" name="current_password" class="form-control" required>
          </div>

          <button class="btn btn-primary">ุญูุธ ุงูุชุบููุฑุงุช</button>
        </form>
      </div>
    </div>

    <div class="card shadow-sm mt-3">
      <div class="card-body">
        <h5 class="mb-3">๐ข ุงููููู ุงูุชูุธููู</h5>
        <div class="row g-2">
          <div class="col-md-4">
            <div class="small text-muted">ุงููุคุณุณุฉ</div>
            <div>{{ organization.name if organization else "โ" }}</div>
          </div>
          <div class="col-md-4">
            <div class="small text-muted">ุงููุฏูุฑูุฉ</div>
            <div>{{ directorate.name_ar if directorate else "โ" }}</div>
          </div>
          <div class="col-md-4">
            <div class="small text-muted">ุงููุญุฏุฉ</div>
            <div>{{ unit.name_ar if unit else "โ" }}</div>
          </div>
          <div class="col-md-4">
            <div class="small text-muted">ุงูุฏุงุฆุฑุฉ</div>
            <div>{{ dept.name_ar if dept else "โ" }}</div>
          </div>
          <div class="col-md-4">
            <div class="small text-muted">ุงููุณู</div>
            <div>{{ section.name_ar if section else "โ" }}</div>
          </div>
          <div class="col-md-4">
            <div class="small text-muted">ุงูุดุนุจุฉ</div>
            <div>{{ division.name_ar if division else "โ" }}</div>
          </div>
        </div>
        <small class="text-muted d-block mt-2">ูุฐู ุงููุนูููุงุช ุชูุฏุงุฑ ูู ุงูุฅุฏุงุฑุฉ.</small>
      </div>
    </div>

  </div>

  <div class="col-lg-6" id="password">

    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="mb-3">๐ ุชุบููุฑ ูููุฉ ุงููุฑูุฑ</h5>

        <form method="post">
          <input type="hidden" name="form_type" value="password">

          <div class="mb-3">
            <label class="form-label">ูููุฉ ุงููุฑูุฑ ุงูุญุงููุฉ</label>
            <input type="password" name="current_password" class="form-control" required>
          </div>

          <div class="mb-3">
            <label class="form-label">ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ</label>
            <input type="password" name="new_password" class="form-control" required>
          </div>

          <div class="mb-3">
            <label class="form-label">ุชุฃููุฏ ูููุฉ ุงููุฑูุฑ</label>
            <input type="password" name="confirm_password" class="form-control" required>
          </div>

          <button type="submit" class="btn btn-success">ุชุญุฏูุซ ูููุฉ ุงููุฑูุฑ</button>
        </form>

      </div>
    </div>

    <div class="card shadow-sm mt-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">๐ ููู ุงูููุธู (ูู ุงูุจูุงุจุฉ ุงูุฅุฏุงุฑูุฉ)</h5>
          {% if emp_file and emp_file.updated_at %}
            <small class="text-muted">ุขุฎุฑ ุชุญุฏูุซ: {{ emp_file.updated_at.strftime('%Y-%m-%d %H:%M') }}</small>
          {% endif %}
        </div>

        {% if emp_file %}
          <div class="row g-2 mb-3">
            <div class="col-md-4">
              <div class="small text-muted">ุงูุฑูู ุงููุธููู</div>
              <div class="fw-semibold">{{ emp_file.employee_no or "โ" }}</div>
            </div>
            <div class="col-md-4">
              <div class="small text-muted">ููุฏ ุงูุณุงุนุฉ</div>
              <div class="fw-semibold">{{ emp_file.timeclock_code or "โ" }}</div>
            </div>
            <div class="col-md-4">
              <div class="small text-muted">ุงูุฏุฑุฌุฉ</div>
              <div class="fw-semibold">{{ emp_file.grade or "โ" }}</div>
            </div>
          </div>

          <div class="border rounded-3 p-3 mb-3">
            <div class="fw-semibold mb-2">๐ง ุจูุงูุงุช ุดุฎุตูุฉ</div>
            <div class="row g-2">
              <div class="col-md-6"><span class="text-muted">ุฑูู ุงููููุฉ:</span> {{ emp_file.national_id or "โ" }}</div>
              <div class="col-md-6"><span class="text-muted">ุชุงุฑูุฎ ุงููููุงุฏ:</span> {{ emp_file.birth_date or "โ" }}</div>
              <div class="col-md-6"><span class="text-muted">ุงููุงุชู:</span> {{ emp_file.phone or "โ" }}</div>
              <div class="col-md-6"><span class="text-muted">ุงูุนููุงู:</span> {{ emp_file.address or "โ" }}</div>
            </div>
          </div>

          <div class="border rounded-3 p-3 mb-3">
            <div class="fw-semibold mb-2">๐ท๏ธ ุจูุงูุงุช ูุธูููุฉ</div>
            <div class="row g-2">
              <div class="col-md-6"><span class="text-muted">ุงููุณูู ุงููุธููู:</span> {{ emp_file.job_title or "โ" }}</div>
              <div class="col-md-6"><span class="text-muted">ุญุงูุฉ ุงูุชูุธูู:</span> {{ emp_file.employment_status or "โ" }}</div>
              <div class="col-md-6"><span class="text-muted">ุชุงุฑูุฎ ุงูุชุนููู:</span> {{ emp_file.hire_date or "โ" }}</div>
            </div>
          </div>

          <div class="border rounded-3 p-3 mb-3">
            <div class="fw-semibold mb-2">๐ ุงูุนูุฏ</div>
            <div class="row g-2">
              <div class="col-md-4"><span class="text-muted">ููุน ุงูุนูุฏ:</span> {{ emp_file.contract_type or "โ" }}</div>
              <div class="col-md-4"><span class="text-muted">ุจุฏุงูุฉ ุงูุนูุฏ:</span> {{ emp_file.contract_start or "โ" }}</div>
              <div class="col-md-4"><span class="text-muted">ููุงูุฉ ุงูุนูุฏ:</span> {{ emp_file.contract_end or "โ" }}</div>
            </div>
          </div>

          <div class="border rounded-3 p-3 mb-3">
            <div class="fw-semibold mb-2">๐ฐ ุงูุฑุงุชุจ ูุงูุจูู</div>
            <div class="row g-2">
              <div class="col-md-4"><span class="text-muted">ุงูุฑุงุชุจ ุงูุฃุณุงุณู:</span> {{ emp_file.salary_basic if emp_file.salary_basic is not none else "โ" }}</div>
              <div class="col-md-4"><span class="text-muted">ุงูุนููุฉ:</span> {{ emp_file.salary_currency or "โ" }}</div>
              <div class="col-md-6"><span class="text-muted">ุงูุจูู:</span> {{ emp_file.bank_name or "โ" }}</div>
              <div class="col-md-6"><span class="text-muted">ุฑูู ุงูุญุณุงุจ:</span> {{ emp_file.bank_account or "โ" }}</div>
            </div>
          </div>

          {% if emp_file.notes %}
            <div class="alert alert-secondary mb-0">
              <div class="fw-semibold mb-1">๐ ููุงุญุธุงุช</div>
              <div style="white-space:pre-wrap">{{ emp_file.notes }}</div>
            </div>
          {% else %}
            <div class="text-muted">ูุง ุชูุฌุฏ ููุงุญุธุงุช.</div>
          {% endif %}

        {% else %}
          <div class="text-muted">ูุง ููุฌุฏ ููู ููุธู ููุณุฌูู ูู ุญุชู ุงูุขู. ุชูุงุตู ูุน ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ ูุฅููุงู ุจูุงูุงุชู.</div>
        {% endif %}

        <div class="text-muted mt-3" style="font-size:0.9rem">ูุฐู ุงูุจูุงูุงุช ููุนุฑุถ ููุท ุฏุงุฎู ูุณุงุฑุ ููุชู ุชุนุฏูููุง ูู ุงูุจูุงุจุฉ ุงูุฅุฏุงุฑูุฉ.</div>
      </div>
    </div>

    <div class="card shadow-sm mt-3">
      <div class="card-body">
        <h5 class="mb-3">๐ ุงููุซุงุฆู ูุงููุฑููุงุช</h5>

        {% if emp_atts and emp_atts|length > 0 %}
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>ุงูููุน</th>
                  <th>ุงูููู</th>
                  <th>ููุงุญุธุฉ</th>
                  <th>ุงูุชุงุฑูุฎ</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for a in emp_atts %}
                  <tr>
                    <td>
                      <span class="badge bg-secondary">{{ a.attachment_type }}</span>
                      {% if a.attachment_type == 'PAYSLIP' %}
                        <span class="badge bg-light text-dark">{{ a.payslip_period_label }}</span>
                      {% endif %}
                    </td>
                    <td class="text-truncate" style="max-width:260px">{{ a.original_name }}</td>
                    <td class="text-truncate" style="max-width:220px">{{ a.note or "โ" }}</td>
                    <td class="text-muted">{% if a.uploaded_at %}{{ a.uploaded_at.strftime('%Y-%m-%d') }}{% else %}โ{% endif %}</td>
                    <td class="text-end">
                      <a class="btn btn-sm btn-outline-primary" href="{{ url_for('users.user_attachment_download', user_id=current_user.id, att_id=a.id) }}">
                        ุชูุฒูู
                      </a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="text-muted" style="font-size:0.9rem">* ุฑูุน/ุญุฐู ุงููุซุงุฆู ูุชู ูู ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ.</div>
        {% else %}
          <div class="text-muted">ูุง ุชูุฌุฏ ูุซุงุฆู ูุฑููุนุฉ.</div>
        {% endif %}

      </div>
    </div>

  </div>
</div>

{% endblock %}
