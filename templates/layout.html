<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Workflow System{% endblock %}</title>

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@500;600;700&family=Tajawal:wght@500;600;700&display=swap" rel="stylesheet">



    <!-- Global CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">

    {% block extra_css %}{% endblock %}
</head>
<body>

<!-- Header -->
<header class="main-header">
    <div class="container d-flex align-items-center justify-content-between">

        <h2 class="logo">Ø§Ù„Ù„Ø¬Ù†Ø© Ø§Ù„ÙˆØ·Ù†ÙŠØ© Ø§Ù„ÙÙ„Ø³Ø·ÙŠÙ†ÙŠØ©</h2>

        <nav class="main-nav d-flex align-items-center gap-3">

            <a href="{{ url_for('my_requests') }}"
               class="{% if request.path.startswith('/my-requests') %}active{% endif %}">
                ğŸ“‚ Ø·Ù„Ø¨Ø§ØªÙŠ
            </a>

            <a href="{{ url_for('create_request') }}"
               class="{% if request.path.startswith('/request/new') %}active{% endif %}">
                â• Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
            </a>

            <a href="{{ url_for('inbox') }}"
               class="{% if request.path.startswith('/inbox') %}active{% endif %}">
                ğŸ“¥ Inbox
            </a>

            {% if current_user.is_authenticated and current_user.has_role("ADMIN") %}
                <a href="{{ url_for('admin.dashboard') }}"
                   class="{% if request.path.startswith('/admin/dashboard') %}active{% endif %}">
                    ğŸ› ï¸ Admin
                </a>
            {% endif %}

            <!-- Notifications -->
            {% if current_user.is_authenticated %}
            <a class="nav-link position-relative"
               href="{{ url_for('workflow.notifications') }}">
                ğŸ””
                <span id="notif-badge"
                      class="badge bg-danger position-absolute top-0 start-100 translate-middle"
                      style="display:{% if current_user.unread_notifications_count > 0 %}inline-block{% else %}none{% endif %};">
                    {{ current_user.unread_notifications_count }}
                </span>
            </a>
            {% endif %}

            <a href="{{ url_for('logout') }}">Logout</a>

        </nav>
    </div>
</header>

<!-- Main Layout -->
<main class="container admin-wrapper">

    {% if current_user.is_authenticated and current_user.has_role("ADMIN") %}
    <!-- Sidebar -->
    <aside class="admin-sidebar">
        <h4 class="sidebar-title">
    <i class="bi bi-gear"></i>
    <span class="menu-text">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
</h4>


        <a href="{{ url_for('admin.dashboard') }}"
           class="{% if request.path.startswith('/admin/dashboard') %}active{% endif %}">
            ğŸ§­ Dashboard
        </a>

        <a href="{{ url_for('admin.admin_requests') }}"
           class="{% if request.path.startswith('/admin/requests') %}active{% endif %}">
            ğŸ“‚ All Requests
        </a>

        <a href="{{ url_for('admin.escalations') }}"
           class="{% if request.path.startswith('/admin/escalations') %}active{% endif %}">
            ğŸš¨ Escalations
            {% if escalation_alerts_count|default(0) > 0 %}
                <span class="badge bg-danger ms-2">
                    {{ escalation_alerts_count }}
                </span>
            {% endif %}
        </a>

        <a href="{{ url_for('workflow.notifications_dashboard') }}">
            ğŸ”” Notifications
        </a>

        <a href="{{ url_for('archive.upload_file') }}">
            ğŸ—‚ï¸ Archive
        </a>

        <a href="{{ url_for('users.list_users') }}"
           class="{% if request.path.startswith('/users') %}active{% endif %}">
            ğŸ‘¤ Users
        </a>

        <a href="{{ url_for('audit.audit_dashboard') }}">
            ğŸ“Š Audit
        </a>

        <a href="{{ url_for('audit.system_timeline') }}">
            ğŸ§­ Timeline
        </a>
    </aside>
    {% endif %}

    <!-- Content -->
    <section class="admin-content">

        {% if breadcrumb %}
            <nav class="breadcrumb mb-3">
                {% for item in breadcrumb %}
                    {% if not loop.last %}
                        <a href="{{ item.url }}">{{ item.label }}</a>
                        <span class="sep">â€º</span>
                    {% else %}
                        <span class="current">{{ item.label }}</span>
                    {% endif %}
                {% endfor %}
            </nav>
        {% endif %}

        {% block content %}{% endblock %}
    </section>

</main>

<!-- Footer -->
<footer class="main-footer">
    <div class="container text-center">
        <small>Â© Ø§Ù„Ù„Ø¬Ù†Ø© Ø§Ù„ÙˆØ·Ù†ÙŠØ© Ø§Ù„ÙÙ„Ø³Ø·ÙŠÙ†ÙŠØ©</small>
    </div>
</footer>

<!-- Notifications polling (SSE) -->
{% if current_user.is_authenticated %}
<script>
const source = new EventSource("{{ url_for('workflow.notifications_stream') }}");

source.onmessage = function (event) {
    const badge = document.getElementById("notif-badge");
    if (!badge) return;

    const count = parseInt(event.data);

    if (count > 0) {
        badge.innerText = count;
        badge.style.display = "inline-block";
    } else {
        badge.style.display = "none";
    }
};
</script>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>

</body>
</html>
