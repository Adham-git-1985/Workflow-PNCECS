<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Workflow System{% endblock %}</title>

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Global CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">

    {% block extra_css %}{% endblock %}
</head>
<body>

<!-- Header -->
<header class="main-header">
    <div class="container">
        <h2 class="logo">Ø§Ù„Ù„Ø¬Ù†Ø© Ø§Ù„ÙˆØ·Ù†ÙŠØ© Ø§Ù„ÙÙ„Ø³Ø·ÙŠÙ†ÙŠØ©</h2>

        <nav class="main-nav">

            <a href="{{ url_for('inbox') }}"
               class="{% if request.path.startswith('/inbox') %}active{% endif %}">
                Inbox
            </a>

            <a href="{{ url_for('my_requests') }}"
               class="{% if request.path.startswith('/my-requests') %}active{% endif %}">
                ğŸ“‚ Ø·Ù„Ø¨Ø§ØªÙŠ
            </a>

            {% if current_user.is_authenticated and current_user.has_role("ADMIN") %}
                <a href="{{ url_for('audit.audit_dashboard') }}"
                   class="{% if request.path.startswith('/audit') %}active{% endif %}">
                    ğŸ“Š Audit
                </a>

                <a href="{{ url_for('users.list_users') }}"
                   class="{% if request.path.startswith('/users') %}active{% endif %}">
                    ğŸ‘¤ Users
                </a>
            {% endif %}

            <!-- Notifications -->
            {% if current_user.is_authenticated %}
            <a class="nav-link position-relative"
               href="{{ url_for('workflow.notifications') }}">
                ğŸ””
                {% if current_user.unread_notifications_count > 0 %}
                    <span id="notif-badge"
                          class="badge bg-danger position-absolute top-0 start-100 translate-middle">
                        {{ current_user.unread_notifications_count }}
                    </span>
                {% endif %}
            </a>
            {% endif %}

            <a href="{{ url_for('logout') }}">Logout</a>

        </nav>
    </div>
</header>

<!-- Main Layout -->
<main class="container admin-wrapper">

    {% if current_user.is_authenticated and current_user.has_role("ADMIN") %}
    <!-- Sidebar -->
    <aside class="admin-sidebar">
        <h4 class="sidebar-title">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h4>

        <a href="{{ url_for('audit.audit_dashboard') }}"
           class="{% if request.path.startswith('/audit/dashboard') %}active{% endif %}">
            ğŸ“Š Audit Dashboard
        </a>

        <a href="{{ url_for('audit.list_audit_logs') }}"
           class="{% if request.path.startswith('/audit/logs') %}active{% endif %}">
            ğŸ“‘ Audit Logs
        </a>

        <a href="{{ url_for('users.list_users') }}"
           class="{% if request.path.startswith('/users') %}active{% endif %}">
            ğŸ‘¤ Users
        </a>

        <a href="#"
           class="{% if request.path.startswith('/reports') %}active{% endif %}">
            ğŸ“ Reports
        </a>

        <a href="{{ url_for('workflow.notifications_dashboard') }}">
            ğŸ”” Notifications Dashboard
        </a>

        <a href="{{ url_for('audit.system_timeline') }}">
            ğŸ§­ Activity Timeline
        </a>

        <a href="{{ url_for('archive.upload_file') }}">
            ğŸ—‚ï¸ Archive
        </a>

        <!-- Escalations -->
        <a href="{{ url_for('admin.escalations') }}"
           class="{% if request.path.startswith('/admin/escalations') %}active{% endif %}">
            ğŸš¨ Escalations
            {% if escalation_alerts_count|default(0) > 0 %}
                <span class="badge bg-danger ms-2">
                    {{ escalation_alerts_count }}
                </span>
            {% endif %}
        </a>

    </aside>
    {% endif %}

    <!-- Content -->
    <section class="admin-content">

        {% if breadcrumb %}
            <nav class="breadcrumb">
                {% for item in breadcrumb %}
                    {% if not loop.last %}
                        <a href="{{ item.url }}">{{ item.label }}</a>
                        <span class="sep">â€º</span>
                    {% else %}
                        <span class="current">{{ item.label }}</span>
                    {% endif %}
                {% endfor %}
            </nav>
        {% endif %}

        {% block content %}{% endblock %}
    </section>

</main>

<!-- Footer -->
<footer class="main-footer">
    <div class="container">
        <small>Â© Ø§Ù„Ù„Ø¬Ù†Ø© Ø§Ù„ÙˆØ·Ù†ÙŠØ© Ø§Ù„ÙÙ„Ø³Ø·ÙŠÙ†ÙŠØ©</small>
    </div>
</footer>

<!-- Notifications polling (SSE) -->
{% if current_user.is_authenticated %}
<script>
const source = new EventSource("{{ url_for('workflow.notifications_stream') }}");

source.onmessage = function (event) {
    const badge = document.getElementById("notif-badge");
    if (!badge) return;

    const count = parseInt(event.data);

    if (count > 0) {
        badge.innerText = count;
        badge.style.display = "inline-block";
    } else {
        badge.style.display = "none";
    }
};
</script>
{% endif %}

</body>
</html>
