{% extends "layout.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h3 class="mb-1">ğŸ—‘ï¸ Snapshot Ù„Ø·Ù„Ø¨ Ù…Ø­Ø°ÙˆÙ</h3>
    <small class="text-muted">Request #{{ request_id }}</small>
  </div>
  <div>
    <a class="btn btn-outline-secondary" href="{{ url_for('audit.system_timeline') }}">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù€ Timeline</a>
  </div>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    {% if snapshot %}
      <div class="row g-3">
        <div class="col-md-6">
          <div class="text-muted small">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</div>
          <div class="fw-semibold">{{ snapshot.title or "-" }}</div>
        </div>
        <div class="col-md-3">
          <div class="text-muted small">Ø§Ù„Ø­Ø§Ù„Ø©</div>
          <div class="fw-semibold">{{ snapshot.status or "-" }}</div>
        </div>
        <div class="col-md-3">
          <div class="text-muted small">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</div>
          <div class="fw-semibold">{{ snapshot.created_at or "-" }}</div>
        </div>

        <div class="col-md-6">
          <div class="text-muted small">Ù…Ù‚Ø¯Ù… Ø§Ù„Ø·Ù„Ø¨</div>
          <div class="fw-semibold">
            {{ (snapshot.requester.name if snapshot.requester else "") or "-" }}
            {% if snapshot.requester and snapshot.requester.email %}<span class="text-muted">({{ snapshot.requester.email }})</span>{% endif %}
          </div>
        </div>

        <div class="col-md-6">
          <div class="text-muted small">Ø§Ù„Ù…Ø³Ø§Ø± / Ø§Ù„Ù‚Ø§Ù„Ø¨</div>
          <div class="fw-semibold">{{ (snapshot.instance.template_name if snapshot.instance else "") or "-" }}</div>
        </div>

        <div class="col-12">
          <div class="text-muted small">Ø§Ù„ÙˆØµÙ</div>
          <div style="white-space:pre-wrap; line-height:1.7">{{ snapshot.description or "-" }}</div>
        </div>
      </div>

      <hr class="my-3"/>

      {% if snapshot.steps %}
        <h6 class="mb-2">Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªÙ†ÙÙŠØ° (Ø¢Ø®Ø± Ø­Ø§Ù„Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø°Ù)</h6>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Mode</th>
                <th>Approver Kind</th>
                <th>Status</th>
                <th>Decided By</th>
                <th>Decided At</th>
              </tr>
            </thead>
            <tbody>
              {% for st in snapshot.steps %}
              <tr>
                <td>{{ st.step_order }}</td>
                <td>
                  {% if st.mode == "PARALLEL_SYNC" %}
                    <span class="badge text-bg-info">Ù…ØªØ²Ø§Ù…Ù†</span>
                  {% else %}
                    <span class="badge text-bg-secondary">ØªØ³Ù„Ø³Ù„ÙŠ</span>
                  {% endif %}
                </td>
                <td>{{ st.approver_kind }}</td>
                <td>{{ st.status }}</td>
                <td>{{ st.decided_by_email or "-" }}</td>
                <td>{{ st.decided_at or "-" }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    {% else %}
      <div class="alert alert-warning mb-0">
        Ù„Ø§ ÙŠÙˆØ¬Ø¯ Snapshot Ù…Ø­ÙÙˆØ¸ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨. (Ø±Ø¨Ù…Ø§ ØªÙ… Ø­Ø°ÙÙ‡ Ù‚Ø¨Ù„ ØªÙØ¹ÙŠÙ„ Ø­ÙØ¸ Ø§Ù„Ù€ Snapshot).
      </div>
      {% if del_log and del_log.note %}
        <details class="mt-2">
          <summary class="text-muted small">Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø°Ù</summary>
          <pre class="mt-2 mb-0" style="white-space:pre-wrap; line-height:1.7">{{ del_log.note }}</pre>
        </details>
      {% endif %}
    {% endif %}
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <h6 class="mb-2">Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨</h6>
    {% if logs %}
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th>Ø§Ù„ÙˆÙ‚Øª</th>
              <th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
              <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
              <th>ØªÙØ§ØµÙŠÙ„</th>
            </tr>
          </thead>
          <tbody>
            {% for l in logs %}
            <tr>
              <td class="text-muted small">{{ l.created_at }}</td>
              <td><span class="badge text-bg-light">{{ l.action }}</span></td>
              <td>{{ l.user.name if l.user else "-" }}</td>
              <td class="small text-muted">
                {% if l.note %}
                  <details>
                    <summary>Ø¹Ø±Ø¶</summary>
                    <pre class="mt-2 mb-0" style="white-space:pre-wrap; line-height:1.7">{{ l.note }}</pre>
                  </details>
                {% else %}â€”{% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted small">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª.</div>
    {% endif %}
  </div>
</div>
{% endblock %}
