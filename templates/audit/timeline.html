{% extends "layout.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h3 class="mb-1">ğŸ§­ System Activity Timeline</h3>
    <small class="text-muted">Ø¹Ø±Ø¶ Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù…Ø¹ ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØªØµÙØ­åˆ†é¡µØ§Øª</small>
  </div>
  <div>
    <a class="btn btn-outline-success"
       href="{{ url_for('audit.system_timeline_export_excel', action=filters.action, user_id=filters.user_id, date_from=filters.date_from, date_to=filters.date_to, days=filters.days, request_type_id=filters.request_type_id, template_id=filters.template_id, step_order=filters.step_order) }}">
      <i class="bi bi-file-earmark-excel"></i>
      ØªØµØ¯ÙŠØ± Excel
    </a>
  </div>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-md-2">
        <label class="form-label small text-muted">Ø¢Ø®Ø±</label>
        <select name="days" class="form-select">
          <option value="" {% if not filters.days %}selected{% endif %}>â€”</option>
          <option value="1" {% if filters.days == 1 %}selected{% endif %}>24 Ø³Ø§Ø¹Ø©</option>
          <option value="7" {% if filters.days == 7 %}selected{% endif %}>7 Ø£ÙŠØ§Ù…</option>
          <option value="30" {% if filters.days == 30 %}selected{% endif %}>30 ÙŠÙˆÙ…</option>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label small text-muted">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
        <input type="date" name="date_from" value="{{ filters.date_from }}" class="form-control">
      </div>

      <div class="col-md-2">
        <label class="form-label small text-muted">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
        <input type="date" name="date_to" value="{{ filters.date_to }}" class="form-control">
      </div>

      <div class="col-md-2">
        <label class="form-label small text-muted">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
        <select name="user_id" class="form-select">
          <option value="">Ø§Ù„ÙƒÙ„</option>
          {% for u in users %}
            <option value="{{ u.id }}" {% if filters.user_id == u.id %}selected{% endif %}>{{ u.email }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label small text-muted">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</label>
        <select name="action" class="form-select">
          <option value="">Ø§Ù„ÙƒÙ„</option>
          {% for a in actions %}
            <option value="{{ a }}" {% if filters.action == a %}selected{% endif %}>{{ a }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label small text-muted">Ø§Ù„Ø·Ù„Ø¨</label>
        <select name="request_type_id" class="form-select">
          <option value="">Ø§Ù„ÙƒÙ„</option>
          {% for rt in request_types %}
            <option value="{{ rt.id }}" {% if filters.request_type_id == rt.id %}selected{% endif %}>{{ rt.name_ar }} ({{ rt.code }})</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label small text-muted">Ø§Ù„Ù…Ø³Ø§Ø±</label>
        <select name="template_id" class="form-select">
          <option value="">Ø§Ù„ÙƒÙ„</option>
          {% for tplt in templates %}
            <option value="{{ tplt.id }}" {% if filters.template_id == tplt.id %}selected{% endif %}>{{ tplt.name }} (#{{ tplt.id }})</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-1">
        <label class="form-label small text-muted">Ø§Ù„Ø®Ø·ÙˆØ©</label>
        <input type="number" name="step_order" min="1" value="{{ filters.step_order }}" class="form-control" placeholder="1">
      </div>

      <div class="col-md-1">
        <label class="form-label small text-muted">/ØµÙØ­Ø©</label>
        <select name="per_page" class="form-select">
          {% for n in [50,120,200,500] %}
            <option value="{{ n }}" {% if filters.per_page == n %}selected{% endif %}>{{ n }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-1 d-grid">
        <button class="btn btn-primary" type="submit">ØªØ·Ø¨ÙŠÙ‚</button>
      </div>
    </form>

    {% if day_counts %}
      <hr>
      <div class="d-flex flex-wrap gap-2">
        {% for day, cnt in day_counts %}
          <a class="badge bg-light text-dark border text-decoration-none"
             href="{{ url_for('audit.system_timeline', date_from=day, date_to=day, user_id=filters.user_id, action=filters.action, request_type_id=filters.request_type_id, template_id=filters.template_id, step_order=filters.step_order, per_page=filters.per_page) }}">
            {{ day }} â€¢ {{ cnt }}
          </a>
        {% endfor %}
      </div>
      <div class="text-muted small mt-2">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ ÙŠÙˆÙ… Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„Ù‡ ÙÙ‚Ø·.</div>
    {% endif %}
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">

    {% if logs %}
      {% set ns = namespace(day=None) %}
      <div class="list-group">
        {% for log in logs %}
          {% set d = log.created_at.strftime('%Y-%m-%d') %}
          {% if ns.day != d %}
            {% set ns.day = d %}
            <div class="list-group-item bg-light">
              <strong>ğŸ“… {{ d }}</strong>
            </div>
          {% endif %}

          <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
              <div class="d-flex align-items-center gap-2 flex-wrap">
                <span class="badge bg-primary">{{ log.action }}</span>
                {% set st = (log_steps|default({})).get(log.id|int) %}
                {% if st is not none %}
                  <span class="badge bg-info text-dark">Ø§Ù„Ø®Ø·ÙˆØ© {{ st }}</span>
                {% endif %}
                <span class="text-muted small">{{ log.created_at.strftime('%H:%M:%S') }}</span>
                <span class="text-muted small">â€¢</span>
                {% if log.user %}
                  <span class="small">ğŸ‘¤ <strong>{{ log.user.email }}</strong></span>
                {% else %}
                  <span class="small">ğŸ¤– <strong>System</strong></span>
                {% endif %}
              </div>

              {% if log.target_type and log.target_id %}
                <div class="small text-muted">
                  {% if log.target_type in ['WorkflowRequest','WORKFLOW_REQUEST'] %}
                    ğŸ“„
                    {% if log.target_id in existing_request_ids %}
                      <a href="{{ url_for('workflow.view_request', request_id=log.target_id) }}">Request #{{ log.target_id }}</a>
                    {% else %}
                      <a href="{{ url_for('audit.deleted_request_snapshot', request_id=log.target_id) }}">Request #{{ log.target_id }} (Ù…Ø­Ø°ÙˆÙ)</a>
                    {% endif %}
                  {% elif log.target_type in ['ArchivedFile','ARCHIVE_FILE'] %}
                    ğŸ—‚ï¸ <a href="{{ url_for('archive.file_details', file_id=log.target_id) }}">Archived File #{{ log.target_id }}</a>
                  {% elif log.target_type == 'User' %}
                    ğŸ‘¤ User #{{ log.target_id }}
                  {% elif log.target_type == 'Message' %}
                    âœ‰ï¸ Message #{{ log.target_id }}
                  {% else %}
                    {{ log.target_type }} #{{ log.target_id }}
                  {% endif %}
                </div>
              {% endif %}
            </div>

            {% set rid = log.request_id or (log.target_id if (log.target_type in ['WorkflowRequest','WORKFLOW_REQUEST'] and log.target_id) else None) %}
            {% if rid and request_meta.get(rid|int) %}
              {% set m = request_meta.get(rid|int) %}
              <div class="mt-1 small">
                <span class="text-muted">Ø§Ù„Ø·Ù„Ø¨:</span>
                <span class="badge bg-secondary">{{ m.request_type }}</span>
                <span class="text-muted ms-2">Ø§Ù„Ù…Ø³Ø§Ø±:</span>
                <span class="badge bg-dark">{{ m.template_name }} (#{{ m.template_id }})</span>
                {% set tm = (request_times|default({})).get(rid|int) %}
                {% if tm and (tm.get('started_at') or tm.get('completed_at')) %}
                  <span class="text-muted ms-2">â€¢</span>
                  {% if tm.get('started_at') %}<span class="text-muted">Ø¥Ø±Ø³Ø§Ù„:</span> <span>{{ tm.get('started_at').strftime('%Y-%m-%d %H:%M') }}</span>{% endif %}
                  {% if tm.get('completed_at') %}<span class="text-muted ms-2">Ø§Ù†ØªÙ‡Ø§Ø¡:</span> <span>{{ tm.get('completed_at').strftime('%Y-%m-%d %H:%M') }}</span>{% endif %}
                {% endif %}
              </div>
            {% endif %}

            <div class="mt-2">
              {% if log.note %}
                <details>
                  <summary class="text-muted small">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</summary>
                  <pre class="mt-2 mb-0" style="white-space:pre-wrap; line-height:1.7">{{ log.note }}</pre>
                </details>
              {% else %}
                <div class="text-muted">â€”</div>
              {% endif %}
            </div>

            {% set rid = log.request_id or (log.target_id if (log.target_type in ['WorkflowRequest','WORKFLOW_REQUEST'] and log.target_id) else None) %}
            {% if rid and request_meta.get(rid|int) %}
              {% set m = request_meta.get(rid|int) %}
              <div class="mt-1 small">
                <span class="text-muted">Ø§Ù„Ø·Ù„Ø¨:</span>
                <span class="badge bg-secondary">{{ m.request_type }}</span>
                <span class="text-muted ms-2">Ø§Ù„Ù…Ø³Ø§Ø±:</span>
                <span class="badge bg-dark">{{ m.template_name }} (#{{ m.template_id }})</span>
                {% set tm = (request_times|default({})).get(rid|int) %}
                {% if tm and (tm.get('started_at') or tm.get('completed_at')) %}
                  <span class="text-muted ms-2">â€¢</span>
                  {% if tm.get('started_at') %}<span class="text-muted">Ø¥Ø±Ø³Ø§Ù„:</span> <span>{{ tm.get('started_at').strftime('%Y-%m-%d %H:%M') }}</span>{% endif %}
                  {% if tm.get('completed_at') %}<span class="text-muted ms-2">Ø§Ù†ØªÙ‡Ø§Ø¡:</span> <span>{{ tm.get('completed_at').strftime('%Y-%m-%d %H:%M') }}</span>{% endif %}
                {% endif %}
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>

      {% if pagination.pages > 1 %}
        <nav class="mt-3">
          <ul class="pagination justify-content-center mb-0">
            {% if pagination.has_prev %}
              <li class="page-item">
                <a class="page-link" href="{{ url_for('audit.system_timeline', page=pagination.prev_num, user_id=filters.user_id, action=filters.action, request_type_id=filters.request_type_id, template_id=filters.template_id, step_order=filters.step_order, date_from=filters.date_from, date_to=filters.date_to, days=filters.days, per_page=filters.per_page) }}">Ø§Ù„Ø³Ø§Ø¨Ù‚</a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Ø§Ù„Ø³Ø§Ø¨Ù‚</span></li>
            {% endif %}

            <li class="page-item disabled"><span class="page-link">{{ pagination.page }} / {{ pagination.pages }}</span></li>

            {% if pagination.has_next %}
              <li class="page-item">
                <a class="page-link" href="{{ url_for('audit.system_timeline', page=pagination.next_num, user_id=filters.user_id, action=filters.action, request_type_id=filters.request_type_id, template_id=filters.template_id, step_order=filters.step_order, date_from=filters.date_from, date_to=filters.date_to, days=filters.days, per_page=filters.per_page) }}">Ø§Ù„ØªØ§Ù„ÙŠ</a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Ø§Ù„ØªØ§Ù„ÙŠ</span></li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}

    {% else %}
      <div class="text-center text-muted py-4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ù…Ø³Ø¬Ù‘Ù„ Ø¶Ù…Ù† Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</div>
    {% endif %}

  </div>
</div>

{% endblock %}
