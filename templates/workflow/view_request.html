{# templates/workflow/view_request.html #}
{% extends "layout.html" %}
{% block title %}Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨{% endblock %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h3 class="mb-1">ğŸ“„ Ø§Ù„Ø·Ù„Ø¨ #{{ req.id }}</h3>
    <small class="text-muted">
      Ø§Ù„Ø­Ø§Ù„Ø©: <strong>{{ req.status }}</strong>
      {% if inst %} Â· Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <strong>{{ inst.current_step_order }}</strong>{% endif %}
      {% if template %} Â· Ø§Ù„Ù…Ø³Ø§Ø±: <strong>{{ template.name }} (#{{ template.id }})</strong>{% endif %}
    </small>
  </div>

  <div class="d-flex gap-2">
    <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('workflow.request_pdf', request_id=req.id) }}">
      PDF
    </a>

    {% if current_user.has_role('SUPER_ADMIN') %}
    <form method="post"
          action="{{ url_for('workflow.delete_request', request_id=req.id) }}"
          onsubmit="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø°Ù„Ùƒ ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚.');">
      <button type="submit" class="btn btn-sm btn-danger">
        ğŸ—‘ï¸ Ø­Ø°Ù
      </button>
    </form>
    {% endif %}
    {% if can_escalate %}
    <a class="btn btn-sm btn-outline-danger" href="{{ url_for('workflow.escalate_request', request_id=req.id) }}">
      ğŸš¨ ØªØµØ¹ÙŠØ¯
    </a>
    {% endif %}
  </div>
</div>

<div class="row g-3">

  <div class="col-lg-7">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
      {% if current_step.mode == "PARALLEL_SYNC" %}
      <div class="alert alert-info py-2 mb-3">
        Ù‡Ø°Ù‡ Ø®Ø·ÙˆØ© <strong>Ù…ØªØ²Ø§Ù…Ù†Ø©</strong>Ø› Ø±Ø¯Ù‘Ùƒ Ù‡Ù†Ø§ Ù„Ù„ØªÙˆØ«ÙŠÙ‚ ÙˆÙ„Ù† ÙŠØºÙŠÙ‘Ø± Ù…Ø³Ø§Ø± Ø§Ù„Ù‚Ø±Ø§Ø±.
      </div>
      {% endif %}
        <h5 class="mb-2">{{ req.title }}</h5>
        <div class="text-muted">{{ req.description or "â€”" }}</div>
      </div>
    </div>

    <div class="card shadow-sm mb-3">
      <div class="card-header bg-white">
        <strong>ğŸ“ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</strong>
      </div>
      <div class="card-body">
        {% if attachments %}
          <ul class="list-group">
            {% for a in attachments %}
              {% set f = files_map.get(a.archived_file_id) %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <strong>{{ f.original_name if f else ("File #" ~ a.archived_file_id) }}</strong>
                  {% if f %}
                    <div class="small text-muted">
                      {{ f.file_type }} Â· {{ (f.file_size or 0)//1024 }} KB
                    </div>
                  {% endif %}
                </div>
                {% if f %}
                  <div class="d-flex gap-2">
                    <a class="btn btn-sm btn-outline-primary"
                       href="{{ url_for('workflow.download_workflow_attachment', file_id=f.id) }}">
                      ØªÙ†Ø²ÙŠÙ„
                    </a>
                    <a class="btn btn-sm btn-outline-secondary"
                       href="{{ url_for('workflow.preview_workflow_attachment', file_id=f.id) }}">
                      Ù…Ø¹Ø§ÙŠÙ†Ø©
                    </a>
                  </div>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª.</div>
        {% endif %}
      </div>
    </div>

    <div class="card shadow-sm mb-3">
  <div class="card-header bg-white">
    <strong>ğŸš¨ Ø§Ù„ØªØµØ¹ÙŠØ¯Ø§Øª</strong>
        <a class="btn btn-sm btn-outline-danger" target="_blank" href="{{ url_for('workflow.request_escalations', request_id=req.id) }}">Ø¹Ø±Ø¶</a>
  </div>
  <div class="card-body">
    {% if req.escalations %}
      <ul class="list-group">
        {% for e in req.escalations|sort(attribute='created_at', reverse=True) %}
          <li class="list-group-item">
            <div class="d-flex justify-content-between">
              <strong>{{ e.category|esc_category_ar }}</strong>
              {% if e.step_order %}<span class="badge bg-danger ms-2">Step {{ e.step_order }}</span>{% endif %}
              <span class="small text-muted">{{ e.created_at.strftime("%Y-%m-%d %H:%M") }}</span>
            </div>
            <div class="small text-muted mt-1">
              Ù…Ù†: {{ e.from_user.email if e.from_user else ('#' ~ e.from_user_id) }}
              â†’ Ø¥Ù„Ù‰: {% if e.targets %}{% set tids = e.targets.split(',') %}{% for tid in tids %}{% set tid2 = tid|trim %}{% if tid2 %}{% set tu = users_map.get(tid2|int) %}{{ tu.email if tu else ('#' ~ tid2) }}{% if not loop.last %}, {% endif %}{% endif %}{% endfor %}{% else %}{{ e.to_user.email if e.to_user else ('#' ~ e.to_user_id) }}{% endif %}
            </div>
            <div class="mt-2">{{ e.description }}</div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØµØ¹ÙŠØ¯Ø§Øª.</div>
    {% endif %}
  </div>
</div>

    <div class="card shadow-sm">
      <div class="card-header bg-white">
        <strong>ğŸ§¾ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª (Audit)</strong>
      </div>
      <div class="card-body">
        {% if audit %}
          <ul class="list-group">
            {% for log in audit %}
              <li class="list-group-item">
                <div class="d-flex justify-content-between">
                  <div>
                    <strong>{{ log.action }}</strong>
                    <div class="small text-muted mt-1">
                      {% if log.user %}
                        Ø¨ÙˆØ§Ø³Ø·Ø©: <strong>{{ log.user.full_name }}</strong>
                      {% else %}
                        Ø¨ÙˆØ§Ø³Ø·Ø©: <strong>Ø§Ù„Ù†Ø¸Ø§Ù…</strong>
                      {% endif %}
                      {% if log.on_behalf_of_user %}
                        <span class="badge bg-info text-dark ms-2">Ù…ÙÙˆÙ‘Ø¶ Ø¹Ù† {{ log.on_behalf_of_user.full_name }}</span>
                      {% endif %}
                    </div>
                  </div>
                  <span class="small text-muted">{{ log.created_at.strftime("%Y-%m-%d %H:%M") }}</span>
                </div>
                {% if log.note %}
                  <div class="small text-muted mt-1">{{ log.note }}</div>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø¨Ø¹Ø¯.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-5">
    <div class="card shadow-sm mb-3">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-2">
          <strong>ğŸ§© Ø§Ù„Ù…Ø³Ø§Ø±</strong>
          {% if workflow_total_sla_days is not none %}
            <a href="#" class="badge bg-light text-dark border text-decoration-none"
               data-bs-toggle="modal" data-bs-target="#slaInfoModal"
               data-sla-label="SLA Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ù…Ø³Ø§Ø±" data-sla-value="{{ workflow_total_sla_days }}">
              SLA Ø§Ù„ÙƒÙ„ÙŠ: {{ workflow_total_sla_days }} ÙŠÙˆÙ…
            </a>
          {% endif %}
        </div>
        <div class="d-flex align-items-center gap-2">
          {% if current_user.has_role('SUPER_ADMIN') or current_user.has_role('SUPERADMIN') %}
            <form method="post" action="{{ url_for('workflow.recalculate_request_sla', request_id=req.id) }}" class="m-0">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token is defined else '' }}">
              <button type="submit" class="btn btn-sm btn-outline-danger"
                      onclick="return confirm('Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ (due_at) Ù„Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ù…Ù† Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙØµØ§Ø¹Ø¯Ù‹Ø§. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ');">
                â±ï¸ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø­ØªØ³Ø§Ø¨ SLA
              </button>
            </form>
          {% endif %}
          <a class="btn btn-sm btn-outline-secondary" target="_blank" href="{{ url_for('workflow.request_attachments', request_id=req.id) }}">ğŸ“ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø±{% if attachments %} ({{ attachments|length }}){% endif %}</a>
        </div>
      </div>
      <div class="card-body">
        {% if steps %}

          {# ===== Pre attachments (step 0) ===== #}
          {% if pre_att_items %}
            <div class="mb-3">
              <div class="small fw-bold text-muted mb-1">ğŸ“Œ Ù…Ø±ÙÙ‚Ø§Øª Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ / Ø§Ù„Ø¥Ø±ÙØ§Ù‚</div>
              <ul class="list-unstyled small mb-0">
                {% for it in pre_att_items %}
                  <li class="mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                      <div class="text-truncate">
                        <i class="bi bi-paperclip"></i>
                        <a class="text-decoration-none" target="_blank" href="{{ url_for('workflow.preview_workflow_attachment', file_id=it.file_id) }}">{{ it.name }}</a>
                        <span class="text-muted">Â· {{ it.size_human }}</span>
                      </div>
                      <div class="text-nowrap ms-2">
                        <a class="btn btn-sm btn-outline-secondary py-0 px-2" target="_blank" href="{{ url_for('workflow.preview_workflow_attachment', file_id=it.file_id) }}">Ø¹Ø±Ø¶</a>
                        <a class="btn btn-sm btn-outline-primary py-0 px-2" href="{{ url_for('workflow.download_workflow_attachment', file_id=it.file_id) }}">ØªÙ†Ø²ÙŠÙ„</a>
                      </div>
                    </div>
                    <div class="text-muted" style="font-size:12px">
                      {{ it.source_label }}{% if it.uploaded_by %} Â· {{ it.uploaded_by }}{% endif %}{% if it.uploaded_at %} Â· {{ it.uploaded_at }}{% endif %}
                    </div>
                  </li>
                {% endfor %}
              </ul>
            </div>
            <hr class="my-2">
          {% endif %}

          <ol class="mb-0">
            {% for s in steps %}
              <li class="mb-2">
                <div class="d-flex justify-content-between">
                  <div>
                    <strong>Step {{ s.step_order }}</strong>
                    {% if (s.mode or '')|upper == 'PARALLEL_SYNC' %}
                      <span class="badge bg-info text-dark ms-2">Ù…ØªØ²Ø§Ù…Ù†</span>
                    {% endif %}
                    <div class="small text-muted">
  {% set k = (s.approver_kind or '')|upper %}
  Ø§Ù„ÙˆØ¬Ù‡Ø©:
  {% if k == "ROLE" %}
    <span class="badge bg-secondary">ROLE</span> {{ s.approver_role }}
  {% elif k == "USER" %}
    <span class="badge bg-secondary">USER</span>
    {% if s.approver_user_id and users_map.get(s.approver_user_id) %}
      {{ users_map.get(s.approver_user_id).email }}
    {% else %}
      #{{ s.approver_user_id }}
    {% endif %}
  {% elif k == "DIRECTORATE" %}
    <span class="badge bg-secondary">DIRECTORATE</span>
    {% if s.approver_directorate_id and dirs_map.get(s.approver_directorate_id) %}
      {{ dirs_map.get(s.approver_directorate_id).name_ar }}
    {% else %}
      #{{ s.approver_directorate_id }}
    {% endif %}
    â†’ <span class="text-muted">Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù… (directorate_head)</span>
  {% elif k == "COMMITTEE" %}
    <span class="badge bg-secondary">COMMITTEE</span>
    {% if s.approver_committee_id and committees_map and committees_map.get(s.approver_committee_id) %}
      {{ committees_map.get(s.approver_committee_id).name_ar }}
    {% else %}
      #{{ s.approver_committee_id }}
    {% endif %}
    {% set cmode = (s.committee_delivery_mode or "Committee_ALL") %}
    {% set cmode_up = cmode|upper %}
    {% if cmode_up == "COMMITTEE_CHAIR" or cmode == "Committee_CHAIR" %}
      â†’ <span class="text-muted">Ø±Ø¦ÙŠØ³ Ø§Ù„Ù„Ø¬Ù†Ø©</span>
    {% elif cmode_up == "COMMITTEE_SECRETARY" or cmode == "Committee_SECRETARY" %}
      â†’ <span class="text-muted">Ù…Ù‚Ø±Ø± Ø§Ù„Ù„Ø¬Ù†Ø©</span>
    {% else %}
      â†’ <span class="text-muted">ÙƒÙ„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</span>
    {% endif %}
  {% elif k == "DEPARTMENT" or ((s.approver_kind or '')|trim) == '' %}
    <span class="badge bg-secondary">DEPARTMENT</span>
    {% if s.approver_department_id and depts_map.get(s.approver_department_id) %}
      {{ depts_map.get(s.approver_department_id).name_ar }}
    {% else %}
      #{{ s.approver_department_id }}
    {% endif %}
    â†’ <span class="text-muted">Ø±Ø¦ÙŠØ³ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© (dept_head)</span>
  {% else %}
    <span class="badge bg-danger">UNKNOWN</span>
    <span class="ms-1">{{ s.approver_kind }}</span>
  {% endif %}
</div>
                  </div>
                  <span class="badge
                    {% if s.status == 'PENDING' %}bg-warning text-dark
                    {% elif s.status == 'APPROVED' %}bg-success
                    {% elif s.status == 'REJECTED' %}bg-danger
                    {% else %}bg-secondary{% endif %}">
                    {{ s.status }}
                  </span>
                </div>
                {% if s.due_at %}
                  {% set rem = (sla_days_remaining_map.get(s.step_order) if sla_days_remaining_map else None) %}
                  {% set sla_val = (step_sla_days_map.get(s.step_order) if step_sla_days_map else None) %}
                  {% if (sla_val is none) and template %}{% set sla_val = template.sla_days_default %}{% endif %}
                  {% if sla_val is none %}{% set sla_val = 3 %}{% endif %}
                  <div class="small text-muted">
                    <a href="#" class="text-decoration-none sla-link"
                       data-bs-toggle="modal" data-bs-target="#slaInfoModal"
                       data-sla-label="SLA Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ© (Ø§Ù„Ø®Ø·ÙˆØ© {{ s.step_order }})"
                       data-sla-value="{{ sla_val }}">
                      SLA Ø§Ù„Ø®Ø·ÙˆØ©: {{ sla_val }} ÙŠÙˆÙ… Â· Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚: {{ s.due_at.strftime("%Y-%m-%d %H:%M") }}{% if rem is not none %} (Ù…ØªØ¨Ù‚ÙŠ: {{ rem }} ÙŠÙˆÙ…){% endif %}
                    </a>
                  </div>
                {% endif %}

                {% set c = (step_att_counts.get(s.step_order, 0) if step_att_counts else 0) %}
                {% if c %}
                  <div class="small text-muted">ğŸ“ Ù…Ø±ÙÙ‚Ø§Øª Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ©: {{ c }}</div>
                {% endif %}

                {% set ec = (step_escalation_counts.get(s.step_order, 0) if step_escalation_counts else 0) %}
                {% if ec %}
                  <div class="small">
                    <a class="text-danger text-decoration-none" target="_blank" href="{{ url_for('workflow.request_escalations', request_id=req.id, step=s.step_order) }}">ğŸš¨ ØªØµØ¹ÙŠØ¯Ø§Øª Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ© ({{ ec }})</a>
                  </div>
                {% endif %}

                {# ===== Step attachments (detailed list) ===== #}
                {% set items = (step_att_items.get(s.step_order) if step_att_items else None) %}
                {% if items %}
                  <div class="mt-2">
                    <div class="small fw-bold text-muted mb-1">ğŸ“ Ù…Ù„ÙØ§Øª Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ©</div>
                    <ul class="list-unstyled small mb-0">
                      {% for it in items %}
                        <li class="mb-2">
                          <div class="d-flex justify-content-between align-items-center">
                            <div class="text-truncate">
                              <i class="bi bi-paperclip"></i>
                              <a class="text-decoration-none" target="_blank" href="{{ url_for('workflow.preview_workflow_attachment', file_id=it.file_id) }}">{{ it.name }}</a>
                              <span class="text-muted">Â· {{ it.size_human }}</span>
                            </div>
                            <div class="text-nowrap ms-2">
                              <a class="btn btn-sm btn-outline-secondary py-0 px-2" target="_blank" href="{{ url_for('workflow.preview_workflow_attachment', file_id=it.file_id) }}">Ø¹Ø±Ø¶</a>
                              <a class="btn btn-sm btn-outline-primary py-0 px-2" href="{{ url_for('workflow.download_workflow_attachment', file_id=it.file_id) }}">ØªÙ†Ø²ÙŠÙ„</a>
                            </div>
                          </div>
                          <div class="text-muted" style="font-size:12px">
                            {{ it.source_label }}{% if it.uploaded_by %} Â· {{ it.uploaded_by }}{% endif %}{% if it.uploaded_at %} Â· {{ it.uploaded_at }}{% endif %}
                          </div>
                        </li>
                      {% endfor %}
                    </ul>
                    <div class="mt-1">
                      <a class="small text-muted" target="_blank" href="{{ url_for('workflow.request_attachments', request_id=req.id) }}">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø¨Ø§Ù„ØªÙØ§ØµÙŠÙ„</a>
                    </div>
                  </div>
                {% endif %}
              </li>
            {% endfor %}
          </ol>
        {% else %}
          <div class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ø§Ø± Ù…Ù†Ø´Ø£ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨.</div>
        {% endif %}
      </div>
    </div>

    {# =========================
       PARALLEL_SYNC Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø© + Ø²Ø± Ø§Ù„ØªØ¬Ø§ÙˆØ²
       ========================= #}
    {% if current_step and (current_step.mode or '')|upper == 'PARALLEL_SYNC' %}
      <div class="card shadow-sm mb-3">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <div>
            <strong>ğŸ‘¥ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø© (Ø§Ù„Ø®Ø·ÙˆØ© {{ current_step.step_order }})</strong>
            <div class="small text-muted">Ø§Ù„Ø±Ø¯ÙˆØ¯ Ù„Ù„ØªÙˆØ«ÙŠÙ‚ ÙˆÙ„Ø§ ØªØºÙŠÙ‘Ø± Ù‚Ø±Ø§Ø± Ø§Ù„Ù…Ø³Ø§Ø±.</div>
          </div>
          <span class="badge bg-info text-dark">Ù…ØªØ²Ø§Ù…Ù†</span>
        </div>
        <div class="card-body">
          {% if parallel_tasks %}
            {# count progress #}
            {% set ns = namespace(done=0) %}
            {% for t in parallel_tasks %}
              {% if (t.status or '') in ['RESPONDED','BYPASSED'] %}
                {% set ns.done = ns.done + 1 %}
              {% endif %}
            {% endfor %}

            <div class="small text-muted mb-2">Ø§Ù„ØªÙ‚Ø¯Ù…: {{ ns.done }}/{{ parallel_tasks|length }} (Ù„Ù† Ù†Ù†ØªÙ‚Ù„ Ø­ØªÙ‰ ÙŠØ±Ø¯ Ø§Ù„Ø¬Ù…ÙŠØ¹ Ø£Ùˆ ÙŠØªÙ… ØªØ¬Ø§ÙˆØ²Ù‡Ù…)</div>

            {% if can_bypass_parallel %}
              <div class="alert alert-warning py-2 mb-3">
                <div class="d-flex flex-wrap align-items-end justify-content-between gap-2">
                  <div>
                    <div class="fw-bold">ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…ØªØ¨Ù‚ÙŠÙ† (ÙƒÙ„ Ù…Ù† Ø­Ø§Ù„ØªÙ‡ PENDING)</div>
                    <div class="small text-muted">Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ù…ØªØ§Ø­ Ù„Ù…Ù†ÙÙ‘Ø° Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø£Ùˆ Admin/Super Admin.</div>
                  </div>
                  <form method="post" class="d-flex gap-2" action="{{ url_for('workflow.bypass_parallel_assignee', request_id=req.id, step_order=current_step.step_order) }}">
                    <input type="hidden" name="bypass_all" value="1">
                    <input class="form-control form-control-sm" name="reason" placeholder="Ø³Ø¨Ø¨ Ø§Ù„ØªØ¬Ø§ÙˆØ²" required>
                    <button class="btn btn-sm btn-danger" type="submit">ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…ØªØ¨Ù‚ÙŠÙ†</button>
                  </form>
                </div>
              </div>
            {% endif %}

            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                    <th style="width:140px">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th style="width:110px">Ø§Ù„Ø±Ø¯</th>
                    <th style="width:150px">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th style="width:360px">Ø§Ù„ØªØ¬Ø§ÙˆØ²</th>
                  </tr>
                </thead>
                <tbody>
                  {% for t in parallel_tasks %}
                    <tr {% if my_parallel_task and t.id == my_parallel_task.id %}class="table-warning"{% endif %}>
                      <td>
                        {{ (t.assignee.full_name if t.assignee and t.assignee.full_name else None) or (t.assignee.email if t.assignee else ('#' ~ t.assignee_user_id)) }}
                        {% if my_parallel_task and t.id == my_parallel_task.id %}
                          <span class="badge bg-warning text-dark ms-1">Ø£Ù†Øª</span>
                        {% endif %}
                      </td>
                      <td>
                        {% set st = (t.status or '') %}
                        <span class="badge
                          {% if st == 'PENDING' %}bg-warning text-dark
                          {% elif st == 'RESPONDED' %}bg-success
                          {% elif st == 'BYPASSED' %}bg-secondary
                          {% else %}bg-secondary{% endif %}">
                          {{ st or '-' }}
                        </span>
                      </td>
                      <td>
                        {% if (t.response or '') == 'APPROVED' %}
                          <span class="badge bg-success">Ù…ÙˆØ§ÙÙ‚Ø©</span>
                        {% elif (t.response or '') == 'REJECTED' %}
                          <span class="badge bg-danger">Ø±ÙØ¶</span>
                        {% else %}
                          -
                        {% endif %}
                      </td>
                      <td class="small text-muted">
                        {% if t.responded_at %}
                          {{ t.responded_at.strftime('%Y-%m-%d %H:%M') }}
                        {% elif t.bypassed_at %}
                          {{ t.bypassed_at.strftime('%Y-%m-%d %H:%M') }}
                        {% else %}
                          -
                        {% endif %}
                      </td>
                      <td>
                        {% if can_bypass_parallel and (t.status or '') == 'PENDING' %}
                          <form method="post" class="d-flex gap-2" action="{{ url_for('workflow.bypass_parallel_assignee', request_id=req.id, step_order=current_step.step_order) }}">
                            <input type="hidden" name="assignee_user_id" value="{{ t.assignee_user_id }}">
                            <input class="form-control form-control-sm" name="reason" placeholder="Ø³Ø¨Ø¨ Ø§Ù„ØªØ¬Ø§ÙˆØ²" required>
                            <button class="btn btn-sm btn-outline-danger" type="submit">ØªØ¬Ø§ÙˆØ²</button>
                          </form>
                        {% elif (t.status or '') == 'BYPASSED' %}
                          <div class="small text-muted">
                            {% if t.bypass_reason %}Ø§Ù„Ø³Ø¨Ø¨: {{ t.bypass_reason }}{% endif %}
                            {% if t.bypassed_by %} Â· Ø¨ÙˆØ§Ø³Ø·Ø©: {{ t.bypassed_by.email }}{% elif t.bypassed_by_id %} Â· Ø¨ÙˆØ§Ø³Ø·Ø©: #{{ t.bypassed_by_id }}{% endif %}
                          </div>
                        {% else %}
                          -
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            {% if can_bypass_parallel %}
              <div class="form-text mt-2">ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ¬Ø§ÙˆØ²: Ù…Ù†ÙÙ‘Ø° Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø£Ùˆ Admin/Super Admin.</div>
            {% endif %}
          {% else %}
            <div class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…ØªØ²Ø§Ù…Ù†Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ© (Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ Ø¹Ù†Ø¯ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø®Ø·ÙˆØ©).</div>
          {% endif %}
        </div>
      </div>
    {% endif %}

    {% if can_decide and current_step %}
    <div class="card shadow-sm">
      <div class="card-header bg-white">
        <strong>âœ… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ (Ø§Ù„Ø®Ø·ÙˆØ© {{ current_step.step_order }})</strong>
      </div>
      <div class="card-body">
        <form method="post" enctype="multipart/form-data"
              action="{{ url_for('workflow.decide_request_step', request_id=req.id, step_order=current_step.step_order) }}">
          <div class="mb-3">
            <label class="form-label">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</label>
            <textarea class="form-control" name="note" rows="3" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©"></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label">ğŸ“ Ù…Ø±ÙÙ‚Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input type="file" name="files" multiple class="form-control">
            <div class="form-text">ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ù„Ù Ù…Ø¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.</div>
          </div>

          <div class="d-flex gap-2">
            <button class="btn btn-success w-100" name="decision" value="APPROVED">Ù…ÙˆØ§ÙÙ‚Ø©</button>
            <button class="btn btn-danger w-100" name="decision" value="REJECTED">Ø±ÙØ¶</button>
          </div>
        </form>
      </div>
    </div>
    {% else %}
    <div class="alert alert-light text-muted">
      Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø¬Ø±Ø§Ø¡ Ù…Ø·Ù„ÙˆØ¨ Ù…Ù†Ùƒ Ø­Ø§Ù„ÙŠØ§Ù‹.
    </div>
    


    {% endif %}

    <div class="card shadow-sm mt-3">
      <div class="card-header bg-white">
        <strong>ğŸ’¬ ØªØ¹Ù„ÙŠÙ‚ / Ø±Ø¯</strong>
      </div>
      <div class="card-body">
        <form method="post" enctype="multipart/form-data" action="{{ url_for('workflow.add_request_note', request_id=req.id) }}">
          <div class="mb-3">
            <label class="form-label">Ø§Ù„Ù†Øµ</label>
            <textarea class="form-control" name="note" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø£Ùˆ Ø§Ù„Ø±Ø¯ Ù‡Ù†Ø§"></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label">ğŸ“ Ù…Ø±ÙÙ‚Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input type="file" name="files" multiple class="form-control">
            <div class="form-text">ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ù„Ù Ù…Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚/Ø§Ù„Ø±Ø¯.</div>
          </div>

          {% if current_user.id == req.requester_id %}
            <button class="btn btn-primary w-100" name="kind" value="REPLY">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø¯ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹</button>
          {% else %}
            <div class="d-flex gap-2">
              <button class="btn btn-outline-primary w-100" name="kind" value="COMMENT">Ø¥Ø±Ø³Ø§Ù„ ØªØ¹Ù„ÙŠÙ‚</button>
              <button class="btn btn-primary w-100" name="kind" value="REPLY">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø¯</button>
            </div>
          {% endif %}
        </form>
        <div class="small text-muted mt-2">Ø³ÙŠØµÙ„ ØªÙ†Ø¨ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±.</div>
      </div>
    </div>

  </div>

</div>

{# =========================
   SLA Info Modal
   ========================= #}
<div class="modal fade" id="slaInfoModal" tabindex="-1" aria-labelledby="slaInfoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="slaInfoModalLabel">Ù…Ø§ Ù‡Ùˆ SLAØŸ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">
          <b>SLA</b> Ø§Ø®ØªØµØ§Ø± Ù„Ù€ <b>Service Level Agreement</b>ØŒ ÙˆÙŠØ¹Ù†ÙŠ <b>Ø§ØªÙØ§Ù‚ÙŠØ© Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø¯Ù…Ø©</b>.
          ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…: Ù‡ÙŠ <b>Ù…Ø¯Ø© Ø²Ù…Ù†ÙŠØ© (Ø¨Ø§Ù„Ø£ÙŠØ§Ù…)</b> ØªØ­Ø¯Ø¯ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø®Ø·ÙˆØ©/Ø§Ù„Ù…Ø³Ø§Ø± Ù‚Ø¨Ù„ Ø§Ø¹ØªØ¨Ø§Ø±Ù‡ Ù…ØªØ£Ø®Ø±Ù‹Ø§.
        </p>
        <div class="alert alert-light mb-0">
          <div class="fw-bold" id="slaInfoScope">SLA</div>
          <div class="mt-1">Ø§Ù„Ù‚ÙŠÙ…Ø©: <span id="slaInfoValue">-</span> <span class="text-muted" id="slaInfoUnit">ÙŠÙˆÙ…</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    var modalEl = document.getElementById('slaInfoModal');
    if (!modalEl) return;
    modalEl.addEventListener('show.bs.modal', function (event) {
      var trigger = event.relatedTarget;
      if (!trigger) return;
      var label = trigger.getAttribute('data-sla-label') || 'SLA';
      var value = trigger.getAttribute('data-sla-value') || '-';
      var scopeEl = modalEl.querySelector('#slaInfoScope');
      var valEl = modalEl.querySelector('#slaInfoValue');
      var unitEl = modalEl.querySelector('#slaInfoUnit');
      if (scopeEl) scopeEl.textContent = label;
      if (valEl) {
        var v = (value || '').toString().trim();
        if (!v || v === '-' || v.toLowerCase() === 'none' || v.toLowerCase() === 'null') {
          valEl.textContent = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
          if (unitEl) unitEl.style.display = 'none';
        } else {
          valEl.textContent = v;
          if (unitEl) unitEl.style.display = '';
        }
      }
    });
  });
</script>

{% endblock %}