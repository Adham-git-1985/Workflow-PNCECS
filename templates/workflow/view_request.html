{# templates/workflow/view_request.html #}
{% extends "layout.html" %}
{% block title %}Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨{% endblock %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h3 class="mb-1">ğŸ“„ Ø§Ù„Ø·Ù„Ø¨ #{{ req.id }}</h3>
    <small class="text-muted">
      Ø§Ù„Ø­Ø§Ù„Ø©: <strong>{{ req.status }}</strong>
      {% if inst %} Â· Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <strong>{{ inst.current_step_order }}</strong>{% endif %}
      {% if template %} Â· Ø§Ù„Ù…Ø³Ø§Ø±: <strong>{{ template.name }}</strong>{% endif %}
    </small>
  </div>

  <div class="d-flex gap-2">
    <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('workflow.request_pdf', request_id=req.id) }}">
      PDF
    </a>

    {% if current_user.has_role('SUPER_ADMIN') %}
    <form method="post"
          action="{{ url_for('workflow.delete_request', request_id=req.id) }}"
          onsubmit="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø°Ù„Ùƒ ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚.');">
      <button type="submit" class="btn btn-sm btn-danger">
        ğŸ—‘ï¸ Ø­Ø°Ù
      </button>
    </form>
    {% endif %}
    {% if can_escalate %}
    <a class="btn btn-sm btn-outline-danger" href="{{ url_for('workflow.escalate_request', request_id=req.id) }}">
      ğŸš¨ ØªØµØ¹ÙŠØ¯
    </a>
    {% endif %}
  </div>
</div>

<div class="row g-3">

  <div class="col-lg-7">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h5 class="mb-2">{{ req.title }}</h5>
        <div class="text-muted">{{ req.description or "â€”" }}</div>
      </div>
    </div>

    <div class="card shadow-sm mb-3">
      <div class="card-header bg-white">
        <strong>ğŸ“ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</strong>
      </div>
      <div class="card-body">
        {% if attachments %}
          <ul class="list-group">
            {% for a in attachments %}
              {% set f = files_map.get(a.archived_file_id) %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <strong>{{ f.original_name if f else ("File #" ~ a.archived_file_id) }}</strong>
                  {% if f %}
                    <div class="small text-muted">
                      {{ f.file_type }} Â· {{ (f.file_size or 0)//1024 }} KB
                    </div>
                  {% endif %}
                </div>
                {% if f %}
                  <div class="d-flex gap-2">
                    <a class="btn btn-sm btn-outline-primary"
                       href="{{ url_for('workflow.download_workflow_attachment', file_id=f.id) }}">
                      ØªÙ†Ø²ÙŠÙ„
                    </a>
                    <a class="btn btn-sm btn-outline-secondary"
                       href="{{ url_for('workflow.preview_workflow_attachment', file_id=f.id) }}">
                      Ù…Ø¹Ø§ÙŠÙ†Ø©
                    </a>
                  </div>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª.</div>
        {% endif %}
      </div>
    </div>

    <div class="card shadow-sm mb-3">
  <div class="card-header bg-white">
    <strong>ğŸš¨ Ø§Ù„ØªØµØ¹ÙŠØ¯Ø§Øª</strong>
        <a class="btn btn-sm btn-outline-danger" target="_blank" href="{{ url_for('workflow.request_escalations', request_id=req.id) }}">Ø¹Ø±Ø¶</a>
  </div>
  <div class="card-body">
    {% if req.escalations %}
      <ul class="list-group">
        {% for e in req.escalations|sort(attribute='created_at', reverse=True) %}
          <li class="list-group-item">
            <div class="d-flex justify-content-between">
              <strong>{{ e.category }}</strong>
              {% if e.step_order %}<span class="badge bg-danger ms-2">Step {{ e.step_order }}</span>{% endif %}
              <span class="small text-muted">{{ e.created_at.strftime("%Y-%m-%d %H:%M") }}</span>
            </div>
            <div class="small text-muted mt-1">
              Ù…Ù†: {{ e.from_user.email if e.from_user else ('#' ~ e.from_user_id) }}
              â†’ Ø¥Ù„Ù‰: {% if e.targets %}{% set tids = e.targets.split(',') %}{% for tid in tids %}{% set tid2 = tid|trim %}{% if tid2 %}{% set tu = users_map.get(tid2|int) %}{{ tu.email if tu else ('#' ~ tid2) }}{% if not loop.last %}, {% endif %}{% endif %}{% endfor %}{% else %}{{ e.to_user.email if e.to_user else ('#' ~ e.to_user_id) }}{% endif %}
            </div>
            <div class="mt-2">{{ e.description }}</div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØµØ¹ÙŠØ¯Ø§Øª.</div>
    {% endif %}
  </div>
</div>

    <div class="card shadow-sm">
      <div class="card-header bg-white">
        <strong>ğŸ§¾ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª (Audit)</strong>
      </div>
      <div class="card-body">
        {% if audit %}
          <ul class="list-group">
            {% for log in audit %}
              <li class="list-group-item">
                <div class="d-flex justify-content-between">
                  <strong>{{ log.action }}</strong>
                  <span class="small text-muted">{{ log.created_at.strftime("%Y-%m-%d %H:%M") }}</span>
                </div>
                {% if log.note %}
                  <div class="small text-muted mt-1">{{ log.note }}</div>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø¨Ø¹Ø¯.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-5">
    <div class="card shadow-sm mb-3">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <strong>ğŸ§© Ø§Ù„Ù…Ø³Ø§Ø±</strong>
        <a class="btn btn-sm btn-outline-secondary" target="_blank" href="{{ url_for('workflow.request_attachments', request_id=req.id) }}">ğŸ“ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø±{% if attachments %} ({{ attachments|length }}){% endif %}</a>
      </div>
      <div class="card-body">
        {% if steps %}

          {# ===== Pre attachments (step 0) ===== #}
          {% if pre_att_items %}
            <div class="mb-3">
              <div class="small fw-bold text-muted mb-1">ğŸ“Œ Ù…Ø±ÙÙ‚Ø§Øª Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ / Ø§Ù„Ø¥Ø±ÙØ§Ù‚</div>
              <ul class="list-unstyled small mb-0">
                {% for it in pre_att_items %}
                  <li class="mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                      <div class="text-truncate">
                        <i class="bi bi-paperclip"></i>
                        <a class="text-decoration-none" target="_blank" href="{{ url_for('workflow.preview_workflow_attachment', file_id=it.file_id) }}">{{ it.name }}</a>
                        <span class="text-muted">Â· {{ it.size_human }}</span>
                      </div>
                      <div class="text-nowrap ms-2">
                        <a class="btn btn-sm btn-outline-secondary py-0 px-2" target="_blank" href="{{ url_for('workflow.preview_workflow_attachment', file_id=it.file_id) }}">Ø¹Ø±Ø¶</a>
                        <a class="btn btn-sm btn-outline-primary py-0 px-2" href="{{ url_for('workflow.download_workflow_attachment', file_id=it.file_id) }}">ØªÙ†Ø²ÙŠÙ„</a>
                      </div>
                    </div>
                    <div class="text-muted" style="font-size:12px">
                      {{ it.source_label }}{% if it.uploaded_by %} Â· {{ it.uploaded_by }}{% endif %}{% if it.uploaded_at %} Â· {{ it.uploaded_at }}{% endif %}
                    </div>
                  </li>
                {% endfor %}
              </ul>
            </div>
            <hr class="my-2">
          {% endif %}

          <ol class="mb-0">
            {% for s in steps %}
              <li class="mb-2">
                <div class="d-flex justify-content-between">
                  <div>
                    <strong>Step {{ s.step_order }}</strong>
                    <div class="small text-muted">
  Ø§Ù„ÙˆØ¬Ù‡Ø©:
  {% if s.approver_kind == "ROLE" %}
    <span class="badge bg-secondary">ROLE</span> {{ s.approver_role }}
  {% elif s.approver_kind == "USER" %}
    <span class="badge bg-secondary">USER</span>
    {% if s.approver_user_id and users_map.get(s.approver_user_id) %}
      {{ users_map.get(s.approver_user_id).email }}
    {% else %}
      #{{ s.approver_user_id }}
    {% endif %}
  {% elif s.approver_kind == "DIRECTORATE" %}
    <span class="badge bg-secondary">DIRECTORATE</span>
    {% if s.approver_directorate_id and dirs_map.get(s.approver_directorate_id) %}
      {{ dirs_map.get(s.approver_directorate_id).name_ar }}
    {% else %}
      #{{ s.approver_directorate_id }}
    {% endif %}
    â†’ <span class="text-muted">Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù… (directorate_head)</span>
  {% else %}
    <span class="badge bg-secondary">DEPARTMENT</span>
    {% if s.approver_department_id and depts_map.get(s.approver_department_id) %}
      {{ depts_map.get(s.approver_department_id).name_ar }}
    {% else %}
      #{{ s.approver_department_id }}
    {% endif %}
    â†’ <span class="text-muted">Ø±Ø¦ÙŠØ³ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© (dept_head)</span>
  {% endif %}
</div>
                  </div>
                  <span class="badge
                    {% if s.status == 'PENDING' %}bg-warning text-dark
                    {% elif s.status == 'APPROVED' %}bg-success
                    {% elif s.status == 'REJECTED' %}bg-danger
                    {% else %}bg-secondary{% endif %}">
                    {{ s.status }}
                  </span>
                </div>
                {% if s.due_at %}
                  {% set rem = (sla_days_remaining_map.get(s.step_order) if sla_days_remaining_map else None) %}
                  {% set sla_val = (step_sla_days_map.get(s.step_order) if step_sla_days_map else None) %}
                  {% if (sla_val is none) and template %}{% set sla_val = template.sla_days_default %}{% endif %}
                  <div class="small text-muted">
                    <a href="#" class="text-decoration-none sla-link"
                       data-bs-toggle="modal" data-bs-target="#slaInfoModal"
                       data-sla-label="SLA Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ© (Ø§Ù„Ø®Ø·ÙˆØ© {{ s.step_order }})"
                       data-sla-value="{{ sla_val if sla_val is not none else '-' }}">
                      SLA: {{ s.due_at.strftime("%Y-%m-%d %H:%M") }}{% if rem is not none %} ({{ rem }} ÙŠÙˆÙ…){% endif %}
                    </a>
                  </div>
                {% endif %}

                {% set c = (step_att_counts.get(s.step_order, 0) if step_att_counts else 0) %}
                {% if c %}
                  <div class="small text-muted">ğŸ“ Ù…Ø±ÙÙ‚Ø§Øª Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ©: {{ c }}</div>
                {% endif %}

                {% set ec = (step_escalation_counts.get(s.step_order, 0) if step_escalation_counts else 0) %}
                {% if ec %}
                  <div class="small">
                    <a class="text-danger text-decoration-none" target="_blank" href="{{ url_for('workflow.request_escalations', request_id=req.id, step=s.step_order) }}">ğŸš¨ ØªØµØ¹ÙŠØ¯Ø§Øª Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ© ({{ ec }})</a>
                  </div>
                {% endif %}

                {# ===== Step attachments (detailed list) ===== #}
                {% set items = (step_att_items.get(s.step_order) if step_att_items else None) %}
                {% if items %}
                  <div class="mt-2">
                    <div class="small fw-bold text-muted mb-1">ğŸ“ Ù…Ù„ÙØ§Øª Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ©</div>
                    <ul class="list-unstyled small mb-0">
                      {% for it in items %}
                        <li class="mb-2">
                          <div class="d-flex justify-content-between align-items-center">
                            <div class="text-truncate">
                              <i class="bi bi-paperclip"></i>
                              <a class="text-decoration-none" target="_blank" href="{{ url_for('workflow.preview_workflow_attachment', file_id=it.file_id) }}">{{ it.name }}</a>
                              <span class="text-muted">Â· {{ it.size_human }}</span>
                            </div>
                            <div class="text-nowrap ms-2">
                              <a class="btn btn-sm btn-outline-secondary py-0 px-2" target="_blank" href="{{ url_for('workflow.preview_workflow_attachment', file_id=it.file_id) }}">Ø¹Ø±Ø¶</a>
                              <a class="btn btn-sm btn-outline-primary py-0 px-2" href="{{ url_for('workflow.download_workflow_attachment', file_id=it.file_id) }}">ØªÙ†Ø²ÙŠÙ„</a>
                            </div>
                          </div>
                          <div class="text-muted" style="font-size:12px">
                            {{ it.source_label }}{% if it.uploaded_by %} Â· {{ it.uploaded_by }}{% endif %}{% if it.uploaded_at %} Â· {{ it.uploaded_at }}{% endif %}
                          </div>
                        </li>
                      {% endfor %}
                    </ul>
                    <div class="mt-1">
                      <a class="small text-muted" target="_blank" href="{{ url_for('workflow.request_attachments', request_id=req.id) }}">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø¨Ø§Ù„ØªÙØ§ØµÙŠÙ„</a>
                    </div>
                  </div>
                {% endif %}
              </li>
            {% endfor %}
          </ol>
        {% else %}
          <div class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ø§Ø± Ù…Ù†Ø´Ø£ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨.</div>
        {% endif %}
      </div>
    </div>

    {% if can_decide and current_step %}
    <div class="card shadow-sm">
      <div class="card-header bg-white">
        <strong>âœ… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ (Ø§Ù„Ø®Ø·ÙˆØ© {{ current_step.step_order }})</strong>
      </div>
      <div class="card-body">
        <form method="post" enctype="multipart/form-data"
              action="{{ url_for('workflow.decide_request_step', request_id=req.id, step_order=current_step.step_order) }}">
          <div class="mb-3">
            <label class="form-label">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</label>
            <textarea class="form-control" name="note" rows="3" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©"></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label">ğŸ“ Ù…Ø±ÙÙ‚Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input type="file" name="files" multiple class="form-control">
            <div class="form-text">ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ù„Ù Ù…Ø¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.</div>
          </div>

          <div class="d-flex gap-2">
            <button class="btn btn-success w-100" name="decision" value="APPROVED">Ù…ÙˆØ§ÙÙ‚Ø©</button>
            <button class="btn btn-danger w-100" name="decision" value="REJECTED">Ø±ÙØ¶</button>
          </div>
        </form>
      </div>
    </div>
    {% else %}
    <div class="alert alert-light text-muted">
      Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø¬Ø±Ø§Ø¡ Ù…Ø·Ù„ÙˆØ¨ Ù…Ù†Ùƒ Ø­Ø§Ù„ÙŠØ§Ù‹.
    </div>
    


    {% endif %}

    <div class="card shadow-sm mt-3">
      <div class="card-header bg-white">
        <strong>ğŸ’¬ ØªØ¹Ù„ÙŠÙ‚ / Ø±Ø¯</strong>
      </div>
      <div class="card-body">
        <form method="post" enctype="multipart/form-data" action="{{ url_for('workflow.add_request_note', request_id=req.id) }}">
          <div class="mb-3">
            <label class="form-label">Ø§Ù„Ù†Øµ</label>
            <textarea class="form-control" name="note" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø£Ùˆ Ø§Ù„Ø±Ø¯ Ù‡Ù†Ø§"></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label">ğŸ“ Ù…Ø±ÙÙ‚Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input type="file" name="files" multiple class="form-control">
            <div class="form-text">ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ù„Ù Ù…Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚/Ø§Ù„Ø±Ø¯.</div>
          </div>

          {% if current_user.id == req.requester_id %}
            <button class="btn btn-primary w-100" name="kind" value="REPLY">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø¯ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹</button>
          {% else %}
            <div class="d-flex gap-2">
              <button class="btn btn-outline-primary w-100" name="kind" value="COMMENT">Ø¥Ø±Ø³Ø§Ù„ ØªØ¹Ù„ÙŠÙ‚</button>
              <button class="btn btn-primary w-100" name="kind" value="REPLY">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø¯</button>
            </div>
          {% endif %}
        </form>
        <div class="small text-muted mt-2">Ø³ÙŠØµÙ„ ØªÙ†Ø¨ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±.</div>
      </div>
    </div>

  </div>

</div>

{# =========================
   SLA Info Modal
   ========================= #}
<div class="modal fade" id="slaInfoModal" tabindex="-1" aria-labelledby="slaInfoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="slaInfoModalLabel">Ù…Ø§ Ù‡Ùˆ SLAØŸ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">
          <b>SLA</b> Ø§Ø®ØªØµØ§Ø± Ù„Ù€ <b>Service Level Agreement</b>ØŒ ÙˆÙŠØ¹Ù†ÙŠ <b>Ø§ØªÙØ§Ù‚ÙŠØ© Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø¯Ù…Ø©</b>.
          ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…: Ù‡ÙŠ <b>Ù…Ø¯Ø© Ø²Ù…Ù†ÙŠØ© (Ø¨Ø§Ù„Ø£ÙŠØ§Ù…)</b> ØªØ­Ø¯Ø¯ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø®Ø·ÙˆØ©/Ø§Ù„Ù…Ø³Ø§Ø± Ù‚Ø¨Ù„ Ø§Ø¹ØªØ¨Ø§Ø±Ù‡ Ù…ØªØ£Ø®Ø±Ù‹Ø§.
        </p>
        <div class="alert alert-light mb-0">
          <div class="fw-bold" id="slaInfoScope">SLA</div>
          <div class="mt-1">Ø§Ù„Ù‚ÙŠÙ…Ø©: <span id="slaInfoValue">-</span> <span class="text-muted">ÙŠÙˆÙ…</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    var modalEl = document.getElementById('slaInfoModal');
    if (!modalEl) return;
    modalEl.addEventListener('show.bs.modal', function (event) {
      var trigger = event.relatedTarget;
      if (!trigger) return;
      var label = trigger.getAttribute('data-sla-label') || 'SLA';
      var value = trigger.getAttribute('data-sla-value') || '-';
      var scopeEl = modalEl.querySelector('#slaInfoScope');
      var valEl = modalEl.querySelector('#slaInfoValue');
      if (scopeEl) scopeEl.textContent = label;
      if (valEl) valEl.textContent = value;
    });
  });
</script>

{% endblock %}