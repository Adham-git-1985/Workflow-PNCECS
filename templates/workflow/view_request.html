{# templates/workflow/view_request.html #}
{% extends "layout.html" %}
{% block title %}Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨{% endblock %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h3 class="mb-1">ğŸ“„ Ø§Ù„Ø·Ù„Ø¨ #{{ req.id }}</h3>
    <small class="text-muted">
      Ø§Ù„Ø­Ø§Ù„Ø©: <strong>{{ req.status }}</strong>
      {% if inst %} Â· Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <strong>{{ inst.current_step_order }}</strong>{% endif %}
      {% if template %} Â· Ø§Ù„Ù…Ø³Ø§Ø±: <strong>{{ template.name }}</strong>{% endif %}
    </small>
  </div>

  <div class="d-flex gap-2">
    <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('workflow.request_pdf', request_id=req.id) }}">
      PDF
    </a>

    {% if current_user.has_role('SUPER_ADMIN') %}
    <form method="post"
          action="{{ url_for('workflow.delete_request', request_id=req.id) }}"
          onsubmit="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø°Ù„Ùƒ ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚.');">
      <button type="submit" class="btn btn-sm btn-danger">
        ğŸ—‘ï¸ Ø­Ø°Ù
      </button>
    </form>
    {% endif %}
    {% if can_decide %}
    <a class="btn btn-sm btn-outline-danger" href="{{ url_for('workflow.escalate_request', request_id=req.id) }}">
      ğŸš¨ ØªØµØ¹ÙŠØ¯
    </a>
    {% endif %}
  </div>
</div>

<div class="row g-3">

  <div class="col-lg-7">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h5 class="mb-2">{{ req.title }}</h5>
        <div class="text-muted">{{ req.description or "â€”" }}</div>
      </div>
    </div>

    <div class="card shadow-sm mb-3">
      <div class="card-header bg-white">
        <strong>ğŸ“ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</strong>
      </div>
      <div class="card-body">
        {% if attachments %}
          <ul class="list-group">
            {% for a in attachments %}
              {% set f = files_map.get(a.archived_file_id) %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <strong>{{ f.original_name if f else ("File #" ~ a.archived_file_id) }}</strong>
                  {% if f %}
                    <div class="small text-muted">
                      {{ f.file_type }} Â· {{ (f.file_size or 0)//1024 }} KB
                    </div>
                  {% endif %}
                </div>
                {% if f %}
                  <div class="d-flex gap-2">
                    <a class="btn btn-sm btn-outline-primary"
                       href="{{ url_for('archive.download_file', file_id=f.id) }}">
                      ØªÙ†Ø²ÙŠÙ„
                    </a>
                    <a class="btn btn-sm btn-outline-secondary"
                       href="{{ url_for('archive.preview_file', file_id=f.id) }}">
                      Ù…Ø¹Ø§ÙŠÙ†Ø©
                    </a>
                  </div>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª.</div>
        {% endif %}
      </div>
    </div>

    <div class="card shadow-sm mb-3">
  <div class="card-header bg-white">
    <strong>ğŸš¨ Ø§Ù„ØªØµØ¹ÙŠØ¯Ø§Øª</strong>
  </div>
  <div class="card-body">
    {% if req.escalations %}
      <ul class="list-group">
        {% for e in req.escalations|sort(attribute='created_at', reverse=True) %}
          <li class="list-group-item">
            <div class="d-flex justify-content-between">
              <strong>{{ e.category }}</strong>
              <span class="small text-muted">{{ e.created_at.strftime("%Y-%m-%d %H:%M") }}</span>
            </div>
            <div class="small text-muted mt-1">
              Ù…Ù†: {{ e.from_user.email if e.from_user else ('#' ~ e.from_user_id) }}
              â†’ Ø¥Ù„Ù‰: {{ e.to_user.email if e.to_user else ('#' ~ e.to_user_id) }}
            </div>
            <div class="mt-2">{{ e.description }}</div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØµØ¹ÙŠØ¯Ø§Øª.</div>
    {% endif %}
  </div>
</div>

    <div class="card shadow-sm">
      <div class="card-header bg-white">
        <strong>ğŸ§¾ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª (Audit)</strong>
      </div>
      <div class="card-body">
        {% if audit %}
          <ul class="list-group">
            {% for log in audit %}
              <li class="list-group-item">
                <div class="d-flex justify-content-between">
                  <strong>{{ log.action }}</strong>
                  <span class="small text-muted">{{ log.created_at.strftime("%Y-%m-%d %H:%M") }}</span>
                </div>
                {% if log.note %}
                  <div class="small text-muted mt-1">{{ log.note }}</div>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø¨Ø¹Ø¯.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-5">
    <div class="card shadow-sm mb-3">
      <div class="card-header bg-white">
        <strong>ğŸ§© Ø§Ù„Ù…Ø³Ø§Ø±</strong>
      </div>
      <div class="card-body">
        {% if steps %}
          <ol class="mb-0">
            {% for s in steps %}
              <li class="mb-2">
                <div class="d-flex justify-content-between">
                  <div>
                    <strong>Step {{ s.step_order }}</strong>
                    <div class="small text-muted">
  Ø§Ù„ÙˆØ¬Ù‡Ø©:
  {% if s.approver_kind == "ROLE" %}
    <span class="badge bg-secondary">ROLE</span> {{ s.approver_role }}
  {% elif s.approver_kind == "USER" %}
    <span class="badge bg-secondary">USER</span>
    {% if s.approver_user_id and users_map.get(s.approver_user_id) %}
      {{ users_map.get(s.approver_user_id).email }}
    {% else %}
      #{{ s.approver_user_id }}
    {% endif %}
  {% elif s.approver_kind == "DIRECTORATE" %}
    <span class="badge bg-secondary">DIRECTORATE</span>
    {% if s.approver_directorate_id and dirs_map.get(s.approver_directorate_id) %}
      {{ dirs_map.get(s.approver_directorate_id).name_ar }}
    {% else %}
      #{{ s.approver_directorate_id }}
    {% endif %}
    â†’ <span class="text-muted">Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù… (directorate_head)</span>
  {% else %}
    <span class="badge bg-secondary">DEPARTMENT</span>
    {% if s.approver_department_id and depts_map.get(s.approver_department_id) %}
      {{ depts_map.get(s.approver_department_id).name_ar }}
    {% else %}
      #{{ s.approver_department_id }}
    {% endif %}
    â†’ <span class="text-muted">Ø±Ø¦ÙŠØ³ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© (dept_head)</span>
  {% endif %}
</div>
                  </div>
                  <span class="badge
                    {% if s.status == 'PENDING' %}bg-warning text-dark
                    {% elif s.status == 'APPROVED' %}bg-success
                    {% elif s.status == 'REJECTED' %}bg-danger
                    {% else %}bg-secondary{% endif %}">
                    {{ s.status }}
                  </span>
                </div>
                {% if s.due_at %}
                  <div class="small text-muted">SLA: {{ s.due_at.strftime("%Y-%m-%d %H:%M") }}</div>
                {% endif %}
              </li>
            {% endfor %}
          </ol>
        {% else %}
          <div class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ø§Ø± Ù…Ù†Ø´Ø£ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨.</div>
        {% endif %}
      </div>
    </div>

    {% if can_decide and current_step %}
    <div class="card shadow-sm">
      <div class="card-header bg-white">
        <strong>âœ… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ (Ø§Ù„Ø®Ø·ÙˆØ© {{ current_step.step_order }})</strong>
      </div>
      <div class="card-body">
        <form method="post"
              action="{{ url_for('workflow.decide_request_step', request_id=req.id, step_order=current_step.step_order) }}">
          <div class="mb-3">
            <label class="form-label">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</label>
            <textarea class="form-control" name="note" rows="3" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©"></textarea>
          </div>

          <div class="d-flex gap-2">
            <button class="btn btn-success w-100" name="decision" value="APPROVED">Ù…ÙˆØ§ÙÙ‚Ø©</button>
            <button class="btn btn-danger w-100" name="decision" value="REJECTED">Ø±ÙØ¶</button>
          </div>
        </form>
      </div>
    </div>
    {% else %}
    <div class="alert alert-light text-muted">
      Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø¬Ø±Ø§Ø¡ Ù…Ø·Ù„ÙˆØ¨ Ù…Ù†Ùƒ Ø­Ø§Ù„ÙŠØ§Ù‹.
    </div>
    


    {% endif %}

    <div class="card shadow-sm mt-3">
      <div class="card-header bg-white">
        <strong>ğŸ’¬ ØªØ¹Ù„ÙŠÙ‚ / Ø±Ø¯</strong>
      </div>
      <div class="card-body">
        <form method="post" action="{{ url_for('workflow.add_request_note', request_id=req.id) }}">
          <div class="mb-3">
            <label class="form-label">Ø§Ù„Ù†Øµ</label>
            <textarea class="form-control" name="note" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø£Ùˆ Ø§Ù„Ø±Ø¯ Ù‡Ù†Ø§"></textarea>
          </div>

          {% if current_user.id == req.requester_id %}
            <button class="btn btn-primary w-100" name="kind" value="REPLY">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø¯ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹</button>
          {% else %}
            <div class="d-flex gap-2">
              <button class="btn btn-outline-primary w-100" name="kind" value="COMMENT">Ø¥Ø±Ø³Ø§Ù„ ØªØ¹Ù„ÙŠÙ‚</button>
              <button class="btn btn-primary w-100" name="kind" value="REPLY">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø¯</button>
            </div>
          {% endif %}
        </form>
        <div class="small text-muted mt-2">Ø³ÙŠØµÙ„ ØªÙ†Ø¨ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±.</div>
      </div>
    </div>

  </div>

</div>

{% endblock %}