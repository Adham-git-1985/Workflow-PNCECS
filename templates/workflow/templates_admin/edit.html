{% extends "layout.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h3 class="mb-1">ğŸ§© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø± #{{ t.id }}</h3>
    <small class="text-muted">{{ t.name }}</small>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-success" href="{{ url_for('workflow.templates_steps_export_excel', template_id=t.id) }}">â¬‡ï¸ Excel</a>
    <a class="btn btn-outline-secondary" href="{{ url_for('workflow.templates_list') }}">Ø±Ø¬ÙˆØ¹</a>
    <form method="post" action="{{ url_for('workflow.templates_delete', template_id=t.id) }}"
          onsubmit="return confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø§Ø± Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ');">
      <button class="btn btn-outline-danger">Ø­Ø°Ù</button>
    </form>
  </div>
</div>

{# users map for display #}
{% set users_map = {} %}
{% if users %}
  {% for u in users %}
    {% set _ = users_map.update({u.id: u}) %}
  {% endfor %}
{% endif %}

{# departments map for display #}
{% set depts_map = {} %}
{% if departments %}
  {% for d in departments %}
    {% set _ = depts_map.update({d.id: d}) %}
  {% endfor %}
{% endif %}

{# directorates map for display #}
{% set dirs_map = {} %}
{% if directorates %}
  {% for d in directorates %}
    {% set _ = dirs_map.update({d.id: d}) %}
  {% endfor %}
{% endif %}


<div class="card shadow-sm mb-3">
  <div class="card-body">
    <form method="post">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø±</label>
          <input class="form-control" name="name" value="{{ t.name }}" required>
        </div>

        <div class="col-md-3">
          <label class="form-label">SLA Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ø£ÙŠØ§Ù…)</label>
          <input class="form-control" name="sla_days_default" type="number" min="1"
                 value="{{ t.sla_days_default if t.sla_days_default is not none else '' }}">
        </div>

        <div class="col-md-3 d-flex align-items-end">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="is_active" value="1" id="is_active"
                   {% if t.is_active %}checked{% endif %}>
            <label class="form-check-label" for="is_active">Active</label>
          </div>
        </div>

        <div class="col-12">
          <button class="btn btn-primary">Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø±</button>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-header bg-white"><strong>ğŸ“Œ Ø®Ø·ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ø±</strong></div>
  <div class="card-body">
    {% if steps %}
    <div class="table-responsive">
      <table class="table table-sm mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th>Step</th>
            <th>Kind</th>
            <th>Target</th>
            <th>SLA</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for s in steps %}
          <tr>
            <td>{{ s.step_order }}</td>
            <td>{{ s.approver_kind }}</td>
            <td>
              {% if s.approver_kind == "USER" %}
                USER:
                {% if s.approver_user_id and users_map.get(s.approver_user_id) %}
                  {{ users_map.get(s.approver_user_id).email }}
                {% else %}
                  {{ s.approver_user_id }}
                {% endif %}
              {% elif s.approver_kind == "ROLE" %}
                ROLE: {{ s.approver_role }}
              {% elif s.approver_kind == "DIRECTORATE" %}
                DIR: {% if s.approver_directorate_id and dirs_map.get(s.approver_directorate_id) %}{{ dirs_map.get(s.approver_directorate_id).name_ar }} [#{{ s.approver_directorate_id }}]{% else %}{{ s.approver_directorate_id }}{% endif %}
              {% else %}
                DEPT: {% if s.approver_department_id and depts_map.get(s.approver_department_id) %}{{ depts_map.get(s.approver_department_id).name_ar }} [#{{ s.approver_department_id }}]{% else %}{{ s.approver_department_id }}{% endif %}
              {% endif %}
            </td>
            <td>{{ s.sla_days if s.sla_days is not none else "-" }}</td>
            <td class="text-end d-flex gap-2 justify-content-end">
              <div class="d-inline-flex gap-1">
  <form method="post" action="{{ url_for('workflow.templates_steps_move', step_id=s.id, direction='up') }}">
    <button class="btn btn-sm btn-outline-secondary" title="Ø£Ø¹Ù„Ù‰">â†‘</button>
  </form>
  <form method="post" action="{{ url_for('workflow.templates_steps_move', step_id=s.id, direction='down') }}">
    <button class="btn btn-sm btn-outline-secondary" title="Ø£Ø³ÙÙ„">â†“</button>
  </form>
  <a class="btn btn-sm btn-outline-primary"
                 href="{{ url_for('workflow.templates_steps_edit', step_id=s.id) }}">ØªØ¹Ø¯ÙŠÙ„</a>
</div>

              <form method="post" action="{{ url_for('workflow.templates_steps_delete', step_id=s.id) }}"
                    onsubmit="return confirm('Ø­Ø°Ù Ø§Ù„Ø®Ø·ÙˆØ©ØŸ');">
                <button class="btn btn-sm btn-outline-danger">Ø­Ø°Ù</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
      <div class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø·ÙˆØ§Øª Ø¨Ø¹Ø¯.</div>
    {% endif %}
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-header bg-white"><strong>â• Ø¥Ø¶Ø§ÙØ© Ø®Ø·ÙˆØ©</strong></div>
  <div class="card-body">
    <form id="add-step-form" method="post" action="{{ url_for('workflow.templates_steps_add', template_id=t.id) }}">
      <div class="row g-3">

        <div class="col-md-3">
          <label class="form-label">Approver Kind</label>
          <select class="form-select" name="approver_kind" id="kind">
            <option value="ROLE">ROLE</option>
            <option value="USER">USER</option>
            <option value="DEPARTMENT">DEPARTMENT</option>
            <option value="DIRECTORATE">DIRECTORATE</option>
          </select>
        </div>

        <div class="col-md-3" id="box_role">
          <label class="form-label">Role</label>
          <select class="form-select" name="approver_role">
            <option value="">-- Ø§Ø®ØªØ± --</option>
            {% for r in role_choices %}
              <option value="{{ r }}">{{ r }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3" id="box_user" style="display:none;">
          <label class="form-label">User</label>
          <select class="form-select" name="approver_user_id">
            <option value="">-- Ø§Ø®ØªØ± --</option>
            {% for u in users %}
              <option value="{{ u.id }}">{{ u.email }} ({{ u.role }})</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3" id="box_dept" style="display:none;">
          <label class="form-label">Department</label>
          <select class="form-select" name="approver_department_id">
            <option value="">-- Ø§Ø®ØªØ± --</option>
            {% for d in departments %}
              <option value="{{ d.id }}">{{ d.name_ar }}{% if d.code %} ({{ d.code }}){% endif %} [#{{ d.id }}]</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3" id="box_dir" style="display:none;">
  <label class="form-label">Directorate</label>
  <select class="form-select" name="approver_directorate_id">
    <option value="">-- Ø§Ø®ØªØ± --</option>
    {% for d in directorates %}
      <option value="{{ d.id }}">{{ d.name_ar }}{% if d.code %} ({{ d.code }}){% endif %} [#{{ d.id }}]</option>
    {% endfor %}
  </select>
</div>

        <div class="col-md-3">
          <label class="form-label">SLA (Ø£ÙŠØ§Ù…)</label>
          <input class="form-control" name="sla_days" type="number" min="1" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
        </div>

        <div class="col-12">
          <button class="btn btn-success">Ø¥Ø¶Ø§ÙØ©</button>
        </div>

      </div>
    </form>
  </div>
</div>

<script>
(function () {
  const form = document.getElementById("add-step-form");
  if (!form) return;

  const kind = form.querySelector("#kind");
  const boxRole = form.querySelector("#box_role");
  const boxUser = form.querySelector("#box_user");
  const boxDept = form.querySelector("#box_dept");
  const boxDir = form.querySelector("#box_dir");

  function toggle() {
    const v = (kind && kind.value ? kind.value : "").toUpperCase();

    if (boxRole) boxRole.style.display = (v === "ROLE") ? "block" : "none";
    if (boxUser) boxUser.style.display = (v === "USER") ? "block" : "none";
    if (boxDept) boxDept.style.display = (v === "DEPARTMENT") ? "block" : "none";
    if (boxDir) boxDir.style.display = (v === "DIRECTORATE") ? "block" : "none";

    const roleSel = boxRole ? boxRole.querySelector('select[name="approver_role"]') : null;
    const userSel = boxUser ? boxUser.querySelector('select[name="approver_user_id"]') : null;
    const deptSel = boxDept ? boxDept.querySelector('select[name="approver_department_id"]') : null;
    const dirSel = boxDir ? boxDir.querySelector('select[name="approver_directorate_id"]') : null;

    if (roleSel) {
      roleSel.disabled = (v !== "ROLE");
      if (v !== "ROLE") roleSel.value = "";
    }
    if (userSel) {
      userSel.disabled = (v !== "USER");
      if (v !== "USER") userSel.value = "";
    }
    if (deptSel) {
      deptSel.disabled = (v !== "DEPARTMENT");
      if (v !== "DEPARTMENT") deptSel.value = "";
    }
    if (dirSel) {
      dirSel.disabled = (v !== "DIRECTORATE");
      if (v !== "DIRECTORATE") dirSel.value = "";
    }
  }

  if (kind) kind.addEventListener("change", toggle);
  toggle();
})();
</script>

{% endblock %}
