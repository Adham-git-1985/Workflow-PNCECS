{% extends "layout.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <div class="btn-group" role="group" aria-label="Notifications scope">
        <a href="{{ url_for('workflow.notifications', scope='inbox') }}"
           class="btn btn-sm {% if scope == 'inbox' %}btn-primary{% else %}btn-outline-primary{% endif %}">
            ğŸ“¥ Ø§Ù„ÙˆØ§Ø±Ø¯
            {% if unread_count %}<span class="badge bg-light text-dark ms-1">{{ unread_count }}</span>{% endif %}
        </a>
        <a href="{{ url_for('workflow.notifications', scope='sent') }}"
           class="btn btn-sm {% if scope == 'sent' %}btn-primary{% else %}btn-outline-primary{% endif %}">
            ğŸ“¤ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØµØ§Ø¯Ø±
            {% if pending_sent_count %}<span class="badge bg-light text-dark ms-1">{{ pending_sent_count }}</span>{% endif %}
        </a>
    </div>
</div>

<form method="get" class="card card-body mb-4 shadow-sm">

    <input type="hidden" name="scope" value="{{ scope }}">

    <div class="row g-3 align-items-end">
        <!-- Date from -->
        <div class="col-md-3">
            <label class="form-label fw-bold">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
            <input type="date"
                   name="from"
                   class="form-control"
                   value="{{ filters.from or '' }}">
        </div>

        <!-- Date to -->
        <div class="col-md-3">
            <label class="form-label fw-bold">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
            <input type="date"
                   name="to"
                   class="form-control"
                   value="{{ filters.to or '' }}">
        </div>

        <!-- Type -->
        <div class="col-md-3">
            <label class="form-label fw-bold">Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</label>
            <select name="type" class="form-select">
                <option value="">Ø§Ù„ÙƒÙ„</option>
                <option value="INFO" {% if filters.type == "INFO" %}selected{% endif %}>Info</option>
                <option value="WARNING" {% if filters.type == "WARNING" %}selected{% endif %}>Warning</option>
                <option value="CRITICAL" {% if filters.type == "CRITICAL" %}selected{% endif %}>Critical</option>
            </select>
        </div>

        <!-- Read state -->
        <div class="col-md-3">
            <label class="form-label fw-bold">Ø§Ù„Ø­Ø§Ù„Ø©</label>
            <select name="read" class="form-select">
                <option value="">Ø§Ù„ÙƒÙ„</option>
                <option value="unread" {% if filters.read == "unread" %}selected{% endif %}>ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡</option>
                <option value="read" {% if filters.read == "read" %}selected{% endif %}>Ù…Ù‚Ø±ÙˆØ¡</option>
            </select>
        </div>

        <!-- Role -->
        <div class="col-md-3">
            <label class="form-label fw-bold">Ø§Ù„Ø¯ÙˆØ±</label>
            <input type="text"
                   name="role"
                   class="form-control"
                   placeholder="ADMIN / FINANCE ..."
                   value="{{ filters.role or '' }}">
        </div>

        <!-- Buttons -->
        <div class="col-md-3 d-flex gap-2">
            <button type="submit" class="btn btn-primary w-100">
                ğŸ” ØªØ·Ø¨ÙŠÙ‚
            </button>

            <a href="{{ url_for('workflow.notifications', scope=scope) }}"
               class="btn btn-outline-secondary w-100">
                âœ– Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·
            </a>
        </div>

    </div>
</form>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h3 class="mb-1">ğŸ”” {% if scope == 'sent' %}Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ØµØ§Ø¯Ø±Ø©{% else %}Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª{% endif %}</h3>
        <small class="text-muted">
            {% if scope == 'sent' %}
                Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù„Ø¯Ù‰ Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†
                {% if pending_sent_count %}
                    Â· <strong>{{ pending_sent_count }}</strong> Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
                {% endif %}
            {% else %}
                Ø¢Ø®Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
                {% if unread_count %}
                    Â· <strong id="unread-count">{{ unread_count }}</strong> ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡
                {% endif %}
            {% endif %}
        </small>
    </div>

    {% if scope == 'inbox' and unread_count %}
    <form method="post"
          action="{{ url_for('workflow.mark_all_notifications_read') }}">
        <button class="btn btn-sm btn-outline-secondary">
            ØªØ¹Ù„ÙŠÙ… Ø§Ù„ÙƒÙ„ ÙƒÙ…Ù‚Ø±ÙˆØ¡
        </button>
    </form>
    {% endif %}

</div>

{% if notifications %}

<ul class="list-group shadow-sm">

{% for n in notifications %}
<li id="notification-{{ n.id }}"
    class="list-group-item d-flex justify-content-between align-items-start
           {% if not n.is_read %}bg-light{% endif %}">

    <div class="me-3">

        <div class="mb-1">
            <strong>{{ n.message }}</strong>

            {% if n.type == "CRITICAL" %}
                <span class="badge bg-danger ms-2">Critical</span>
            {% elif n.type == "WARNING" %}
                <span class="badge bg-warning text-dark ms-2">Warning</span>
            {% else %}
                <span class="badge bg-info text-dark ms-2">Info</span>
            {% endif %}

            {% if n.role %}
                <span class="badge bg-secondary ms-1">
                    {{ n.role }}
                </span>
            {% endif %}
        </div>

        <div class="text-muted small">
            {{ n.created_at.strftime("%Y-%m-%d %H:%M") }}
        </div>
    </div>

    <div class="text-end">
        {% if scope == 'sent' %}
            {% if n.is_read %}
                <span class="badge bg-success">ØªÙ…Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</span>
            {% else %}
                <span class="badge bg-warning text-dark">ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø³ØªÙ„Ù…</span>
            {% endif %}
        {% else %}
            {% if not n.is_read %}
                <button type="button"
                        class="btn btn-sm btn-outline-primary"
                        aria-label="ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙƒÙ…Ù‚Ø±ÙˆØ¡"
                        onclick="markRead({{ n.id }}, this)">
                    ØªØ¹Ù„ÙŠÙ… ÙƒÙ…Ù‚Ø±ÙˆØ¡
                </button>
            {% else %}
                <span class="badge bg-success">Ù…Ù‚Ø±ÙˆØ¡</span>
            {% endif %}
        {% endif %}
    </div>

</li>
{% endfor %}
</ul>

<!-- Pagination -->
<nav class="mt-4 d-flex justify-content-center">
    <ul class="pagination pagination-sm">

        {% if pagination.has_prev %}
        <li class="page-item">
            <a class="page-link"
               href="{{ url_for(
                'workflow.notifications',
                page=pagination.prev_num,
                type=filters.type,
                read=filters.read,
                role=filters.role,
                from=filters.from,
                to=filters.to,
                scope=filters.scope
            ) }}">
                Â«
            </a>
        </li>
        {% endif %}

        <li class="page-item disabled">
            <span class="page-link">
                ØµÙØ­Ø© {{ pagination.page }} Ù…Ù† {{ pagination.pages }}
            </span>
        </li>

        {% if pagination.has_next %}
        <li class="page-item">
            <a class="page-link"
               href="{{ url_for(
                'workflow.notifications',
                page=pagination.next_num,
                type=filters.type,
                read=filters.read,
                role=filters.role,
                from=filters.from,
                to=filters.to,
                scope=filters.scope
            ) }}">
                Â»
            </a>
        </li>
        {% endif %}

    </ul>
</nav>

{% else %}
<div class="alert alert-light text-center text-muted py-4">
    ğŸ”• Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹
</div>
{% endif %}

<script>
  const markReadUrlTemplate = "{{ url_for('workflow.mark_notification_read', notif_id=0) }}";

  function markRead(id, btn) {
      if (btn) {
          btn.disabled = true;
          btn.innerText = "...";
      }

      const url = markReadUrlTemplate.replace("0", id);

      fetch(url, { method: "POST" })
        .then(response => {
            if (!response.ok) throw new Error("Request failed");
        })
        .then(() => {
            const el = document.getElementById("notification-" + id);
            if (el) {
                el.classList.remove("bg-light");
                const right = el.querySelector(".text-end");
                if (right) right.innerHTML = '<span class="badge bg-success">Ù…Ù‚Ø±ÙˆØ¡</span>';
            }

            const counter = document.getElementById("unread-count");
            if (counter) {
                const val = parseInt(counter.innerText, 10) - 1;
                counter.innerText = Math.max(val, 0);
            }
        })
        .catch(() => {
            if (btn) {
                btn.disabled = false;
                btn.innerText = "ØªØ¹Ù„ÙŠÙ… ÙƒÙ…Ù‚Ø±ÙˆØ¡";
            }
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±");
        });
  }
</script>

{% endblock %}
