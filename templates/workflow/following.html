{% extends "layout.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h3 class="mb-1">ğŸ‘ï¸ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª</h3>
    <small class="text-muted">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙŠ Ø´Ø§Ø±ÙƒØª ÙÙŠÙ‡Ø§ (ÙˆØ§ÙÙ‚Øª/Ø±ÙØ¶Øª) ÙˆØªØ±ÙŠØ¯ Ù…ØªØ§Ø¨Ø¹Ø© Ø³ÙŠØ±Ù‡Ø§</small>
  </div>
</div>

<form method="get" class="row g-2 align-items-center mb-3">
  <div class="col-sm-7 col-md-6 col-lg-5">
    <div class="input-group">
      <span class="input-group-text"><i class="bi bi-search"></i></span>
      <input type="text"
             class="form-control"
             name="q"
             value="{{ q or '' }}"
             placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø£Ùˆ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯..." />
    </div>
  </div>
  <div class="col-auto">
    <button class="btn btn-outline-primary">Ø¨Ø­Ø«</button>
  </div>
  {% if q %}
  <div class="col-auto">
    <a class="btn btn-outline-secondary" href="{{ url_for('workflow.following') }}">Ø¥Ù„ØºØ§Ø¡</a>
  </div>
  {% endif %}
</form>

{% if rows %}
<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table table-hover mb-0">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th>Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</th>
          <th>SLA</th>
          <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for req, inst, tpl in rows %}
        <tr>
          <td>{{ req.id }}</td>
          <td>{{ req.title }}</td>
          <td>
            <span class="badge {% if req.status in ['APPROVED','REJECTED'] %}bg-secondary{% else %}bg-primary{% endif %}">
              {{ req.status }}
            </span>
          </td>
          <td>{% if inst %}{{ inst.current_step_order }}{% else %}â€”{% endif %}</td>
          <td>
            {% if tpl and tpl.sla_days_default %}
              <a href="#" class="text-decoration-none"
                 data-bs-toggle="modal" data-bs-target="#slaInfoModal"
                 data-sla-label="SLA Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ù…Ø³Ø§Ø±" data-sla-value="{{ tpl.sla_days_default }}">
                {{ tpl.sla_days_default }} ÙŠÙˆÙ…
              </a>
            {% else %}
              â€”
            {% endif %}
          </td>
          <td>{{ req.created_at.strftime("%Y-%m-%d %H:%M") }}</td>
          <td class="text-end">
            <a class="btn btn-sm btn-outline-primary"
               href="{{ url_for('workflow.view_request', request_id=req.id) }}">
              ÙØªØ­
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{# =========================
   SLA Info Modal (template-level)
   ========================= #}
<div class="modal fade" id="slaInfoModal" tabindex="-1" aria-labelledby="slaInfoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="slaInfoModalLabel">Ù…Ø§ Ù‡Ùˆ SLAØŸ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">
          <b>SLA</b> Ø§Ø®ØªØµØ§Ø± Ù„Ù€ <b>Service Level Agreement</b>ØŒ ÙˆÙŠØ¹Ù†ÙŠ <b>Ø§ØªÙØ§Ù‚ÙŠØ© Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø¯Ù…Ø©</b>.
          ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…: Ù‡ÙŠ <b>Ù…Ø¯Ø© Ø²Ù…Ù†ÙŠØ© (Ø¨Ø§Ù„Ø£ÙŠØ§Ù…)</b> ØªØ­Ø¯Ø¯ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ø³Ø§Ø± Ù‚Ø¨Ù„ Ø§Ø¹ØªØ¨Ø§Ø±Ù‡ Ù…ØªØ£Ø®Ø±Ù‹Ø§.
        </p>
        <div class="alert alert-light mb-0">
          <div class="fw-bold" id="slaInfoScope">SLA</div>
          <div class="mt-1">Ø§Ù„Ù‚ÙŠÙ…Ø©: <span id="slaInfoValue">-</span> <span class="text-muted">ÙŠÙˆÙ…</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    var modalEl = document.getElementById('slaInfoModal');
    if (!modalEl) return;
    modalEl.addEventListener('show.bs.modal', function (event) {
      var trigger = event.relatedTarget;
      if (!trigger) return;
      var label = trigger.getAttribute('data-sla-label') || 'SLA';
      var value = trigger.getAttribute('data-sla-value') || '-';
      var scopeEl = modalEl.querySelector('#slaInfoScope');
      var valEl = modalEl.querySelector('#slaInfoValue');
      if (scopeEl) scopeEl.textContent = label;
      if (valEl) valEl.textContent = value;
    });
  });
</script>
{% else %}
<div class="alert alert-light text-center text-muted py-4">
  Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø§Ø±Ø§Øª ØªØªØ§Ø¨Ø¹Ù‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹ âœ…
</div>
{% endif %}

{% endblock %}
