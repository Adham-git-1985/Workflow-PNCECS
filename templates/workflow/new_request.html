{% extends "layout.html" %}
{% block title %}Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h3 class="mb-1">â• Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
    <small class="text-muted">Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ ÙˆØ¨Ø¯Ø¡ Ù…Ø³Ø§Ø± Ø§Ù„Ø¹Ù…Ù„</small>
  </div>
  <a class="btn btn-outline-secondary" href="{{ url_for('workflow.inbox') }}">Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙ†Ø¯ÙˆÙ‚</a>
</div>

{% if request_types and not templates %}
  <div class="alert alert-warning">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Templates Ù…ÙØ¹Ù‘Ù„Ø©. ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³Ø§Ø± Ø¹Ù…Ù„ Ù…Ù† ØµÙØ­Ø© Templates.</div>
{% endif %}

<form method="post" class="card shadow-sm" enctype="multipart/form-data">
  <div class="card-body">
    <div class="row g-3">

      <div class="col-md-6">
        <label class="form-label fw-bold">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø·Ù„Ø¨</label>
        <input class="form-control" name="title" placeholder="Ù…Ø«Ø§Ù„: Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ØŒ Ø·Ù„Ø¨ Ø¥Ø¬Ø§Ø²Ø©..." required>
      </div>

      <div class="col-md-6">
        <label class="form-label fw-bold">Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</label>
        {% if request_types %}
          <select class="form-select" id="rtSelect" name="request_type_id" required>
            <option value="">â€” Ø§Ø®ØªØ± â€”</option>
            {% for rt in request_types %}
              <option value="{{ rt.id }}" {% if selected_rt_id == rt.id %}selected{% endif %}>{{ rt.name_ar }} ({{ rt.code }})</option>
            {% endfor %}
          </select>
          <div class="form-text">Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨ Ø³ÙŠØªÙ… Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„Ù…Ø³Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù…Ø¶Ø¨ÙˆØ·Ø©).</div>
        {% else %}
          <div class="alert alert-light mb-0 text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Request Types Ø¨Ø¹Ø¯. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Template Ù…Ø¨Ø§Ø´Ø±Ø©.</div>
        {% endif %}
      </div>

      <div class="col-12">
        <label class="form-label fw-bold">Ø§Ù„ÙˆØµÙ / Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
        <textarea class="form-control" name="description" rows="4" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„..."></textarea>
      </div>

      <div class="col-md-6">
        <label class="form-label fw-bold">Ø§Ù„Ù…Ø³Ø§Ø± (Template)</label>
        <select class="form-select" id="templateSelect" name="template_id" {% if not templates %}disabled{% endif %}>
          <option value="">â€” Ø§Ø®ØªØ± â€”</option>
          {% for t in templates %}
            <option value="{{ t.id }}" {% if suggested_template and suggested_template.id == t.id %}selected{% endif %}>{{ t.name }}</option>
          {% endfor %}
        </select>
        <div class="form-text">Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù‚ØªØ±Ø§Ø­ Ù…Ø³Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ØŒ Ø§Ø®ØªØ±Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹.</div>

        {% if suggested_template %}
          <div class="alert alert-success mt-2 mb-0">
            âœ… ØªÙ… Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„Ù…Ø³Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹: <strong>{{ suggested_template.name }}</strong>
            {% if matched_rule %}
              <div class="mt-1"><small class="text-muted">Ù‚Ø§Ø¹Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡: #{{ matched_rule.id }} | Priority: {{ matched_rule.priority }}</small></div>
            {% endif %}
          </div>
        {% elif selected_rt_id %}
          <div class="alert alert-warning mt-2 mb-0">
            âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Routing Rule Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ (Ø­Ø³Ø¨ Ø¯Ø§Ø¦Ø±ØªÙƒ). ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Template ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¹Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡.
          </div>
        {% endif %}
      </div>

      <div class="col-12">
        <label class="form-label fw-bold">ğŸ“ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø·Ù„Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input type="file" name="files" class="form-control" multiple>
        <div class="form-text">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ù„ÙØŒ ÙˆØ³ÙŠØªÙ… Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ø§Ù„Ø·Ù„Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</div>
      </div>


      <div class="col-12">
        <button class="btn btn-primary">ğŸš€ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨</button>
      </div>

    </div>
  </div>
</form>

{% if request_types %}
<script>
  (function(){
    const rt = document.getElementById('rtSelect');
    const form = document.querySelector('form[method="post"]');
    const titleEl = document.querySelector("input[name='title']");
    const descEl = document.querySelector("textarea[name='description']");
    const KEY = 'wf_newreq_draft_v1';

    function saveDraft(){
      try {
        const payload = {
          title: titleEl ? (titleEl.value || '') : '',
          description: descEl ? (descEl.value || '') : ''
        };
        localStorage.setItem(KEY, JSON.stringify(payload));
      } catch(e) {}
    }

    function restoreDraft(){
      try {
        const raw = localStorage.getItem(KEY);
        if (!raw) return;
        const payload = JSON.parse(raw);
        if (titleEl && !titleEl.value && payload.title) titleEl.value = payload.title;
        if (descEl && !descEl.value && payload.description) descEl.value = payload.description;
      } catch(e) {}
    }

    // Restore draft on load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', restoreDraft);
    } else {
      restoreDraft();
    }

    // Keep saving while typing
    if (titleEl) titleEl.addEventListener('input', saveDraft);
    if (descEl) descEl.addEventListener('input', saveDraft);

    // Clear draft after successful submit (best-effort)
    if (form) {
      form.addEventListener('submit', function(){
        try { localStorage.removeItem(KEY); } catch(e) {}
      });
    }

    // When request type changes, save draft then reload to apply routing suggestion
    if (rt) {
      rt.addEventListener('change', function(){
        saveDraft();
        const v = this.value;
        const url = new URL(window.location.href);
        if (v) url.searchParams.set('request_type_id', v);
        else url.searchParams.delete('request_type_id');
        window.location.href = url.toString();
      });
    }
  })();
</script>
{% endif %}

{% endblock %}
