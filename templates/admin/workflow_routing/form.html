{% extends "layout.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h3 class="mb-1">{% if is_new %}➕ إضافة قاعدة توجيه{% else %}✏️ تعديل قاعدة توجيه{% endif %}</h3>
    <small class="text-muted">Routing Rule</small>
  </div>
  <a class="btn btn-outline-secondary" href="{{ url_for('admin.workflow_routing_list') }}">رجوع</a>
</div>

<form method="post" class="card shadow-sm">
  <div class="card-body">
    <div class="row g-3">

      <div class="col-md-6">
        <label class="form-label fw-bold">نوع الطلب</label>
        <select class="form-select" name="request_type_id" required>
          <option value="">— اختر —</option>
          {% for rt in request_types %}
            <option value="{{ rt.id }}" {% if r.request_type_id == rt.id %}selected{% endif %}>
              {{ rt.name_ar }} ({{ rt.code }})
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-6">
        <label class="form-label fw-bold">المسار (Template)</label>
        <select class="form-select" name="template_id" required>
          <option value="">— اختر —</option>
          {% for t in templates %}
            <option value="{{ t.id }}" {% if r.template_id == t.id %}selected{% endif %}>
              {{ t.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label fw-bold">منظمة (اختياري)</label>
        <select class="form-select" id="orgSelect" name="organization_id">
          <option value="">— بدون —</option>
          {% for o in orgs %}
            <option value="{{ o.id }}" {% if r.organization_id == o.id %}selected{% endif %}>{{ o.name_ar }}</option>
          {% endfor %}
        </select>
        <div class="form-text">إن تركتها فارغة → القاعدة تطبّق على كل المنظمات</div>
      </div>

      <div class="col-md-4">
        <label class="form-label fw-bold">إدارة (اختياري)</label>
        <select class="form-select" id="dirSelect" name="directorate_id">
          <option value="">— بدون —</option>
          {% for d in dirs %}
            <option value="{{ d.id }}" data-org="{{ d.organization_id }}" {% if r.directorate_id == d.id %}selected{% endif %}>{{ d.name_ar }}</option>
          {% endfor %}
        </select>
        <div class="form-text">يتطلب اختيار منظمة</div>
      </div>

      <div class="col-md-4">
        <label class="form-label fw-bold">دائرة (اختياري)</label>
        <select class="form-select" id="deptSelect" name="department_id">
          <option value="">— بدون —</option>
          {% for dep in depts %}
            <option value="{{ dep.id }}" data-dir="{{ dep.directorate_id }}" {% if r.department_id == dep.id %}selected{% endif %}>{{ dep.name_ar }}</option>
          {% endfor %}
        </select>
        <div class="form-text">يتطلب اختيار إدارة</div>
      </div>

      <div class="col-md-4">
        <label class="form-label fw-bold">الأولوية (رقم أصغر = أعلى)</label>
        <input class="form-control" type="number" name="priority" value="{{ r.priority if r.priority is not none else 100 }}">
      </div>

      <div class="col-md-4 d-flex align-items-end">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" name="is_active" value="1" id="is_active" {% if is_new or r.is_active %}checked{% endif %}>
          <label class="form-check-label" for="is_active">نشط</label>
        </div>
      </div>

      <div class="col-12">
        <button class="btn btn-primary">حفظ</button>
      </div>

    </div>
  </div>
</form>

<script>
(function() {
  const org = document.getElementById('orgSelect');
  const dir = document.getElementById('dirSelect');
  const dept = document.getElementById('deptSelect');

  function filterDirs() {
    const orgId = org.value;
    Array.from(dir.options).forEach(opt => {
      if (!opt.value) return;
      const ok = !orgId || opt.dataset.org === orgId;
      opt.hidden = !ok;
      if (!ok && opt.selected) opt.selected = false;
    });
  }

  function filterDepts() {
    const dirId = dir.value;
    Array.from(dept.options).forEach(opt => {
      if (!opt.value) return;
      const ok = !dirId || opt.dataset.dir === dirId;
      opt.hidden = !ok;
      if (!ok && opt.selected) opt.selected = false;
    });
  }

  org.addEventListener('change', () => {
    filterDirs();
    filterDepts();
  });

  dir.addEventListener('change', () => {
    filterDepts();
  });

  // initial
  filterDirs();
  filterDepts();
})();
</script>

{% endblock %}
