{% extends "layout.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h3 class="mb-1">ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</h3>
    <small class="text-muted">ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¬Ø©: (0..100) â†’ (0..5) Ù…Ø¹ ØªÙ‚Ø±ÙŠØ¨ 0.1.</small>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{{ url_for('admin.evaluations_index') }}">â† Ø±Ø¬ÙˆØ¹</a>
    <a class="btn btn-outline-secondary" href="{{ url_for('users.help_performance_admin_guide') }}"><i class="bi bi-book"></i> Ø¯Ù„ÙŠÙ„</a>
    <button class="btn btn-outline-primary" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
  </div>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    {% set emp = run.user.name or run.user.username or run.user.email %}
    <div class="row g-3">
      <div class="col-md-6">
        <div class="mb-1"><strong>Ø§Ù„Ù…ÙˆØ¸Ù:</strong> {{ emp }}</div>
        <div class="mb-1"><strong>Ø§Ù„ÙØªØ±Ø©:</strong>
          {% if run.period_type == 'MONTHLY' %}
            Ø´Ù‡Ø±ÙŠ {{ run.year }}-{{ '%02d'|format(run.month or 0) }}
          {% else %}
            Ø³Ù†ÙˆÙŠ {{ run.year }}
          {% endif %}
        </div>
        <div class="mb-1"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> {{ run.created_at.strftime('%Y-%m-%d %H:%M') if run.created_at else '' }}</div>
      </div>
      <div class="col-md-6 text-md-end">
        <div class="fs-5"><strong>Ø§Ù„Ù†ØªÙŠØ¬Ø©:</strong> {{ '%.1f'|format(run.score_5 or 0) }}/5</div>
        <div class="text-muted">({{ run.score_100 or 0 }}/100)</div>
      </div>
    </div>

    {% if run.summary %}
      <hr>
      <div><strong>Ù…Ù„Ø®Øµ:</strong> {{ run.summary }}</div>
    {% endif %}
  </div>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h5 class="mb-3">Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª</h5>
    {% set m = breakdown.metrics or {} %}
    <div class="row g-3">
      <div class="col-md-3"><div class="border rounded p-2"><strong>Ø§Ù„Ø­Ø±ÙƒØ§Øª</strong><div>{{ m.total_actions or 0 }}</div></div></div>
      <div class="col-md-3"><div class="border rounded p-2"><strong>Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª</strong><div>{{ m.approvals or 0 }}</div></div></div>
      <div class="col-md-3"><div class="border rounded p-2"><strong>Ø§Ù„Ø±ÙØ¶</strong><div>{{ m.rejections or 0 }}</div></div></div>
      <div class="col-md-3"><div class="border rounded p-2"><strong>Ø§Ù„Ù…Ù„ÙØ§Øª</strong><div>{{ (m.archive_uploads or 0) + (m.audit_archive_uploads or 0) }}</div></div></div>
    </div>

    <div class="row g-3 mt-1">
      <div class="col-md-4"><div class="border rounded p-2"><strong>Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„ÙˆÙ‚Øª (SLA)</strong><div>{{ (m.sla_ratio*100)|round|int if m.sla_ratio is not none else 'â€”' }}%</div></div></div>
      <div class="col-md-4"><div class="border rounded p-2"><strong>ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø±ÙØ¶</strong><div>{{ (m.rej_note_ratio*100)|round|int if m.rej_note_ratio is not none else 'â€”' }}%</div></div></div>
      <div class="col-md-4"><div class="border rounded p-2"><strong>Ø¥ØºÙ„Ø§Ù‚ Ø·Ù„Ø¨Ø§ØªÙ‡ (ÙƒÙ…Ù‚Ø¯Ù‘Ù…)</strong><div>{{ (m.requester_closure_ratio*100)|round|int if m.requester_closure_ratio is not none else 'â€”' }}%</div></div></div>
    </div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <h5 class="mb-3">ØªÙØµÙŠÙ„ Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø¯Ø±Ø¬Ø©</h5>
    {% set comps = breakdown.components or {} %}
    <div class="table-responsive">
      <table class="table table-sm table-striped align-middle">
        <thead>
          <tr>
            <th>Ø§Ù„Ù…Ø­ÙˆØ±</th>
            <th>Ø§Ù„ÙˆØ²Ù† Ø§Ù„ÙØ¹Ù„ÙŠ %</th>
            <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
            <th>Ø§Ù„Ù†Ø§ØªØ¬</th>
          </tr>
        </thead>
        <tbody>
          {% for key, c in comps.items() %}
            <tr>
              <td>{{ key }}</td>
              <td>{{ c.effective_weight or '' }}</td>
              <td>
                {% if c.value is mapping %}
                  <ul class="mb-0 small">
                    {% for k, v in c.value.items() %}
                      <li><strong>{{ k }}:</strong> {{ v }}</li>
                    {% endfor %}
                  </ul>
                {% elif c.value is sequence and c.value is not string %}
                  <span class="small">{{ c.value|join('ØŒ ') }}</span>
                {% else %}
                  {{ c.value }}
                {% endif %}
              </td>
              <td>{{ c.score_part or '' }}</td>
            </tr>
          {% else %}
            <tr><td colspan="4" class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙØµÙŠÙ„.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if breakdown.notes %}
      <hr>
      <ul class="mb-0">
        {% for n in breakdown.notes %}
          <li>{{ n }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  </div>
</div>

{% endblock %}
