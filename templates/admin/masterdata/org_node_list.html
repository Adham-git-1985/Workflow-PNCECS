{% extends "layout.html" %}
{% block content %}

{% set _q = q or '' %}
{% set _type_id = type_id or '' %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h3 class="mb-1">๐ณ ุนูุงุตุฑ ุงููููููุฉ (Dynamic)</h3>
    <small class="text-muted">ุฅุฏุงุฑุฉ ุนูุงุตุฑ ุงููููููุฉ ูุงุฎุชูุงุฑ ุงูุฃุจ ุนุจุฑ ุดุฌุฑุฉ</small>
    <div class="d-flex flex-wrap gap-2 align-items-center small mt-1">
      <span class="text-muted">ุขุฎุฑ ูุฒุงููุฉ: <b>{{ last_sync or 'โ' }}</b></span>
      <span class="badge {% if legacy_locked %}bg-danger{% else %}bg-success{% endif %}">
        {% if legacy_locked %}๐ ุงููููููุฉ ุงูุซุงุจุชุฉ ููููุฉ{% else %}๐ ุงููููููุฉ ุงูุซุงุจุชุฉ ุบูุฑ ููููุฉ{% endif %}
      </span>
    </div>
    {% if legacy_locked %}
      <div class="alert alert-warning small mt-2 mb-0">
        ุงููููููุฉ ุงูุซุงุจุชุฉ ููููุฉ (ูุฑุงุกุฉ ููุท). ุฅูุดุงุก/ุชุนุฏูู ุงูุนูุงุตุฑ ููุง (Dynamic) ูุง ูุชุฃุซุฑ ุจุงูููู.
      </div>
    {% endif %}
  </div>
  <div class="d-flex gap-2">
    <button class="btn btn-outline-secondary no-print" type="button" onclick="wfPrintSmart('#mdOrgNodesPrint')">๐จ๏ธ ุทุจุงุนุฉ</button>
    <a class="btn btn-outline-secondary" target="_blank" href="{{ url_for('users.help_org_structure_dynamic_guide') }}">โ ุฏููู ุงููููููุฉ</a>
    <a class="btn btn-outline-secondary" href="{{ url_for('masterdata.org_node_types_list') }}">๐งฑ ุฃููุงุน ุงููููููุฉ</a>
    <a class="btn btn-primary" href="{{ url_for('masterdata.org_nodes_new') }}">โ ุฅุถุงูุฉ ุนูุตุฑ</a>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">

    <form method="get" class="mb-3">
      <div class="row g-2">
        <div class="col-md-4">
          <input class="form-control" type="text" name="q" value="{{ _q }}" placeholder="ุงุจุญุซ ุจุงูุงุณู ุฃู ุงูููุฏโฆ">
        </div>
        <div class="col-md-3">
          <select class="form-select" name="type_id">
            <option value="">โ ูู ุงูุฃููุงุน โ</option>
            {% for t in types %}
              <option value="{{ t.id }}" {% if _type_id|int == t.id %}selected{% endif %}>{{ t.name_ar }} ({{ t.code }})</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-5 d-flex gap-2">
          <button class="btn btn-outline-secondary" type="submit">ุจุญุซ</button>
          <a class="btn btn-outline-danger" href="{{ request.path }}">ูุณุญ</a>
          <a class="btn btn-outline-primary" href="{{ url_for('masterdata.org_nodes_new', type_id=_type_id) }}">โ ุฅุถุงูุฉ ูููุณ ุงูููุน</a>
        </div>
      </div>
    </form>

    {% if items %}
      <div id="mdOrgNodesPrint" class="table-responsive">
        <table class="table table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>ุงูููุน</th>
              <th>ุงูุงุณู (AR)</th>
              <th>ุงูุฃุจ</th>
              <th>Code</th>
              <th>ุชุฑุชูุจ</th>
              <th>ูุดุท</th>
              <th class="text-end">ุฅุฌุฑุงุกุงุช</th>
            </tr>
          </thead>
          <tbody>
            {% for n in items %}
              <tr>
                <td>{{ n.id }}</td>
                <td>
                  {% if n.type %}
                    <span class="badge bg-primary-subtle text-primary border">{{ n.type.name_ar }}</span>
                    <small class="text-muted">({{ n.type.code }})</small>
                  {% else %}-{% endif %}
                </td>
                <td>{{ n.name_ar }}</td>
                <td>{% if n.parent %}{{ n.parent.name_ar }}{% else %}<span class="text-muted">โ</span>{% endif %}</td>
                <td>{{ n.code or '-' }}</td>
                <td>{{ n.sort_order or 0 }}</td>
                <td>{% if n.is_active %}<span class="badge bg-success">ูุนู</span>{% else %}<span class="badge bg-secondary">ูุง</span>{% endif %}</td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-primary" href="{{ url_for('masterdata.org_nodes_edit', node_id=n.id) }}">โ๏ธ ุชุนุฏูู</a>
                  {% if current_user.has_perm('MASTERDATA_DELETE') %}
                  <form method="post" action="{{ url_for('masterdata.org_nodes_delete', node_id=n.id) }}" class="d-inline" onsubmit="return confirm('ูู ุฃูุช ูุชุฃูุฏุ ุฅุฐุง ูุงู ููุงู ุฃุจูุงุก ุณูุชู ุชุนุทูู ุงูุนูุตุฑ ุจุฏูุงู ูู ุญุฐูู.');">
                    <button class="btn btn-sm btn-outline-danger">๐๏ธ ุญุฐู</button>
                  </form>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-light text-center text-muted mb-0">ูุง ุชูุฌุฏ ุจูุงูุงุช</div>
    {% endif %}

  </div>
</div>

{% endblock %}
