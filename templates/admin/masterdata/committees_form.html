{% extends "layout.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h3 class="mb-1">{% if c %}âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ù„Ø¬Ù†Ø©{% else %}â• Ù„Ø¬Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø©{% endif %}</h3>
    <small class="text-muted">Ø§Ù„Ù„Ø¬Ù†Ø© Ù…ØµØ¯Ø± ØªÙˆØ¬ÙŠÙ‡ Ù…Ø³ØªÙ‚Ù„ ÙŠÙ…ÙƒÙ† Ø±Ø¨Ø·Ù‡ Ø¨Ø®Ø·ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª (Approver Kind = COMMITTEE)</small>
  </div>
  <a class="btn btn-outline-secondary" href="{{ url_for('masterdata.committees_list') }}">Ø±Ø¬ÙˆØ¹</a>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <form method="post">
      <div class="row g-3">

        <div class="col-md-4">
          <label class="form-label fw-bold">Ø§Ù„Ø§Ø³Ù… (AR) <span class="text-danger">*</span></label>
          <input class="form-control" name="name_ar" value="{{ c.name_ar if c else '' }}" required>
        </div>

        <div class="col-md-4">
          <label class="form-label fw-bold">Name (EN)</label>
          <input class="form-control" name="name_en" value="{{ c.name_en if c else '' }}">
        </div>

        <div class="col-md-4">
          <label class="form-label fw-bold">Code (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input class="form-control" name="code" value="{{ c.code if c else '' }}" placeholder="Ù…Ø«Ø§Ù„: FIN_COMMITTEE">
        </div>

        <div class="col-md-3">
          <div class="form-check mt-4">
            <input class="form-check-input" type="checkbox" name="is_active" value="1" id="is_active" {% if not c or c.is_active %}checked{% endif %}>
            <label class="form-check-label" for="is_active">Active</label>
          </div>
        </div>

        <div class="col-12">
          <label class="form-label fw-bold">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea class="form-control" name="notes" rows="3" placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ±â€¦">{{ c.notes if c and c.notes else '' }}</textarea>
        </div>

        <div class="col-12">
          <button class="btn btn-primary">Ø­ÙØ¸</button>
        </div>

      </div>
    </form>
  </div>
</div>

{% if c %}

<div class="card shadow-sm">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div>
        <h5 class="mb-0">ğŸ‘¤ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù„Ø¬Ù†Ø©</h5>
        <small class="text-muted">ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© User Ù…Ø­Ø¯Ø¯ Ø£Ùˆ Role ÙƒØ§Ù…Ù„. (Chair/Secretary/Member Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</small>
      </div>
      <div class="d-flex gap-2 align-items-center flex-wrap">
        <a class="btn btn-sm btn-outline-success" href="{{ url_for('masterdata.committee_members_export_excel', committee_id=c.id) }}">â¬‡ï¸ Excel</a>
        <a class="btn btn-sm btn-outline-primary" href="{{ url_for('masterdata.committee_members_import', committee_id=c.id) }}">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel</a>
        <span class="badge bg-light text-dark border">#{{ c.id }}</span>
      </div>
    </div>

    <form method="post" action="{{ url_for('masterdata.committee_member_add', committee_id=c.id) }}" class="border rounded p-3 mb-3">
      <div class="row g-3 align-items-end">

        <div class="col-md-2">
          <label class="form-label fw-bold">Kind</label>
          <select class="form-select" name="kind" id="member_kind">
            <option value="USER" selected>USER</option>
            <option value="ROLE">ROLE</option>
          </select>
        </div>

        <div class="col-md-4" id="member_box_user">
          <label class="form-label fw-bold">User</label>
          <select class="form-select" name="user_id">
            <option value="">â€” Ø§Ø®ØªØ± â€”</option>
            {% for u in users %}
              <option value="{{ u.id }}">{{ u.email }}{% if u.role %} ({{ u.role }}){% endif %}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-4" id="member_box_role" style="display:none;">
          <label class="form-label fw-bold">Role</label>
          <select class="form-select" name="role">
            <option value="">â€” Ø§Ø®ØªØ± â€”</option>
            {% for r in roles %}
              <option value="{{ r.code }}">{{ r.code }}{% if r.name_ar %} â€” {{ r.name_ar }}{% endif %}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label fw-bold">Ø¯ÙˆØ± Ø§Ù„Ø¹Ø¶Ùˆ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„Ø¬Ù†Ø©</label>
          <select class="form-select" name="member_role">
            <option value="MEMBER" selected>Ø¹Ø¶Ùˆ</option>
            <option value="CHAIR">Ø±Ø¦ÙŠØ³</option>
            <option value="SECRETARY">Ù…Ù‚Ø±Ø±</option>
          </select>
          <div class="form-text">Ù…Ø³Ù…ÙˆØ­ Ø±Ø¦ÙŠØ³ ÙˆØ§Ø­Ø¯ ÙˆÙ…Ù‚Ø±Ø± ÙˆØ§Ø­Ø¯ (Ù†Ø´Ø·) Ù„ÙƒÙ„ Ù„Ø¬Ù†Ø©.</div>
        </div>

        <div class="col-md-2">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="is_active" value="1" id="m_active" checked>
            <label class="form-check-label" for="m_active">Active</label>
          </div>
        </div>

        <div class="col-md-2">
          <button class="btn btn-success w-100">Ø¥Ø¶Ø§ÙØ©</button>
        </div>

      </div>
    </form>

    {% if members and members|length > 0 %}
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Kind</th>
              <th>Ø§Ù„Ø¹Ø¶Ùˆ</th>
              <th>Role Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„Ø¬Ù†Ø©</th>
              <th>Active</th>
              <th class="text-end">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody>
            {% for m in members %}
              <tr>
                <td>{{ m.id }}</td>
                <td>
                  {% if (m.kind or '')|upper == 'USER' %}
                    <span class="badge bg-primary">USER</span>
                  {% else %}
                    <span class="badge bg-secondary">ROLE</span>
                  {% endif %}
                </td>
                <td>
                  {% if (m.kind or '')|upper == 'USER' %}
                    {{ m.user.email if m.user else ('User #' ~ m.user_id) }}
                  {% else %}
                    <code>{{ m.role }}</code>
                  {% endif %}
                </td>
                <td>
                  <form method="post" action="{{ url_for('masterdata.committee_member_update', member_id=m.id) }}" class="d-flex gap-2 align-items-center">
                    <select class="form-select form-select-sm" name="member_role" style="max-width: 160px;">
                      <option value="MEMBER" {% if (m.member_role or 'MEMBER')|upper == 'MEMBER' %}selected{% endif %}>Ø¹Ø¶Ùˆ</option>
                      <option value="CHAIR" {% if (m.member_role or '')|upper == 'CHAIR' %}selected{% endif %}>Ø±Ø¦ÙŠØ³</option>
                      <option value="SECRETARY" {% if (m.member_role or '')|upper == 'SECRETARY' %}selected{% endif %}>Ù…Ù‚Ø±Ø±</option>
                    </select>
                    <div class="form-check m-0">
                      <input class="form-check-input" type="checkbox" name="is_active" value="1" id="act_{{ m.id }}" {% if m.is_active %}checked{% endif %}>
                      <label class="form-check-label" for="act_{{ m.id }}">Ù†Ø´Ø·</label>
                    </div>
                    <button class="btn btn-sm btn-outline-primary">ØªØ­Ø¯ÙŠØ«</button>
                  </form>
                </td>
                <td>
                  {% if m.is_active %}
                    <span class="badge bg-success">Yes</span>
                  {% else %}
                    <span class="badge bg-secondary">No</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  <form method="post" action="{{ url_for('masterdata.committee_member_delete', member_id=m.id) }}"
                        onsubmit="return confirm('Ø­Ø°Ù Ø§Ù„Ø¹Ø¶ÙˆØŸ');" style="display:inline-block;">
                    <button class="btn btn-sm btn-outline-danger">Ø­Ø°Ù</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø¨Ø¹Ø¯. Ø£Ø¶Ù Ø£Ø¹Ø¶Ø§Ø¡ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰.</div>
    {% endif %}

  </div>
</div>

<script>
(function() {
  const kind = document.getElementById('member_kind');
  const boxUser = document.getElementById('member_box_user');
  const boxRole = document.getElementById('member_box_role');

  function toggle() {
    const v = (kind.value || 'USER').toUpperCase();
    boxUser.style.display = (v === 'USER') ? 'block' : 'none';
    boxRole.style.display = (v === 'ROLE') ? 'block' : 'none';

    const userSel = boxUser.querySelector('select[name="user_id"]');
    const roleSel = boxRole.querySelector('select[name="role"]');
    userSel.disabled = (v !== 'USER');
    roleSel.disabled = (v !== 'ROLE');
    if (v !== 'USER') userSel.value = '';
    if (v !== 'ROLE') roleSel.value = '';
  }

  kind.addEventListener('change', toggle);
  toggle();
})();
</script>

{% endif %}

{% endblock %}
