{# Partial: Parent tree picker (HTML snippet) #}

{% set _selected = selected_parent_id if selected_parent_id is defined else (n.parent_id if n else None) %}
{% set _root_allowed = (root_allowed if root_allowed is defined else True) %}
<style>
  .org-tree-wrap { border: 1px solid rgba(0,0,0,.08); border-radius: 10px; padding: 12px; background: #fff; }
  .org-tree ul { list-style: none; margin: 0; padding: 0; }
  .org-tree .org-ul { padding-right: 1.25rem; }
  .org-tree .org-li { position: relative; margin: 6px 0; }
  .org-tree .org-li::before { content: ''; position: absolute; right: .35rem; top: 0; bottom: 0; width: 1px; background: rgba(0,0,0,.08); }
  .org-tree .org-li.level-0::before { display: none; }
  .org-tree details { border-right: 3px solid rgba(13,110,253,.18); padding-right: .75rem; }
  .org-tree .org-leaf { border-right: 3px solid rgba(25,135,84,.18); padding-right: .75rem; padding-top: .25rem; padding-bottom: .25rem; }
  .org-tree summary { cursor: pointer; display: flex; flex-wrap: wrap; align-items: center; gap: .35rem .5rem; padding: .25rem .25rem; }
  .org-tree summary::-webkit-details-marker { display: none; }
  .org-tree .org-title { font-weight: 600; }
  .org-tree .org-meta { color: #6c757d; font-size: .85rem; }
  .org-tree code { font-size: .85em; }
</style>


<div data-root-allowed="{{ 1 if _root_allowed else 0 }}"></div>

<div class="d-flex flex-wrap gap-2 align-items-center mb-2">
  <input class="form-control form-control-sm" id="orgTreeSearch" placeholder="ابحث داخل الشجرة…" style="max-width: 260px;">
  <button class="btn btn-sm btn-outline-secondary" type="button" id="btnExpandAll">توسيع</button>
  <button class="btn btn-sm btn-outline-secondary" type="button" id="btnCollapseAll">طيّ</button>
  {% if selected_type %}
    {% set ap = selected_type.allowed_parent_type_ids() %}
    {% if ap and ap|length > 0 %}
      <span class="badge bg-info-subtle text-info border">مسموح: {{ ap|length }} نوع أب</span>
    {% else %}
      <span class="badge bg-warning-subtle text-warning border">جذري فقط</span>
    {% endif %}
  {% else %}
    <span class="badge bg-secondary-subtle text-secondary border">اختر النوع أولاً</span>
  {% endif %}
</div>

{% if tree and tree|length > 0 %}
  <div class="org-tree-wrap org-tree" id="orgParentTree" style="max-height: 60vh; overflow: auto;">

    {% macro render_node(node, level=0) %}
      <li class="org-li level-{{ level }}" data-node-text="{{ (node.type_name ~ ' ' ~ node.name_ar ~ ' ' ~ (node.code or '') )|lower }}">
        {% if node.children and node.children|length > 0 %}
          <details class="org-details" {% if level < 1 %}open{% endif %}>
            <summary class="d-flex align-items-center gap-2 flex-wrap">
              <span class="badge bg-primary-subtle text-primary border">{{ node.type_name or node.type_code }}</span>
              <span class="org-title">{{ node.name_ar }}</span>
              {% if node.code %}<span class="org-meta">(<code>{{ node.code }}</code>)</span>{% endif %}

              {% if _selected and _selected == node.id %}
                <span class="badge bg-success-subtle text-success border">مختار</span>
              {% endif %}

              <span class="ms-auto"></span>

              {% if node.disabled %}
                <button class="btn btn-sm btn-outline-secondary" type="button" disabled>غير متاح</button>
              {% elif node.eligible %}
                <button class="btn btn-sm btn-outline-primary pick-parent" type="button" data-id="{{ node.id }}" data-label="{{ node.label|e }}">اختيار</button>
              {% else %}
                <button class="btn btn-sm btn-outline-secondary" type="button" disabled>غير مسموح</button>
              {% endif %}

            </summary>
            <ul class="org-ul">
              {% for ch in node.children %}
                {{ render_node(ch, level + 1) }}
              {% endfor %}
            </ul>
          </details>
        {% else %}
          <div class="org-leaf d-flex align-items-center gap-2 flex-wrap">
            <span class="badge bg-success-subtle text-success border">{{ node.type_name or node.type_code }}</span>
            <span class="org-title">{{ node.name_ar }}</span>
            {% if node.code %}<span class="org-meta">(<code>{{ node.code }}</code>)</span>{% endif %}

            {% if _selected and _selected == node.id %}
              <span class="badge bg-success-subtle text-success border">مختار</span>
            {% endif %}

            <span class="ms-auto"></span>

            {% if node.disabled %}
              <button class="btn btn-sm btn-outline-secondary" type="button" disabled>غير متاح</button>
            {% elif node.eligible %}
              <button class="btn btn-sm btn-outline-primary pick-parent" type="button" data-id="{{ node.id }}" data-label="{{ node.label|e }}">اختيار</button>
            {% else %}
              <button class="btn btn-sm btn-outline-secondary" type="button" disabled>غير مسموح</button>
            {% endif %}
          </div>
        {% endif %}
      </li>
    {% endmacro %}

    <ul class="org-ul" id="orgParentTreeList">
      {% for node in tree %}
        {{ render_node(node, 0) }}
      {% endfor %}
    </ul>
  </div>

{% else %}
  <div class="alert alert-light text-center text-muted mb-0">لا توجد عناصر لعرضها في الشجرة.</div>
{% endif %}
