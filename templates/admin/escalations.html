{% extends "layout.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h3 class="mb-1">๐จ ุงูุชุตุนูุฏุงุช</h3>
        <small class="text-muted">ุณุฌู ุฌููุน ุงูุชุตุนูุฏุงุช (ุงููุณุชุฎุฏูุฉ + ุงููุธุงู) + ุงูุทูุจุงุช ุงููุชุฌุงูุฒุฉ ูุฏุฉ SLA</small>
    </div>
    <div>
        <a class="btn btn-outline-success"
           href="{{ url_for('admin.escalations_export_excel') }}">
            <i class="bi bi-file-earmark-excel"></i>
            ุชุตุฏูุฑ Excel
        </a>
    </div>
</div>

{# ========================= #}
{# Escalation Log (manual/system) #}
{# ========================= #}
<div class="card shadow-sm mb-4">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <div>
            <strong>๐ ุณุฌู ุงูุชุตุนูุฏุงุช</strong>
            <div class="text-muted small">ูุนุฑุถ ุขุฎุฑ 500 ุชุตุนูุฏ (ููุนุฑุถ). ุงูุชุตุฏูุฑ ูุดูู ุญุชู 10,000 (ูููู ุชุบููุฑ limit).</div>
        </div>
        <div class="text-muted small">ุนุฏุฏ ุงููุนุฑูุถ: {{ escalations|length }}</div>
    </div>
    <div class="card-body p-0">
        {% if escalations %}
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>ุงูุทูุจ</th>
                        <th class="text-center">ุงูุฎุทูุฉ</th>
                        <th>ุงูููุน</th>
                        <th>ูู</th>
                        <th>ุฅูู</th>
                        <th class="text-center">ุงูุชุงุฑูุฎ</th>
                        <th>ุชูุงุตูู</th>
                    </tr>
                </thead>
                <tbody>
                {% for e in escalations %}
                    <tr>
                        <td>{{ e.id }}</td>
                        <td>
                            <a href="{{ url_for('workflow.view_request', request_id=e.request_id) }}">
                                #{{ e.request_id }}
                            </a>
                            <div class="text-muted small">
                                <a class="text-decoration-none" href="{{ url_for('workflow.request_escalations', request_id=e.request_id, step=e.step_order) }}">
                                    ุนุฑุถ ูู ุชุตุนูุฏุงุช ุงูุทูุจ
                                </a>
                            </div>
                        </td>
                        <td class="text-center">{{ e.step_order or 'โ' }}</td>
                        <td><span class="badge bg-warning text-dark">{{ e.category|esc_category_ar }}</span></td>
                        <td>{{ e.from_user.email if e.from_user else 'System' }}</td>
                        <td>{{ e.to_user.email if e.to_user else 'โ' }}</td>
                        <td class="text-center">{{ e.created_at.strftime('%Y-%m-%d %H:%M') if e.created_at else '' }}</td>
                        <td style="max-width: 420px">
                            <div class="small">{{ (e.description or '')[:180] }}{% if e.description and e.description|length > 180 %}โฆ{% endif %}</div>
                            {% if e.targets %}
                                <div class="text-muted small mt-1">Targets: {{ e.targets }}</div>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="p-4 text-center text-muted">
            ูุง ุชูุฌุฏ ุชุตุนูุฏุงุช ูุณุฌูุฉ ุญุงููุงู
        </div>
        {% endif %}
    </div>
</div>


{# ========================= #}
{# SLA Overdue Requests (legacy) #}
{# ========================= #}
<div class="card border-danger shadow-sm">
    <div class="card-header bg-light">
        <strong>โฑ๏ธ ุทูุจุงุช ูุชุฌุงูุฒุฉ ูุฏุฉ SLA (Legacy)</strong>
        <div class="text-muted small">ุงูุทูุจุงุช ุงูุชู ุชุฌุงูุฒุช ูุฏุฉ SLA + ูุฏุฉ ุงูุชุตุนูุฏ ุงููุนุฑูุฉ ูู ุงูุฅุนุฏุงุฏุงุช</div>
    </div>
    <div class="card-body p-0">

        {% if requests %}
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>ุงูุนููุงู</th>
                        <th>ุงูููููู ุงูุญุงูู</th>
                        <th class="text-center">ุชุงุฑูุฎ ุงูุฅูุดุงุก</th>
                        <th class="text-center">ุงูุญุงูุฉ</th>
                    </tr>
                </thead>
                <tbody>
                {% for req in requests %}
                    <tr class="table-danger">
                        <td>{{ req.id }}</td>
                        <td>
                            <strong>{{ req.title }}</strong>
                            <div class="text-muted small">
                                <a href="{{ url_for('workflow.view_request', request_id=req.id) }}">ูุชุญ ุงูุทูุจ</a>
                            </div>
                        </td>
                        <td>
                            {{ req.current_assignee.name if req.current_assignee else "โ" }}
                        </td>
                        <td class="text-center">
                            {{ req.created_at.strftime("%Y-%m-%d") if req.created_at else '' }}
                        </td>
                        <td class="text-center">
                            <span class="badge bg-danger">Escalated</span>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="p-4 text-center text-muted">
            ูุง ุชูุฌุฏ ุทูุจุงุช ูุชุฌุงูุฒุฉ SLA ุญุงููุงู
        </div>
        {% endif %}

    </div>
</div>

{% endblock %}
