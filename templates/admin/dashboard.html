{% extends "layout.html" %}

{% block content %}
<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Admin Dashboard</h3>
        <small class="text-muted">
            Last refresh: {{ now.strftime("%Y-%m-%d %H:%M") }}
        </small>
    </div>

    <!-- Counters -->
    <div class="row g-3">

        <div class="col-md-4">
            <div class="card border-primary shadow-sm text-center cursor-pointer">
                <div class="card-body">
                    <h6 class="text-muted" title="All requests in system">Total Requests</h6>
                    <h2 class="text-primary">{{ counters.total }}</h2>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card border-success shadow-sm text-center cursor-pointer">
                <div class="card-body">
                    <h6 class="text-muted">Approved</h6>
                    <h2 class="text-success">{{ counters.approved }}</h2>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card border-danger shadow-sm text-center cursor-pointer">
                <div class="card-body">
                    <h6 class="text-muted">Rejected</h6>
                    <h2 class="text-danger">{{ counters.rejected }}</h2>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card border-warning shadow-sm text-center cursor-pointer">
                <div class="card-body">
                    <h6 class="text-muted">In Progress</h6>
                    <h2 class="text-warning">{{ counters.in_progress }}</h2>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card border-secondary shadow-sm text-center cursor-pointer">
                <div class="card-body">
                    <h6 class="text-muted">Drafts</h6>
                    <h2 class="text-secondary">{{ counters.drafts }}</h2>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card border-info shadow-sm text-center cursor-pointer">
                <div class="card-body">
                    <h6 class="text-muted">Delegated</h6>
                    <h2 class="text-info">{{ counters.delegated }}</h2>
                </div>
            </div>
        </div>

    </div>

    <!-- Chart -->
    <div class="row mt-5">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="mb-3">Requests by Status</h5>
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- SLA Settings -->
    <div class="card shadow-sm my-4">
        <div class="card-body">
            <form method="post"
                  action="{{ url_for('admin.update_sla') }}"
                  class="row g-2 align-items-center">

                <div class="col-auto">
                    <label class="col-form-label fw-bold">
                        SLA (days):
                    </label>
                </div>

                <div class="col-auto">
                    <input type="number"
                           name="sla_days"
                           class="form-control form-control-sm"
                           min="1"
                           value="{{ sla_days }}"
                           required>
                </div>

                <div class="col-auto">
                    <button type="submit"
                            class="btn btn-sm btn-outline-primary">
                        Update
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Overdue Requests -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-danger shadow-sm">
                <div class="card-body">
                    <h5 class="mb-3 text-danger">
                        Overdue Requests (SLA {{ sla_days }} days)
                    </h5>

                    {% if aging_requests %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Title</th>
                                    <th>Status</th>
                                    <th>Created At</th>
                                    <th>Days Open</th>
                                    <th>Escalated</th>
                                    <th>Current Role</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for req in aging_requests %}
                                <tr class="{% if req.is_escalated %}table-danger{% endif %}">
                                    <td>{{ req.id }}</td>
                                    <td>{{ req.title }}</td>
                                    <td>
                                        <span class="badge
                                            {% if req.status == 'APPROVED' %}bg-success
                                            {% elif req.status == 'REJECTED' %}bg-danger
                                            {% elif req.status == 'DRAFT' %}bg-secondary
                                            {% else %}bg-warning text-dark{% endif %}">
                                            {{ req.status }}
                                        </span>
                                    </td>
                                    <td>{{ req.created_at.strftime("%Y-%m-%d") }}</td>
                                    <td>{{ (now - req.created_at).days }}</td>
                                    <td>
                                        {% if req.is_escalated %}
                                            <span class="badge bg-danger">YES</span>
                                        {% else %}
                                            <span class="badge bg-secondary">NO</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-info">
                                            {{ req.current_role }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-success mb-0">
                        ðŸŽ‰ No overdue requests.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const ctx = document.getElementById('statusChart');

new Chart(ctx, {
    type: 'pie',
    data: {
        labels: ['Approved', 'Rejected', 'In Progress', 'Drafts'],
        datasets: [{
            data: [
                {{ counters.approved }},
                {{ counters.rejected }},
                {{ counters.in_progress }},
                {{ counters.drafts }}
            ],
            backgroundColor: [
                '#198754',
                '#dc3545',
                '#ffc107',
                '#6c757d'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
</script>

{% endblock %}
