{% extends "layout.html" %}
{% block content %}

<div class="container mt-4">
    <h3>My Archived Files</h3>

    {% if files %}
    <form method="get" class="row g-2 mb-3">
    <div class="col-md-10">
        <input type="text"
               name="q"
               value="{{ q }}"
               class="form-control"
               placeholder="Search by file name or description">
    </div>
    <div class="col-md-2">
        <button class="btn btn-secondary w-100">
            Search
        </button>
    </div>
    </form>


    <table class="table table-bordered table-hover mt-3">
        <thead class="table-light">
        <tr>
            <th>#</th>
            <th>File Name</th>
            <th>Description</th>
            <th>Uploaded At</th>
            <th>Size (KB)</th>

            {% if current_user.has_role("ADMIN") %}
                <th>Status</th>
            {% endif %}

            <th>Action</th>
        </tr>
        </thead>

        <tbody>
            {% for f in files %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>{{ f.original_name }}</td>
                <td>{{ f.description or "-" }}</td>
                <td>{{ f.upload_date.strftime("%Y-%m-%d %H:%M") }}</td>
                <td>{{ (f.file_size / 1024) | round(1) }}</td>
                {% if current_user.has_role("ADMIN") %}
                <td>
                    {% if f.is_deleted %}
                        <span class="badge bg-danger">Deleted</span>
                    {% else %}
                        <span class="badge bg-success">Active</span>
                    {% endif %}
                </td>
                {% endif %}
                <td>
                   {% if not f.is_deleted %}
                    <a class="btn btn-sm btn-primary"
                       href="{{ url_for('archive.download_file', file_id=f.id) }}">
                        Download
                    </a>
                    {% else %}
                    <span class="text-muted">Unavailable</span>
                    {% endif %}

                   {% if not f.is_deleted %}
                    <a class="btn btn-sm btn-warning"
                       href="{{ url_for('archive.share_file', file_id=f.id) }}">
                        Share
                    </a>
                    {% endif %}
                </td>

            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <div class="alert alert-info mt-3">
            You have not uploaded any files yet.
        </div>
    {% endif %}
</div>
{% if current_user.has_role("ADMIN") %}
<form method="POST"
      action="{{ url_for('archive.delete_file', file_id=f.id) }}"
      style="display:inline"
      onsubmit="return confirm('Are you sure you want to delete this file?');">

    <button class="btn btn-sm btn-danger">
        Delete
    </button>
</form>
{% endif %}

{% if current_user.has_role("ADMIN") and not f.is_deleted %}
<form method="POST"
      action="{{ url_for('archive.delete_file', file_id=f.id) }}"
      style="display:inline"
      onsubmit="return confirm('Are you sure?');">

    <button class="btn btn-sm btn-danger">
        Delete
    </button>
</form>
{% endif %}

{% endblock %}
