{% extends "layout.html" %}
{% block title %}ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù„Ù{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/archive.css') }}?v=20260122">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="container archive-wrap p-3 p-lg-4">

    <!-- HERO -->
    <div class="archive-hero mb-4">
      <div class="hero-inner d-flex flex-column flex-lg-row justify-content-between align-items-start gap-3">
        <div>
          <h3 class="archive-title mb-1">
            <i class="bi bi-file-earmark-text"></i>
            {{ file.original_name }}
          </h3>

          <div class="archive-submeta">
            ğŸ“ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©: {{ file.department_id or "â€”" }}
            Â· ğŸ‘¤ {{ (file.owner.full_name if file.owner and file.owner.full_name else (file.owner.email if file.owner else "System")) }}
            Â· ğŸ•’ {{ file.upload_date.strftime("%Y-%m-%d %H:%M") if file.upload_date else "â€”" }}
          </div>

          <div class="chips mt-3">
            {% if file.is_deleted %}
              <span class="chip danger"><span class="dot"></span>Deleted</span>
            {% else %}
              <span class="chip success"><span class="dot"></span>Active</span>
            {% endif %}

            {% if file.is_signed %}
              <span class="chip success"><span class="dot"></span>Signed</span>
            {% else %}
              <span class="chip"><span class="dot"></span>Unsigned</span>
            {% endif %}

            {% if file.visibility %}
              <span class="chip info"><span class="dot"></span>{{ file.visibility }}</span>
            {% endif %}

            {% if shared_with %}
              <span class="chip info"><span class="dot"></span>ğŸ¤ Shared: <strong>{{ shared_with|length }}</strong></span>
            {% endif %}
          </div>
        </div>

        <div class="archive-actions d-flex gap-2 flex-wrap align-items-start">
          <a href="{{ url_for('archive.download_file', file_id=file.id) }}" class="btn btn-outline-primary btn-neo">
            â¬‡ï¸ ØªØ­Ù…ÙŠÙ„
          </a>

          {% if can_edit or can_manage %}
          <a href="{{ url_for('archive.share_file', file_id=file.id) }}" class="btn btn-outline-warning btn-neo">
            ğŸ¤ Ù…Ø´Ø§Ø±ÙƒØ©
          </a>
          {% endif %}

          {% if not file.is_deleted and (current_user.has_role('ADMIN') or file.owner_id == current_user.id) %}
            <form method="post"
                  action="{{ url_for('archive.delete_file', file_id=file.id) }}"
                  onsubmit="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ù„ÙØŸ');">
              <button class="btn btn-outline-danger btn-neo">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            </form>
          {% endif %}

          {% if current_user.has_role('ADMIN') and not file.is_deleted and not file.is_signed %}
            <form method="post" action="{{ url_for('archive.sign_pdf', file_id=file.id) }}">
              <button class="btn btn-outline-success btn-neo">âœï¸ ØªÙˆÙ‚ÙŠØ¹</button>
            </form>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="row g-3">

      <!-- PREVIEW -->
      <div class="col-lg-8">
        <div class="archive-card">
          <div class="card-header">
            <strong>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù„Ù</strong>
          </div>

          <div class="card-body p-0">
            {% if file.file_type == "PDF" %}
              <iframe src="{{ url_for('archive.preview_file', file_id=file.id) }}"
                      width="100%" height="650" style="border:none;"></iframe>

            {% elif file.file_type in ["JPG", "PNG"] %}
              <img src="{{ url_for('archive.preview_file', file_id=file.id) }}"
                   class="img-fluid rounded">

            {% else %}
              <div class="text-center py-5">
                <i class="bi bi-file-earmark-text fs-1"></i>
                <p class="mt-3">Ù„Ø§ ØªØªÙˆÙØ± Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹</p>
                <a href="{{ url_for('archive.download_file', file_id=file.id) }}" class="btn btn-primary btn-neo">
                  â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
                </a>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- META + SHARED -->
      <div class="col-lg-4">
        <div class="archive-card mb-3">
          <div class="card-header">
            <strong>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù</strong>
          </div>

          <div class="card-body">
            <table class="table table-sm table-borderless mb-0">
              <tr>
                <th style="width: 40%;">Ø§Ù„ÙˆØµÙ</th>
                <td>{{ file.description or "â€”" }}</td>
              </tr>
              <tr>
                <th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù</th>
                <td>{{ file.file_type or "â€”" }}</td>
              </tr>
              <tr>
                <th>Ø§Ù„Ø­Ø¬Ù… (KB)</th>
                <td>{{ (file.file_size / 1024) | round(1) if file.file_size else "â€”" }}</td>
              </tr>
              <tr>
                <th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
                <td>{{ file.visibility or "â€”" }}</td>
              </tr>
            </table>
          </div>
        </div>

        {% if shared_with %}
        <div class="archive-card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>ğŸ¤ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª</strong>
            <span class="badge bg-info">{{ shared_with|length }}</span>
          </div>

          <div class="card-body p-2">
            <ul class="list-group list-group-flush">
              {% for p in shared_with %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <strong>{{ p.user.email if p.user else ("User #" ~ p.user_id) }}</strong>
                  <div class="text-muted small">
                    Ø¨ÙˆØ§Ø³Ø·Ø© {{ p.delegated_by }}</div>
                </div>

                {% if can_edit or can_manage or p.delegated_by == current_user.id %}
                <form method="post"
                      action="{{ url_for('archive.unshare_file', permission_id=p.id) }}"
                      onsubmit="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©ØŸ');">
                  <button class="btn btn-sm btn-outline-danger btn-neo">âŒ</button>
                </form>
                {% endif %}
              </li>
              {% endfor %}
            </ul>
          </div>
        </div>
        {% endif %}

      </div>
    </div>

    <!-- AUDIT -->
    <div class="archive-card mt-3">
      <div class="card-header">
        <strong>Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</strong>
      </div>

      <div class="card-body">
        {% if audit_logs and audit_logs.total > 0 %}
          <ul class="timeline">
            {% for log in audit_logs.items %}
              <li>
                <strong>{{ log.action }}</strong>
                {% if log.note %}
                  <div class="text-muted small">{{ log.note }}</div>
                {% endif %}
                <div class="text-muted small">
                  {{ log.created_at.strftime("%Y-%m-%d %H:%M") }}
                  â€”
                  {{ (log.user.full_name if log.user and log.user.full_name else (log.user.email if log.user else "System")) }}
                </div>
              </li>
            {% endfor %}
          </ul>

          <div class="soft-divider"></div>

          <nav class="mt-2">
            <ul class="pagination justify-content-center mb-0">
              {% if audit_logs.has_prev %}
              <li class="page-item">
                <a class="page-link"
                   href="{{ url_for('archive.file_details', file_id=file.id, page=audit_logs.prev_num) }}">
                  Ø§Ù„Ø³Ø§Ø¨Ù‚
                </a>
              </li>
              {% endif %}

              <li class="page-item disabled">
                <span class="page-link">ØµÙØ­Ø© {{ audit_logs.page }} Ù…Ù† {{ audit_logs.pages }}</span>
              </li>

              {% if audit_logs.has_next %}
              <li class="page-item">
                <a class="page-link"
                   href="{{ url_for('archive.file_details', file_id=file.id, page=audit_logs.next_num) }}">
                  Ø§Ù„ØªØ§Ù„ÙŠ
                </a>
              </li>
              {% endif %}
            </ul>
          </nav>

        {% else %}
          <p class="text-muted text-center mb-0">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</p>
        {% endif %}
      </div>
    </div>

  </div>
</div>
{% endblock %}
