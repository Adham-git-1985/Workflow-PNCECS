{% extends "layout.html" %}
{% block title %}Ø·Ù„Ø¨Ø§ØªÙŠ{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h3 class="mb-1">ğŸ“‚ Ø·Ù„Ø¨Ø§ØªÙŠ</h3>
        <small class="text-muted">
            ğŸ•’ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: {{ last_update.strftime("%Y-%m-%d %H:%M") }}
        </small>
    </div>
</div>

{% if requests %}

<!-- Counters -->
<div class="row g-3 mb-4">

  <div class="col-md">
    <a href="{{ url_for('my_requests', status='all') }}"
       class="card text-center shadow-sm border-secondary text-decoration-none">
      <div class="card-body">
        <small class="text-muted">ğŸ“„ Ø§Ù„ÙƒÙ„</small>
        <h3>{{ counters.total }}</h3>
      </div>
    </a>
  </div>

  <div class="col-md">
    <a href="{{ url_for('my_requests', status='in_progress') }}"
       class="card text-center shadow-sm border-warning text-decoration-none">
      <div class="card-body">
        <small class="text-muted">ğŸ•“ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</small>
        <h3 class="text-warning">{{ counters.in_progress }}</h3>
      </div>
    </a>
  </div>

  <div class="col-md">
    <a href="{{ url_for('my_requests', status='draft') }}"
       class="card text-center shadow-sm border-secondary text-decoration-none">
      <div class="card-body">
        <small class="text-muted">ğŸ’¾ Ù…Ø³ÙˆØ¯Ø©</small>
        <h3 class="text-secondary">{{ counters.draft }}</h3>
      </div>
    </a>
  </div>

  <div class="col-md">
    <a href="{{ url_for('my_requests', status='approved') }}"
       class="card text-center shadow-sm border-success text-decoration-none">
      <div class="card-body">
        <small class="text-muted">âœ… Ù…ÙˆØ§ÙÙ‚</small>
        <h3 class="text-success">{{ counters.approved }}</h3>
      </div>
    </a>
  </div>

  <div class="col-md">
    <a href="{{ url_for('my_requests', status='rejected') }}"
       class="card text-center shadow-sm border-danger text-decoration-none">
      <div class="card-body">
        <small class="text-muted">âŒ Ù…Ø±ÙÙˆØ¶</small>
        <h3 class="text-danger">{{ counters.rejected }}</h3>
      </div>
    </a>
  </div>

</div>

<!-- Chart -->
<div class="card shadow-sm mb-4">
  <div class="card-body d-flex justify-content-center">
      <div class="chart-wrapper">
          <canvas id="requestsChart"></canvas>
      </div>
  </div>
</div>




<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('requestsChart');

new Chart(ctx, {
    type: 'pie',
    data: {
        labels: ['Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©', 'Ù…Ø³ÙˆØ¯Ø©', 'Ù…ÙˆØ§ÙÙ‚', 'Ù…Ø±ÙÙˆØ¶'],
        datasets: [{
            data: [
                {{ counters.in_progress }},
                {{ counters.draft }},
                {{ counters.approved }},
                {{ counters.rejected }}
            ],
            backgroundColor: [
                '#f4a261',
                '#adb5bd',
                '#2a9d8f',
                '#e63946'
            ]
        }]
    },
    options: {
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
</script>

<!-- Requests Table -->
<div class="table-responsive">
<table class="table table-hover align-middle">
    <thead class="table-light">
        <tr>
            <th>#</th>
            <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th class="text-center">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
    </thead>
    <tbody>
    {% for req in requests %}
        <tr>
            <td>{{ req.id }}</td>
            <td>{{ req.title }}</td>
            <td>
                <span class="badge bg-{{ {
                    'APPROVED':'success',
                    'REJECTED':'danger',
                    'ESCALATED':'warning',
                    'DRAFT':'secondary'
                }.get(req.status,'primary') }}">
                    {{ req.status }}
                </span>
            </td>
            <td class="text-center">
                <div class="d-flex gap-2 justify-content-center">
                    <a href="{{ url_for('review_request', request_id=req.id) }}"
                       class="btn btn-sm btn-outline-primary">
                        ğŸ‘ Ø¹Ø±Ø¶
                    </a>

                    <a href="{{ url_for('workflow.request_pdf', request_id=req.id) }}"
                       class="btn btn-secondary">
                        ğŸ“„ PDF
                    </a>

                    <a href="{{ url_for('request_audit', request_id=req.id) }}"
                       class="btn btn-sm btn-outline-dark">
                        ğŸ§¾ Audit
                    </a>
                </div>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>
</div>

{% else %}
<div class="alert alert-light text-center">
    Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù‚Ù…Øª Ø¨Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§ Ø¨Ø¹Ø¯.
</div>
{% endif %}

{% endblock %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {

    const ctx = document.getElementById("statusChart");

    if (!ctx) return;

    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Approved', 'Rejected', 'In Progress'],
            datasets: [{
                data: [
                    {{ counters.approved }},
                    {{ counters.rejected }},
                    {{ counters.in_progress }}
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,   // â­ Ù‡Ø°Ø§ Ø³Ø± Ø§Ù„ØªØµØºÙŠØ±
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
});
</script>
