{% extends "portal/layout.html" %}
{% block title %}{% if item %}تعديل رحلة{% else %}تسجيل رحلة{% endif %}{% endblock %}
{% block content %}

{% include "portal/transport/_nav.html" %}


<div class="d-flex align-items-center justify-content-between mb-3">
  <h5 class="mb-0"><i class="bi bi-map"></i> {% if item %}تعديل رحلة #{{ item.id }}{% else %}تسجيل رحلة{% endif %}</h5>
  <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('portal.transport_trips') }}">رجوع</a>
</div>

<div class="bg-white rounded-3 shadow-sm p-3">
  <form method="post" class="row g-3">
    <div class="col-md-4">
      <label class="form-label">إذن مرتبط (اختياري)</label>
      <select class="form-select" name="permit_id">
        <option value="">—</option>
        {% for p in permits %}
          <option value="{{ p.id }}" {% if item and item.permit_id == p.id %}selected{% endif %}>#{{ p.id }} — {{ p.purpose }}</option>
        {% endfor %}
      </select>
      <div class="form-text">يفضل اختيار إذن مُعتمد لربط الرحلة به.</div>
    </div>

    <div class="col-md-4">
      <label class="form-label">السيارة *</label>
      <select class="form-select" name="vehicle_id" required>
        <option value="">—</option>
        {% for v in vehicles %}
          <option value="{{ v.id }}" {% if item and item.vehicle_id == v.id %}selected{% endif %}>{{ v.plate_no }}{% if v.label %} — {{ v.label }}{% endif %}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-4">
      <label class="form-label">السائق</label>
      <select class="form-select" name="driver_id">
        <option value="">—</option>
        {% for d in drivers %}
          <option value="{{ d.id }}" {% if item and item.driver_id == d.id %}selected{% endif %}>{{ d.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-4">
      <label class="form-label">وقت الانطلاق *</label>
      <input class="form-control" type="datetime-local" name="started_at" required value="{{ item.started_at.strftime('%Y-%m-%dT%H:%M') if item and item.started_at else '' }}">
    </div>
    <div class="col-md-4">
      <label class="form-label">وقت الوصول</label>
      <input class="form-control" type="datetime-local" name="ended_at" value="{{ item.ended_at.strftime('%Y-%m-%dT%H:%M') if item and item.ended_at else '' }}">
    </div>
    <div class="col-md-4">
      <label class="form-label">ملاحظة</label>
      <input class="form-control" name="note" placeholder="تفاصيل الرحلة..." value="{{ item.note if item and item.note else '' }}">
    </div>

    <div class="col-md-4">
      <label class="form-label">عداد بداية (كم)</label>
      <input class="form-control" type="number" step="0.1" min="0" name="start_odometer" value="{{ item.start_odometer if item and item.start_odometer is not none else '' }}">
    </div>
    <div class="col-md-4">
      <label class="form-label">عداد نهاية (كم)</label>
      <input class="form-control" type="number" step="0.1" min="0" name="end_odometer" value="{{ item.end_odometer if item and item.end_odometer is not none else '' }}">
    </div>
    <div class="col-md-4">
      <label class="form-label">المسافة</label>
      <div class="form-text">تُحسب تلقائياً من الفرق بين العدّادين (إن توفرا).</div>
    </div>

    <div class="col-12 d-flex gap-2">
      <button class="btn btn-primary" type="submit">حفظ</button>
      <a class="btn btn-outline-secondary" href="{{ url_for('portal.transport_trips') }}">إلغاء</a>
    </div>

    <div class="col-12">
      <div class="alert alert-info mb-0">
        <b>التتبع:</b> عند تفعيل أجهزة التتبع لاحقاً، يمكن إضافة نقاط المسار تلقائياً وربطها بهذه الرحلة.
      </div>
    </div>
  </form>
</div>

{% endblock %}
