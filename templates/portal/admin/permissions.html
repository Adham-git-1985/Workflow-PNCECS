{% extends "portal/layout.html" %}

{% block title %}صلاحيات البوابة{% endblock %}

{% block head %}
<style>
  .perm-group-title { font-weight: 700; }
  .perm-desc { color:#6c757d; font-size:.85rem; margin-top:2px; }
  .perm-tools { display:flex; gap:.5rem; flex-wrap:wrap; }
  .perm-search { max-width: 420px; }
  .sticky-actions { position: sticky; top: 8px; z-index: 5; }
  .badge-soft { background: rgba(255,255,255,.08); border: 1px solid rgba(0,0,0,.08); }
  .perm-key { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  .preset-btn { min-width: 150px; }
</style>
{% endblock %}

{% block content %}
{% set next_url = url_for('portal.portal_admin_permissions', scope=scope, role=selected_role, user_id=(selected_user.id if selected_user else None), q=q) %}

<div class="d-flex justify-content-between align-items-start mb-3">
  <div>
    <h4 class="mb-1">إدارة صلاحيات البوابة</h4>
    <div class="text-muted small">
      هذه الصفحة تعدّل <strong>فقط</strong> صلاحيات البوابة الإدارية (Portal) — ولا تؤثر على صلاحيات المسار/الأرشفة.
    </div>
  </div>

  <div class="d-flex flex-wrap gap-2">
    <a class="btn btn-sm btn-outline-info" href="{{ url_for('portal.portal_admin_permissions_catalog') }}">
      <i class="bi bi-book"></i> دليل الصلاحيات
    </a>
    <a class="btn btn-sm btn-outline-dark" href="{{ url_for('portal.portal_admin_permission_presets') }}">
      <i class="bi bi-sliders"></i> اختصارات الصلاحيات
    </a>
    <a class="btn btn-sm btn-outline-success" href="{{ url_for('portal.portal_excel_import', key='portal.portal_admin_permissions', next=next_url) }}">
      <i class="bi bi-upload"></i> استيراد Excel
    </a>
    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('portal.portal_admin_permissions', scope=scope, role=selected_role, user_id=(selected_user.id if selected_user else None), q=q, export=1) }}">
      <i class="bi bi-download"></i> تصدير Excel
    </a>
  </div>
</div>

<ul class="nav nav-tabs mb-3">
  <li class="nav-item">
    <a class="nav-link {% if scope == 'role' %}active{% endif %}"
       href="{{ url_for('portal.portal_admin_permissions', scope='role', role=selected_role) }}">
      <i class="bi bi-people"></i> حسب الدور
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if scope == 'user' %}active{% endif %}"
       href="{{ url_for('portal.portal_admin_permissions', scope='user', user_id=(selected_user.id if selected_user else None)) }}">
      <i class="bi bi-person"></i> حسب المستخدم
    </a>
  </li>
</ul>

<div class="card shadow-sm mb-3">
  <div class="card-body">

    {% if scope == 'role' %}
      <form method="get" class="row g-2 align-items-end">
        <input type="hidden" name="scope" value="role">

        <div class="col-12 col-md-4">
          <label class="form-label">اختر الدور</label>
          <select name="role" class="form-select" onchange="this.form.submit()">
            <option value="">— اختر —</option>
            {% if role_items %}
              {% for r in role_items %}
                {% set code = r.code %}
                <option value="{{ code }}" {% if selected_role==code %}selected{% endif %}>
                  {{ code }}{% if r.name_ar %} — {{ r.name_ar }}{% elif r.name_en %} — {{ r.name_en }}{% endif %}{% if r.count is not none %} ({{ r.count }}){% endif %}
                </option>
              {% endfor %}
            {% else %}
              {% for r in role_codes %}
                <option value="{{ r }}" {% if selected_role==r %}selected{% endif %}>{{ r }}</option>
              {% endfor %}
            {% endif %}
          </select>
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">بحث داخل الصلاحيات</label>
          <input id="permSearch" class="form-control perm-search" placeholder="ابحث بالاسم أو المفتاح...">
        </div>

        <div class="col-12 col-md-4">
          <div class="sticky-actions">
            <button type="button" class="btn btn-outline-secondary w-100" onclick="clearAll()">
              <i class="bi bi-x-circle"></i> إلغاء تحديد الكل
            </button>
          </div>
        </div>
      </form>

      {% if not selected_role %}
        <div class="alert alert-warning mt-3 mb-0">اختر دورًا لعرض وتعديل صلاحياته.</div>
      {% endif %}

    {% else %}
      <form method="get" class="row g-2 align-items-end">
        <input type="hidden" name="scope" value="user">

        <div class="col-12 col-md-4">
          <label class="form-label">بحث عن مستخدم</label>
          <input name="q" value="{{ q }}" class="form-control" placeholder="اسم أو بريد إلكتروني" />
          <div class="form-text">اكتب جزء من الاسم أو البريد ثم اضغط Enter.</div>
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">اختر المستخدم</label>
          <select name="user_id" class="form-select" onchange="this.form.submit()">
            <option value="">— اختر —</option>
            {% for u in users %}
              <option value="{{ u.id }}" {% if selected_user and selected_user.id==u.id %}selected{% endif %}>
                {{ u.full_name }}{% if u.email %} — {{ u.email }}{% endif %}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">بحث داخل الصلاحيات</label>
          <input id="permSearch" class="form-control perm-search" placeholder="ابحث بالاسم أو المفتاح...">
        </div>

      </form>

      {% if selected_user %}
        <div class="alert alert-info mt-3 mb-0">
          <div class="fw-semibold mb-1">
            ملاحظة مهمة
          </div>
          <div class="small">
            في وضع <strong>حسب المستخدم</strong> أنت تعدّل صلاحيات <strong>إضافية</strong> لهذا المستخدم فقط.
            إذا كانت الصلاحية ممنوحة من دور المستخدم، فإن إزالة التحديد هنا لن تلغيها.
          </div>
          <div class="small mt-2">
            الدور الحالي: <span class="badge bg-dark">{{ selected_user.role or '—' }}</span>
            <span class="ms-2 badge bg-secondary">من الدور</span>
            <span class="badge bg-success">محدد للمستخدم</span>
          </div>
        </div>
      {% else %}
        <div class="alert alert-warning mt-3 mb-0">ابحث ثم اختر مستخدمًا لعرض وتعديل صلاحياته.</div>
      {% endif %}

    {% endif %}

  </div>
</div>

{% set can_edit = (scope == 'role' and selected_role) or (scope == 'user' and selected_user) %}

{% if can_edit %}
<form method="post" id="permForm">
  <input type="hidden" name="scope" value="{{ scope }}">
  {% if scope == 'role' %}
    <input type="hidden" name="role" value="{{ selected_role }}">
  {% else %}
    <input type="hidden" name="user_id" value="{{ selected_user.id }}">
  {% endif %}

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="fw-semibold mb-2"><i class="bi bi-magic"></i> اختصارات سريعة</div>
      <div class="text-muted small mb-2">
        لتبسيط الاستخدام: اختر قالبًا جاهزًا (موظف / مدير / HR). الزر يقوم <strong>بتطبيق وحفظ</strong> مباشرة.
      </div>

      <div class="d-flex flex-wrap gap-2 align-items-stretch">
        {% for code, pr in presets_main.items() %}
          {# Server-side preset apply/save (works even if JS is disabled) #}
          <button type="submit" class="btn btn-primary preset-btn" name="preset_code" value="{{ code }}">
            <div class="fw-semibold">{{ pr.label }}</div>
            <div class="small opacity-75">تطبيق وحفظ</div>
          </button>
        {% endfor %}

        <button type="submit" class="btn btn-outline-danger preset-btn" name="preset_code" value="CLEAR"
                onclick="return confirm('هل تريد مسح جميع صلاحيات البوابة وحفظها؟');">
          <div class="fw-semibold">مسح</div>
          <div class="small opacity-75">إلغاء وحفظ</div>
        </button>
      </div>

      {% if presets_extra %}
        <div class="mt-3">
          <a class="small" data-bs-toggle="collapse" href="#morePresets" role="button" aria-expanded="false" aria-controls="morePresets">
            المزيد من الاختصارات...
          </a>
          <div class="collapse mt-2" id="morePresets">
            <div class="d-flex flex-wrap gap-2">
              {% for code, pr in presets_extra.items() %}
                <button type="submit" class="btn btn-outline-secondary btn-sm" name="preset_code" value="{{ code }}">
                  {{ pr.label }} (تطبيق وحفظ)
                </button>
              {% endfor %}
            </div>
            <div class="form-text mt-2">هذه الاختصارات تحفظ تلقائيًا (بدون الحاجة لضغط زر <strong>حفظ</strong>).</div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <div class="accordion" id="permAccordion">
    {% for group_name, perms in perm_groups.items() %}
      {% set group_idx = loop.index %}
      <div class="accordion-item">
        <h2 class="accordion-header" id="h{{ group_idx }}">
          <button class="accordion-button collapsed perm-group-title" type="button" data-bs-toggle="collapse" data-bs-target="#c{{ group_idx }}">
            {{ group_name }}
          </button>
        </h2>
        <div id="c{{ group_idx }}" class="accordion-collapse collapse" data-bs-parent="#permAccordion">
          <div class="accordion-body">
            <div class="perm-tools mb-2">
              <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectGroup({{ group_idx }}, true)">
                <i class="bi bi-check2-square"></i> تحديد الكل
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectGroup({{ group_idx }}, false)">
                <i class="bi bi-square"></i> إلغاء تحديد
              </button>
            </div>

            {% for p in perms %}
              {% set in_role = (p.key in role_checked_for_user) if scope=='user' else false %}
              {% set in_user = (p.key in checked) %}

              <div class="form-check perm-item" data-search="{{ (p.label ~ ' ' ~ p.key ~ ' ' ~ p.desc)|lower }}">
                <input class="form-check-input perm-box" type="checkbox" name="permissions" value="{{ p.key }}"
                       id="perm_{{ scope }}_{{ p.key }}"
                       data-group="{{ group_idx }}"
                       data-module="{{ p.module }}"
                       {% if in_user %}checked{% endif %}>

                <label class="form-check-label" for="perm_{{ scope }}_{{ p.key }}">
                  <span class="fw-semibold">{{ p.label }}</span>
                  <span class="text-muted small perm-key">({{ p.key }})</span>

                  {% if scope == 'user' %}
                    {% if in_role %}<span class="badge bg-secondary ms-2">من الدور</span>{% endif %}
                    {% if in_user %}<span class="badge bg-success ms-1">محدد للمستخدم</span>{% endif %}
                  {% endif %}

                  {% if p.desc %}<div class="perm-desc">{{ p.desc }}</div>{% endif %}
                </label>
              </div>
            {% endfor %}

          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="d-flex gap-2 mt-3">
    <button class="btn btn-primary">
      <i class="bi bi-save"></i> حفظ الصلاحيات
    </button>

    <a class="btn btn-outline-secondary" href="{{ url_for('portal.portal_admin_permissions', scope=scope, role=selected_role, user_id=(selected_user.id if selected_user else None), q=q) }}">
      إعادة تحميل
    </a>

    <button type="button" class="btn btn-outline-danger ms-auto" onclick="clearAll()">
      <i class="bi bi-x-circle"></i> إلغاء تحديد الكل
    </button>
  </div>
</form>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
  const PRESETS = {{ presets|tojson }};

  const searchInput = document.getElementById('permSearch');
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      const q = (this.value || '').toLowerCase().trim();
      document.querySelectorAll('#permForm .perm-item').forEach(function(el){
        const hay = el.getAttribute('data-search') || '';
        el.style.display = (!q || hay.includes(q)) ? '' : 'none';
      });
    });
  }

  function selectGroup(groupId, checked) {
    document.querySelectorAll('#permForm .perm-box[data-group="'+groupId+'"]').forEach(cb => cb.checked = checked);
  }

  function clearAll() {
    document.querySelectorAll('#permForm .perm-box').forEach(cb => cb.checked = false);
  }

  function applyPreset(code) {
    const pr = PRESETS ? PRESETS[code] : null;
    if (!pr || !pr.keys) return;

    // start from clean selection then apply
    clearAll();
    pr.keys.forEach(function(k){
      const cb = document.querySelector('#permForm .perm-box[value="' + k + '"]');
      if (cb) cb.checked = true;
    });

    // open first group for quick visibility
    try {
      const first = document.querySelector('#permAccordion .accordion-collapse');
      if (first) {
        const bs = bootstrap.Collapse.getOrCreateInstance(first, {toggle:false});
        bs.show();
      }
    } catch (e) {}
  }

  function applyPresetAndSave(code) {
    applyPreset(code);
    // submit immediately to reduce steps
    const f = document.getElementById('permForm');
    if (f) f.submit();
  }
</script>
{% endblock %}
