{% extends "portal/layout.html" %}
{% block title %}البوابة الإدارية{% endblock %}

{% block content %}
{% set f = flags if flags is defined else (portal_flags if portal_flags is defined else {}) %}
{% set s = stats if stats is defined else {} %}
{% set reqs = access_reqs if access_reqs is defined else {} %}

<div class="row g-3">
  <div class="col-12">
    <div class="p-4 bg-white rounded-3 shadow-sm">
      <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
        <div>
          <h4 class="mb-1">مرحباً {{ (current_user.name or current_user.email) }}</h4>
          <div class="text-muted">اختر الخدمة التي تريدها — سترى فقط ما هو مفعّل حسب صلاحياتك.</div>
        </div>
        <div class="d-flex gap-2 flex-wrap">
          {% if f.get('can_approve') and s.get('approvals_pending', 0)|int > 0 %}
            <a class="btn btn-outline-warning" href="{{ url_for('portal.hr_approvals') }}">
              <i class="bi bi-check2-square"></i> موافقات ({{ s.get('approvals_pending', 0) }})
            </a>
          {% endif %}
          <a class="btn btn-outline-secondary" href="{{ url_for('index') }}">
            <i class="bi bi-arrow-right"></i> العودة لمسار
          </a>
        </div>
      </div>

      <div class="mt-3 d-flex flex-wrap gap-2">
        {% if f.get('can_corr') %}
          <span class="badge text-bg-light border"><i class="bi bi-envelope"></i> وارد 30 يوم: <b>{{ s.get('corr_in_30', 0) }}</b></span>
          <span class="badge text-bg-light border"><i class="bi bi-send"></i> صادر 30 يوم: <b>{{ s.get('corr_out_30', 0) }}</b></span>
        {% endif %}
        {% if f.get('can_att') %}
          <span class="badge text-bg-light border"><i class="bi bi-clock"></i> أيام دوام هذا الشهر: <b>{{ s.get('att_days_month', 0) }}</b></span>
        {% endif %}
        {% if f.get('can_hr') %}
          <span class="badge text-bg-light border"><i class="bi bi-person-check"></i> طلباتي قيد المراجعة: <b>{{ s.get('my_requests_open', 0) }}</b></span>
        {% endif %}
      </div>
    </div>
  </div>



  <!-- Circulars -->
  <div class="col-12">
    <div class="p-4 bg-white rounded-3 shadow-sm">
      <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
        <h5 class="mb-0"><i class="bi bi-megaphone"></i> التعميمات</h5>
        <div class="d-flex gap-2 flex-wrap">
          <a class="btn btn-sm btn-outline-primary" href="{{ url_for('portal.circulars_list') }}">عرض الكل</a>
          {% if current_user.has_perm('PORTAL_CIRCULARS_MANAGE') %}
            <a class="btn btn-sm btn-primary" href="{{ url_for('portal.circular_new') }}">إصدار تعميم</a>
          {% endif %}
        </div>
      </div>
      <hr class="my-3" />

      {% if last_circulars and (last_circulars|length > 0) %}
        <div class="list-group">
          {% for c in last_circulars %}
            <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center gap-2"
               href="{{ url_for('portal.circular_view', circular_id=c.id) }}">
              <div class="flex-grow-1">
                <div class="fw-bold">{{ c.title }}</div>
                <div class="small text-muted">{{ c.created_at.strftime('%Y-%m-%d %H:%M') if c.created_at else '' }}</div>
              </div>
              {% if c.is_urgent %}
                <span class="badge text-bg-danger">مستعجل</span>
              {% endif %}
            </a>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-muted">لا توجد تعميمات حالياً.</div>
      {% endif %}
    </div>
  </div>
  <!-- Correspondence -->
  <div class="col-md-6">
    <div class="p-4 bg-white rounded-3 shadow-sm h-100">
      <h5 class="mb-2"><i class="bi bi-envelope-paper"></i> الصادر والوارد</h5>
      <div class="text-muted mb-3">سجل مستقل للوارد والصادر داخل البوابة.</div>
      {% if f.get('can_corr') %}
        <div class="d-flex gap-2 flex-wrap">
          <a class="btn btn-primary" href="{{ url_for('portal.corr_index') }}">فتح</a>
          <a class="btn btn-outline-primary" href="{{ url_for('portal.inbound_list') }}">الوارد</a>
          <a class="btn btn-outline-primary" href="{{ url_for('portal.outbound_list') }}">الصادر</a>
          {% if f.get('can_corr_create') %}
            <a class="btn btn-outline-secondary" href="{{ url_for('portal.inbound_new') }}">تسجيل وارد</a>
            <a class="btn btn-outline-secondary" href="{{ url_for('portal.outbound_new') }}">تسجيل صادر</a>
          {% endif %}
        </div>
      {% else %}
        <button class="btn btn-secondary" disabled>غير مفعّل</button>
        <div class="text-muted small mt-2">اطلب من الإدارة تفعيل خدمة الصادر/الوارد لك.</div>
        {% set r = reqs.get('corr') %}
        <div class="mt-3 d-flex flex-wrap gap-2 align-items-center">
          {% if r and r.status == 'PENDING' %}
            <span class="badge text-bg-warning">طلبك قيد المراجعة (#{{ r.id }})</span>
            <a class="btn btn-sm btn-link" href="{{ url_for('portal.my_access_requests') }}">عرض التفاصيل</a>
            <form method="post" action="{{ url_for('portal.cancel_access_request', req_id=r.id) }}" class="d-inline" onsubmit="return confirm('إلغاء طلب الصلاحية؟');">
              <button class="btn btn-sm btn-outline-danger" type="submit">إلغاء الطلب</button>
            </form>
          {% else %}
            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('portal.access_request_new', service='corr') }}">طلب صلاحية</a>
            <a class="btn btn-sm btn-link" href="{{ url_for('portal.my_access_requests') }}">متابعة طلباتي</a>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Attendance -->
  <div class="col-md-6">
    <div class="p-4 bg-white rounded-3 shadow-sm h-100">
      <h5 class="mb-2"><i class="bi bi-clock-history"></i> الدوام</h5>
      <div class="text-muted mb-3">عرض الدوام (وللإدارة: استيراد ومتابعة الأحداث).</div>
      {% if f.get('can_att') %}
        <div class="d-flex gap-2 flex-wrap">
          {% if current_user.has_perm('HR_ATTENDANCE_CREATE') %}
            <a class="btn btn-primary" href="{{ url_for('portal.hr_attendance_import') }}">فتح</a>
            <a class="btn btn-outline-secondary" href="{{ url_for('portal.hr_attendance_daily') }}">تقرير يومي</a>
          {% else %}
            <a class="btn btn-primary" href="{{ url_for('portal.hr_my_attendance') }}">عرض دوامي</a>
          {% endif %}
        </div>
        <div class="text-muted small mt-2">أيام هذا الشهر: <b>{{ s.get('att_days_month', 0) }}</b></div>
      {% else %}
        <button class="btn btn-secondary" disabled>غير مفعّل</button>
        <div class="text-muted small mt-2">اطلب من الإدارة تفعيل خدمة الدوام لك.</div>
        {% set r = reqs.get('attendance') %}
        <div class="mt-3 d-flex flex-wrap gap-2 align-items-center">
          {% if r and r.status == 'PENDING' %}
            <span class="badge text-bg-warning">طلبك قيد المراجعة (#{{ r.id }})</span>
            <a class="btn btn-sm btn-link" href="{{ url_for('portal.my_access_requests') }}">عرض التفاصيل</a>
            <form method="post" action="{{ url_for('portal.cancel_access_request', req_id=r.id) }}" class="d-inline" onsubmit="return confirm('إلغاء طلب الصلاحية؟');">
              <button class="btn btn-sm btn-outline-danger" type="submit">إلغاء الطلب</button>
            </form>
          {% else %}
            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('portal.access_request_new', service='attendance') }}">طلب صلاحية</a>
            <a class="btn btn-sm btn-link" href="{{ url_for('portal.my_access_requests') }}">متابعة طلباتي</a>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>

  <!-- HR -->
  <div class="col-md-6">
    <div class="p-4 bg-white rounded-3 shadow-sm h-100">
      <h5 class="mb-2"><i class="bi bi-people"></i> الموارد البشرية</h5>
      <div class="text-muted mb-3">إجازات، مغادرات، قسائم الراتب (حسب الصلاحيات).</div>
      {% if f.get('can_hr') %}
        <div class="d-flex gap-2 flex-wrap">
          <a class="btn btn-primary" href="{{ url_for('portal.hr_me_home') }}">فتح</a>
          <a class="btn btn-outline-primary" href="{{ url_for('portal.hr_my_payslip_current') }}">قسيمة هذا الشهر</a>
          {% if f.get('can_hr_req_create') %}
            <a class="btn btn-outline-secondary" href="{{ url_for('portal.hr_leave_request_new') }}">طلب إجازة</a>
            <a class="btn btn-outline-secondary" href="{{ url_for('portal.hr_permission_request_new') }}">طلب مغادرة</a>
          {% endif %}
          {% if f.get('can_approve') %}
            <a class="btn btn-outline-warning" href="{{ url_for('portal.hr_approvals') }}">الموافقات</a>
          {% endif %}
        </div>
        <div class="text-muted small mt-2">طلباتك قيد المراجعة: <b>{{ s.get('my_requests_open', 0) }}</b></div>
      {% else %}
        <button class="btn btn-secondary" disabled>غير مفعّل</button>
        <div class="text-muted small mt-2">اطلب من الإدارة تفعيل خدمات الموارد البشرية لك.</div>
        {% set r = reqs.get('hr') %}
        <div class="mt-3 d-flex flex-wrap gap-2 align-items-center">
          {% if r and r.status == 'PENDING' %}
            <span class="badge text-bg-warning">طلبك قيد المراجعة (#{{ r.id }})</span>
            <a class="btn btn-sm btn-link" href="{{ url_for('portal.my_access_requests') }}">عرض التفاصيل</a>
            <form method="post" action="{{ url_for('portal.cancel_access_request', req_id=r.id) }}" class="d-inline" onsubmit="return confirm('إلغاء طلب الصلاحية؟');">
              <button class="btn btn-sm btn-outline-danger" type="submit">إلغاء الطلب</button>
            </form>
          {% else %}
            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('portal.access_request_new', service='hr') }}">طلب صلاحية</a>
            <a class="btn btn-sm btn-link" href="{{ url_for('portal.my_access_requests') }}">متابعة طلباتي</a>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>


  <!-- Transport -->
  <div class="col-md-6">
    <div class="p-4 bg-white rounded-3 shadow-sm h-100">
      <h5 class="mb-2"><i class="bi bi-truck"></i> الحركة والنقل</h5>
      <div class="text-muted mb-3">السيارات، السائقون، أذون الحركة، الرحلات والمسافات (والتتبع لاحقاً — الخيار C).</div>
      {% if f.get('can_transport') %}
        <div class="d-flex gap-2 flex-wrap">
          <a class="btn btn-primary" href="{{ url_for('portal.transport_home') }}">فتح</a>
          <a class="btn btn-outline-primary" href="{{ url_for('portal.transport_permits') }}">أذون الحركة</a>
          <a class="btn btn-outline-secondary" href="{{ url_for('portal.transport_trips') }}">الرحلات</a>
          <a class="btn btn-outline-secondary" href="{{ url_for('portal.transport_maintenance_list') }}">الصيانة</a>
          <a class="btn btn-outline-secondary" href="{{ url_for('portal.transport_fuel_list') }}">الوقود</a>
          <a class="btn btn-outline-secondary" href="{{ url_for('portal.transport_destinations') }}">الوجهات</a>
        </div>
        <div class="text-muted small mt-2">
          رحلات هذا الشهر: <b>{{ s.get('transport_trips_month', 0) }}</b> —
          أذون قيد المراجعة: <b>{{ s.get('transport_permits_pending', 0) }}</b> —
          سيارات مُسجّلة: <b>{{ s.get('transport_vehicles', 0) }}</b>
        </div>
      {% else %}
        <button class="btn btn-secondary" disabled>غير مفعّل</button>
        <div class="text-muted small mt-2">اطلب من الإدارة تفعيل وحدة الحركة لك.</div>
        {% set r = reqs.get('transport') %}
        <div class="mt-3 d-flex flex-wrap gap-2 align-items-center">
          {% if r and r.status == 'PENDING' %}
            <span class="badge text-bg-warning">طلبك قيد المراجعة (#{{ r.id }})</span>
            <a class="btn btn-sm btn-link" href="{{ url_for('portal.my_access_requests') }}">عرض التفاصيل</a>
            <form method="post" action="{{ url_for('portal.cancel_access_request', req_id=r.id) }}" class="d-inline" onsubmit="return confirm('إلغاء طلب الصلاحية؟');">
              <button class="btn btn-sm btn-outline-danger" type="submit">إلغاء الطلب</button>
            </form>
          {% else %}
            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('portal.access_request_new', service='transport') }}">طلب صلاحية</a>
            <a class="btn btn-sm btn-link" href="{{ url_for('portal.my_access_requests') }}">متابعة طلباتي</a>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Store -->
  <div class="col-md-6">
    <div class="p-4 bg-white rounded-3 shadow-sm h-100">
      <h5 class="mb-2"><i class="bi bi-box-seam"></i> المستودع</h5>
      <div class="text-muted mb-3">سندات الصرف والإدخال والجرد والإتلاف والإرجاع + العهدة (داخل البوابة الإدارية).</div>
      {% if f.get('can_store') %}
        <div class="d-flex flex-wrap gap-2">
          <a class="btn btn-primary" href="{{ url_for('portal.inventory_home') }}">فتح</a>
          {% if f.get('can_store_manage') %}
            <a class="btn btn-soft-blue" href="{{ url_for('portal.inventory_issue_voucher_new') }}">سند صرف</a>
            <a class="btn btn-soft-blue" href="{{ url_for('portal.inventory_inbound_voucher_new') }}">سند إدخال</a>
          {% endif %}
        </div>
      {% else %}
        <button class="btn btn-secondary" disabled>غير مفعّل</button>
        <div class="text-muted small mt-2">اطلب من الإدارة تفعيل المستودع لك.</div>
        {% set r = reqs.get('store') %}
        <div class="mt-3 d-flex flex-wrap gap-2 align-items-center">
          {% if r and r.status == 'PENDING' %}
            <span class="badge text-bg-warning">طلبك قيد المراجعة (#{{ r.id }})</span>
            <a class="btn btn-sm btn-link" href="{{ url_for('portal.my_access_requests') }}">عرض التفاصيل</a>
            <form method="post" action="{{ url_for('portal.cancel_access_request', req_id=r.id) }}" class="d-inline" onsubmit="return confirm('إلغاء طلب الصلاحية؟');">
              <button class="btn btn-sm btn-outline-danger" type="submit">إلغاء الطلب</button>
            </form>
          {% else %}
            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('portal.access_request_new', service='store') }}">طلب صلاحية</a>
            <a class="btn btn-sm btn-link" href="{{ url_for('portal.my_access_requests') }}">متابعة طلباتي</a>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}
