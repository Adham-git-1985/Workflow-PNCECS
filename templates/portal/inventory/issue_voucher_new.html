{% extends "portal/inventory/base.html" %}

{# Safety: route should pass `form`, but keep template resilient. #}
{% set form = form if form is defined else {} %}
{% set form_lines = (form.get('lines', []) if form is defined and form.get is defined else []) %}

{% block inv_content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h5 class="m-0">إدخال سند صرف</h5>
  <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('portal.inventory_issue_voucher_list') }}"><i class="bi bi-journal-text"></i> سجل السندات</a>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <form method="post" enctype="multipart/form-data">
      <div class="row g-2">
        <div class="col-md-3">
          <label class="form-label">نوع الصرف</label>
          <select name="issue_kind" id="issueKind" class="form-select" required>
            <option value="ROOM" {% if form.issue_kind=='ROOM' %}selected{% endif %}>صرف إلى غرفة</option>
            <option value="WAREHOUSE" {% if form.issue_kind=='WAREHOUSE' %}selected{% endif %}>صرف إلى مستودع</option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">رقم السند</label>
          <input name="voucher_no" class="form-control" required value="{{ form.voucher_no|default('') }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">تاريخ السند</label>
          <input type="date" name="voucher_date" class="form-control" required value="{{ form.voucher_date|default('') }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">من مستودع</label>
          <select name="from_warehouse_id" class="form-select" required>
            <option value="">اختر</option>
            {% for w in warehouses %}
              <option value="{{ w.id }}" {% if form.from_warehouse_id==w.id %}selected{% endif %}>{{ w.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-6" id="toWarehouseWrap" style="display:none;">
          <label class="form-label">إلى مستودع</label>
          <select name="to_warehouse_id" class="form-select">
            <option value="">اختر</option>
            {% for w in warehouses %}
              <option value="{{ w.id }}" {% if form.to_warehouse_id==w.id %}selected{% endif %}>{{ w.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-6" id="toRoomWrap" style="display:none;">
          <label class="form-label">إلى غرفة</label>
          <select id="toRoomSelect" class="form-select mb-2">
            <option value="">بدون تحديد</option>
            {% for r in rooms|default([]) %}
              <option value="{{ r.label }}" {% if form.to_room_name==r.label %}selected{% endif %}>{{ r.label }}</option>
            {% endfor %}
          </select>
          <input name="to_room_name" id="toRoomName" class="form-control" value="{{ form.to_room_name|default('') }}" placeholder="اسم الغرفة (أو اختر من القائمة أعلاه)">
        </div>

        <div class="col-12">
          <label class="form-label">ملاحظات</label>
          <textarea name="note" class="form-control" rows="2">{{ form.note|default('') }}</textarea>
        </div>
      </div>

      <hr class="my-3">

      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="fw-bold">تفاصيل أصناف السند</div>
        <button class="btn btn-sm btn-outline-primary" type="button" id="addLine"><i class="bi bi-plus"></i> إضافة صنف</button>
      </div>

      <div class="table-responsive">
        <table class="table table-bordered align-middle" id="linesTable">
          <thead class="table-light">
            <tr>
              <th style="min-width:220px;">الصنف</th>
              <th style="width:110px;">الكمية</th>
              <th style="min-width:160px;">السيريال</th>
              <th style="width:160px;">بداية الصلاحية/الضمان</th>
              <th style="width:160px;">نهاية الصلاحية/الضمان</th>
              <th style="min-width:220px;">تفاصيل</th>
              <th style="width:70px;"></th>
            </tr>
          </thead>
          <tbody>
            {% for ln in form_lines %}
            <tr>
              <td>
                <select name="item_id[]" class="form-select" required>
                  <option value="">اختر</option>
                  {% for it in items %}
                    <option value="{{ it.id }}" {% if ln.item_id==it.id %}selected{% endif %}>{{ it.label }}</option>
                  {% endfor %}
                </select>
              </td>
              <td><input name="qty[]" class="form-control" value="{{ ln.qty|default(1) }}" type="number" step="0.01" min="0"></td>
              <td><input name="serial[]" class="form-control" value="{{ ln.serial|default('') }}"></td>
              <td><input name="w_start[]" class="form-control" value="{{ ln.w_start|default('') }}" type="date"></td>
              <td><input name="w_end[]" class="form-control" value="{{ ln.w_end|default('') }}" type="date"></td>
              <td><input name="details[]" class="form-control" value="{{ ln.details|default('') }}"></td>
              <td class="text-center"><button class="btn btn-sm btn-outline-danger" type="button" onclick="this.closest('tr').remove()"><i class="bi bi-x"></i></button></td>
            </tr>
            {% endfor %}
            {% if not form_lines %}
            <tr>
              <td>
                <select name="item_id[]" class="form-select" required>
                  <option value="">اختر</option>
                  {% for it in items %}
                    <option value="{{ it.id }}">{{ it.label }}</option>
                  {% endfor %}
                </select>
              </td>
              <td><input name="qty[]" class="form-control" value="1" type="number" step="0.01" min="0"></td>
              <td><input name="serial[]" class="form-control"></td>
              <td><input name="w_start[]" class="form-control" type="date"></td>
              <td><input name="w_end[]" class="form-control" type="date"></td>
              <td><input name="details[]" class="form-control"></td>
              <td class="text-center"><button class="btn btn-sm btn-outline-danger" type="button" onclick="this.closest('tr').remove()"><i class="bi bi-x"></i></button></td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <hr class="my-3">

      <div class="fw-bold mb-2">المرفقات</div>
      <div class="row g-2">
        <div class="col-md-6">
          <label class="form-label">المرفقات (إضافة متعدد)</label>
          <input type="file" name="attachments" multiple class="form-control">
        </div>
        <div class="col-md-6">
          <label class="form-label">اسم المرفق(ات)</label>
          <input name="attachments_title" class="form-control" placeholder="اختياري">
        </div>
      </div>

      <div class="d-flex justify-content-end gap-2 mt-3">
        <a class="btn btn-outline-secondary" href="{{ url_for('portal.inventory_home') }}">إلغاء</a>
        <button class="btn btn-primary" type="submit"><i class="bi bi-check2"></i> حفظ</button>
      </div>
    </form>
  </div>
</div>

<script>
(function(){
  const issueKind = document.getElementById('issueKind');
  const toWarehouseWrap = document.getElementById('toWarehouseWrap');
  const toRoomWrap = document.getElementById('toRoomWrap');
  const toRoomSelect = document.getElementById('toRoomSelect');
  const toRoomName = document.getElementById('toRoomName');

  function syncKind(){
    const v = (issueKind.value || 'ROOM');
    if(v === 'WAREHOUSE'){
      toWarehouseWrap.style.display='block';
      toRoomWrap.style.display='none';
    }else{
      toWarehouseWrap.style.display='none';
      toRoomWrap.style.display='block';
    }
  }
  issueKind.addEventListener('change', syncKind);
  syncKind();

  if(toRoomSelect && toRoomName){
    toRoomSelect.addEventListener('change', function(){
      if(this.value){
        toRoomName.value = this.value;
      }
    });
  }

  const addBtn = document.getElementById('addLine');
  const tbody = document.querySelector('#linesTable tbody');
  addBtn.addEventListener('click', function(){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <select name="item_id[]" class="form-select" required>
          <option value="">اختر</option>
          {% for it in items %}
            <option value="{{ it.id }}">{{ it.label }}</option>
          {% endfor %}
        </select>
      </td>
      <td><input name="qty[]" class="form-control" value="1" type="number" step="0.01" min="0"></td>
      <td><input name="serial[]" class="form-control"></td>
      <td><input name="w_start[]" class="form-control" type="date"></td>
      <td><input name="w_end[]" class="form-control" type="date"></td>
      <td><input name="details[]" class="form-control"></td>
      <td class="text-center"><button class="btn btn-sm btn-outline-danger" type="button" onclick="this.closest('tr').remove()"><i class="bi bi-x"></i></button></td>
    `;
    tbody.appendChild(tr);
  });
})();
</script>

{% endblock %}
