{% extends "portal/inventory/base.html" %}

{% set edit = edit if edit is defined else None %}

{% block inv_content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h5 class="m-0">صلاحيات الموظفين على المخازن</h5>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <form method="post">
      <input type="hidden" name="action" value="{% if edit %}update{% else %}create{% endif %}">
      {% if edit %}<input type="hidden" name="id" value="{{ edit.id }}">{% endif %}

      <div class="row g-2">
        <div class="col-md-4">
          <label class="form-label">الموظف</label>
          <select name="user_id" class="form-select" {% if edit %}disabled{% endif %} required>
            <option value="">اختر</option>
            {% for u in users %}
              <option value="{{ u.id }}" {% if edit and edit.user_id==u.id %}selected{% endif %}>{{ u.full_name }} ({{ u.email }})</option>
            {% endfor %}
          </select>
          {% if edit %}<input type="hidden" name="user_id" value="{{ edit.user_id }}">{% endif %}
        </div>
        <div class="col-md-4">
          <label class="form-label">المخزن</label>
          <select name="warehouse_id" class="form-select" {% if edit %}disabled{% endif %} required>
            <option value="">اختر</option>
            {% for w in warehouses %}
              <option value="{{ w.id }}" {% if edit and edit.warehouse_id==w.id %}selected{% endif %}>{{ w.name }}</option>
            {% endfor %}
          </select>
          {% if edit %}<input type="hidden" name="warehouse_id" value="{{ edit.warehouse_id }}">{% endif %}
        </div>
        <div class="col-md-4">
          <label class="form-label">مستوى الصلاحيات</label>
          <div class="d-flex flex-wrap gap-3 p-2 border rounded">
            <label class="form-check-label"><input class="form-check-input me-1" type="checkbox" name="can_view" {% if edit and edit.can_view %}checked{% endif %}> عرض</label>
            <label class="form-check-label"><input class="form-check-input me-1" type="checkbox" name="can_issue" {% if edit and edit.can_issue %}checked{% endif %}> صرف</label>
            <label class="form-check-label"><input class="form-check-input me-1" type="checkbox" name="can_inbound" {% if edit and edit.can_inbound %}checked{% endif %}> إدخال</label>
            <label class="form-check-label"><input class="form-check-input me-1" type="checkbox" name="can_stocktake" {% if edit and edit.can_stocktake %}checked{% endif %}> جرد</label>
            <label class="form-check-label"><input class="form-check-input me-1" type="checkbox" name="can_manage" {% if edit and edit.can_manage %}checked{% endif %}> إدارة</label>
          </div>
          <div class="form-text">إن لم تختر شيء، سيتم الحفظ بصلاحية “عرض” فقط.</div>
        </div>
      </div>

      <div class="d-flex justify-content-end gap-2 mt-3">
        {% if edit %}
          <a class="btn btn-outline-secondary" href="{{ url_for('portal.inventory_admin_warehouse_perms') }}">إلغاء</a>
        {% endif %}
        <button class="btn btn-primary" type="submit"><i class="bi bi-check2"></i> حفظ</button>
      </div>
    </form>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-striped align-middle">
        <thead>
          <tr>
            <th>الموظف</th>
            <th>المخزن</th>
            <th class="text-center">عرض</th>
            <th class="text-center">صرف</th>
            <th class="text-center">إدخال</th>
            <th class="text-center">جرد</th>
            <th class="text-center">إدارة</th>
            <th style="width:140px;"></th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          <tr>
            <td>{{ r.user.full_name if r.user else r.user_id }}</td>
            <td>{{ r.warehouse.name if r.warehouse else r.warehouse_id }}</td>
            <td class="text-center">{% if r.can_view %}<i class="bi bi-check2"></i>{% endif %}</td>
            <td class="text-center">{% if r.can_issue %}<i class="bi bi-check2"></i>{% endif %}</td>
            <td class="text-center">{% if r.can_inbound %}<i class="bi bi-check2"></i>{% endif %}</td>
            <td class="text-center">{% if r.can_stocktake %}<i class="bi bi-check2"></i>{% endif %}</td>
            <td class="text-center">{% if r.can_manage %}<i class="bi bi-check2"></i>{% endif %}</td>
            <td class="text-end">
              <a class="btn btn-sm btn-outline-primary" href="{{ url_for('portal.inventory_admin_warehouse_perms', edit_id=r.id) }}">تعديل</a>
              <form method="post" class="d-inline" onsubmit="return confirm('حذف السجل؟');">
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="id" value="{{ r.id }}">
                <button class="btn btn-sm btn-outline-danger" type="submit">حذف</button>
              </form>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="8" class="text-muted text-center">لا يوجد سجلات</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% endblock %}
