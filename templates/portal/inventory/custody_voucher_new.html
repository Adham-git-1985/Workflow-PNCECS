{% extends "portal/inventory/base.html" %}

{% set form = form if form is defined else {} %}
{% set form_lines = (form.get('lines', []) if form is defined and form.get is defined else []) %}

{% block inv_content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h5 class="m-0">سند جرد عهدة</h5>
  <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('portal.inventory_custody_voucher_list') }}"><i class="bi bi-journal-text"></i> سجل السندات</a>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <form method="post" enctype="multipart/form-data">
      <div class="row g-2">
        <div class="col-md-3">
          <label class="form-label">نوع العهدة</label>
          <select name="holder_kind" id="holderKind" class="form-select" required>
            <option value="EMPLOYEE" {% if form.holder_kind=='EMPLOYEE' %}selected{% endif %}>موظف</option>
            <option value="ROOM" {% if form.holder_kind=='ROOM' %}selected{% endif %}>غرفة</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">رقم السند</label>
          <input name="voucher_no" class="form-control" required value="{{ form.voucher_no|default('') }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">تاريخ السند</label>
          <input type="date" name="voucher_date" class="form-control" required value="{{ form.voucher_date|default('') }}">
        </div>

        <div class="col-md-3" id="holderUserWrap">
          <label class="form-label">الموظف</label>
          <select name="holder_user_id" class="form-select">
            <option value="">اختر</option>
            {% for u in users %}
              <option value="{{ u.id }}" {% if form.holder_user_id==u.id %}selected{% endif %}>{{ u.full_name or u.email }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3" id="holderRoomWrap" style="display:none;">
          <label class="form-label">الغرفة</label>
          <select name="holder_room_id" class="form-select">
            <option value="">اختر</option>
            {% for r in rooms %}
              <option value="{{ r.id }}" {% if form.holder_room_id==r.id %}selected{% endif %}>{{ r.label }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12">
          <label class="form-label">ملاحظات</label>
          <textarea name="note" class="form-control" rows="2">{{ form.note|default('') }}</textarea>
        </div>
      </div>

      <hr class="my-3">

      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="fw-bold">تفاصيل أصناف السند</div>
        <button class="btn btn-sm btn-outline-primary" type="button" id="addLine"><i class="bi bi-plus"></i> إضافة صنف</button>
      </div>

      <div class="table-responsive">
        <table class="table table-bordered align-middle" id="linesTable">
          <thead class="table-light">
            <tr>
              <th style="min-width:220px;">الصنف</th>
              <th style="width:110px;">الكمية</th>
              <th style="min-width:160px;">السيريال</th>
              <th style="width:160px;">بداية الصلاحية/الضمان</th>
              <th style="width:160px;">نهاية الصلاحية/الضمان</th>
              <th style="min-width:220px;">تفاصيل</th>
              <th style="width:70px;"></th>
            </tr>
          </thead>
          <tbody>
            {% for ln in form_lines %}
            <tr>
              <td>
                <select name="item_id[]" class="form-select" required>
                  <option value="">اختر</option>
                  {% for it in items %}
                    <option value="{{ it.id }}" {% if ln.item_id==it.id %}selected{% endif %}>{{ it.label }}</option>
                  {% endfor %}
                </select>
              </td>
              <td><input name="qty[]" class="form-control" value="{{ ln.qty|default(1) }}" type="number" step="0.01" min="0"></td>
              <td><input name="serial[]" class="form-control" value="{{ ln.serial|default('') }}"></td>
              <td><input name="w_start[]" class="form-control" value="{{ ln.w_start|default('') }}" type="date"></td>
              <td><input name="w_end[]" class="form-control" value="{{ ln.w_end|default('') }}" type="date"></td>
              <td><input name="details[]" class="form-control" value="{{ ln.details|default('') }}"></td>
              <td class="text-center"><button class="btn btn-sm btn-outline-danger" type="button" onclick="this.closest('tr').remove()"><i class="bi bi-x"></i></button></td>
            </tr>
            {% endfor %}
            {% if not form_lines %}
            <tr>
              <td>
                <select name="item_id[]" class="form-select" required>
                  <option value="">اختر</option>
                  {% for it in items %}
                    <option value="{{ it.id }}">{{ it.label }}</option>
                  {% endfor %}
                </select>
              </td>
              <td><input name="qty[]" class="form-control" value="1" type="number" step="0.01" min="0"></td>
              <td><input name="serial[]" class="form-control"></td>
              <td><input name="w_start[]" class="form-control" type="date"></td>
              <td><input name="w_end[]" class="form-control" type="date"></td>
              <td><input name="details[]" class="form-control"></td>
              <td class="text-center"><button class="btn btn-sm btn-outline-danger" type="button" onclick="this.closest('tr').remove()"><i class="bi bi-x"></i></button></td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <hr class="my-3">

      <div class="fw-bold mb-2">المرفقات</div>
      <div class="row g-2">
        <div class="col-md-6">
          <label class="form-label">المرفقات (إضافة متعدد)</label>
          <input type="file" name="attachments" multiple class="form-control">
        </div>
        <div class="col-md-6">
          <label class="form-label">اسم المرفق(ات)</label>
          <input name="attachments_title" class="form-control" placeholder="اختياري">
        </div>
      </div>

      <div class="d-flex justify-content-end gap-2 mt-3">
        <a class="btn btn-outline-secondary" href="{{ url_for('portal.inventory_home') }}">إلغاء</a>
        <button class="btn btn-primary" type="submit"><i class="bi bi-check2"></i> حفظ</button>
      </div>
    </form>
  </div>
</div>

<script>
(function(){
  const kind = document.getElementById('holderKind');
  const wrapUser = document.getElementById('holderUserWrap');
  const wrapRoom = document.getElementById('holderRoomWrap');

  function syncKind(){
    const v = (kind.value || 'EMPLOYEE');
    if(v === 'ROOM'){
      wrapRoom.style.display='block';
      wrapUser.style.display='none';
    }else{
      wrapRoom.style.display='none';
      wrapUser.style.display='block';
    }
  }
  kind.addEventListener('change', syncKind);
  syncKind();

  const addBtn = document.getElementById('addLine');
  const tbody = document.querySelector('#linesTable tbody');
  addBtn.addEventListener('click', function(){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <select name="item_id[]" class="form-select" required>
          <option value="">اختر</option>
          {% for it in items %}
            <option value="{{ it.id }}">{{ it.label }}</option>
          {% endfor %}
        </select>
      </td>
      <td><input name="qty[]" class="form-control" value="1" type="number" step="0.01" min="0"></td>
      <td><input name="serial[]" class="form-control"></td>
      <td><input name="w_start[]" class="form-control" type="date"></td>
      <td><input name="w_end[]" class="form-control" type="date"></td>
      <td><input name="details[]" class="form-control"></td>
      <td class="text-center"><button class="btn btn-sm btn-outline-danger" type="button" onclick="this.closest('tr').remove()"><i class="bi bi-x"></i></button></td>
    `;
    tbody.appendChild(tr);
  });
})();
</script>

{% endblock %}
