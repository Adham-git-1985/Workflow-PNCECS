{% extends "portal/hr/base.html" %}
{% block title %}سجل المغادرات{% endblock %}

{% block hr_content %}
<div class="p-4 bg-white rounded-3 shadow-sm mb-3" id="permLogPrint">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
    <div>
      <h4 class="mb-1"><i class="bi bi-list-check"></i> سجل المغادرات</h4>
      <div class="text-muted small">فلترة وعرض جميع المغادرات (للأدمن/المدير حسب الصلاحيات).</div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-primary btn-sm" href="{{ url_for('portal.hr_permission_request_new') }}"><i class="bi bi-plus-circle"></i> إدخال مغادرة</a>
      <button class="btn btn-outline-secondary btn-sm" type="button" onclick="window.print()"><i class="bi bi-printer"></i> طباعة</button>
    </div>
  </div>

  <hr class="my-3"/>

  <form method="get" class="row g-2 align-items-end">
    <div class="col-12 col-md-3">
      <label class="form-label">محافظة العمل</label>
      <select class="form-select" name="work_governorate_lookup_id">
        <option value="">بدون تحديد</option>
        {% for it in govs %}
          <option value="{{ it.id }}" {% if work_governorate_lookup_id|int == it.id %}selected{% endif %}>{{ it.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-12 col-md-3">
      <label class="form-label">موقع العمل</label>
      <select class="form-select" name="work_location_lookup_id">
        <option value="">بدون تحديد</option>
        {% for it in locs %}
          <option value="{{ it.id }}" {% if work_location_lookup_id|int == it.id %}selected{% endif %}>{{ it.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-12 col-md-3">
      <label class="form-label">الموظف</label>
      <select class="form-select" name="user_id">
        <option value="">بدون تحديد</option>
        {% for u in users.values() %}
          <option value="{{ u.id }}" {% if user_id|int == u.id %}selected{% endif %}>{{ u.employee_file.emp_no if u.employee_file else '' }} - {{ u.name or u.email }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-12 col-md-3">
      <label class="form-label">نوع المغادرة</label>
      <select class="form-select" name="type_id">
        <option value="">بدون تحديد</option>
        {% for t in types %}
          <option value="{{ t.id }}" {% if type_id|int == t.id %}selected{% endif %}>{{ t.name_ar }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-6 col-md-2">
      <label class="form-label">من تاريخ</label>
      <input type="date" class="form-control" name="date_from" value="{{ date_from }}">
    </div>

    <div class="col-6 col-md-2">
      <label class="form-label">إلى تاريخ</label>
      <input type="date" class="form-control" name="date_to" value="{{ date_to }}">
    </div>

    <div class="col-12 col-md-2">
      <label class="form-label">الحالة</label>
      <select class="form-select" name="status">
        <option value="">بدون تحديد</option>
        {% for st in ['DRAFT','SUBMITTED','APPROVED','REJECTED','CANCELLED'] %}
          <option value="{{ st }}" {% if (status or '') == st %}selected{% endif %}>{{ st }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-12 col-md-3">
      <label class="form-label">مدخل البيانات</label>
      <select class="form-select" name="created_by_id">
        <option value="">بدون تحديد</option>
        {% for u in users.values() %}
          <option value="{{ u.id }}" {% if created_by_id|int == u.id %}selected{% endif %}>{{ u.name or u.email }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-12 col-md-3">
      <label class="form-label">بحث</label>
      <input class="form-control" name="q" value="{{ q }}" placeholder="اسم/إيميل/ملاحظة">
    </div>

    <div class="col-12 col-md-2">
      <button class="btn btn-primary w-100" type="submit"><i class="bi bi-search"></i> عرض</button>
    </div>
  </form>
</div>

<div class="bg-white rounded-3 shadow-sm">
  <div class="table-responsive">
    <table class="table table-striped table-hover mb-0 align-middle">
      <thead>
        <tr>
          <th style="width:70px">#</th>
          <th>الموظف</th>
          <th>نوع المغادرة</th>
          <th>التاريخ</th>
          <th>من</th>
          <th>إلى</th>
          <th>الحالة</th>
          <th>مدخل البيانات</th>
          <th style="width:120px"></th>
        </tr>
      </thead>
      <tbody>
        {% for r in reqs %}
          <tr>
            <td>{{ r.id }}</td>
            <td>{{ users[r.user_id].full_name if users.get(r.user_id) else r.user_id }}</td>
            <td>{{ r.permission_type.name_ar if r.permission_type else r.permission_type_id }}</td>
            <td>{{ r.day }}</td>
            <td>{{ r.from_time or '-' }}</td>
            <td>{{ r.to_time or '-' }}</td>
            <td>{{ r.status }}</td>
            <td>{{ users[r.created_by_id].full_name if users.get(r.created_by_id) else r.created_by_id }}</td>
            <td class="text-end">
              <a class="btn btn-sm btn-outline-primary" href="{{ url_for('portal.hr_permission_request_edit', req_id=r.id) }}"><i class="bi bi-pencil"></i> تعديل</a>
            </td>
          </tr>
        {% else %}
          <tr><td colspan="9" class="text-center text-muted py-4">لا توجد بيانات</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
