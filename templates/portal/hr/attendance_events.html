{% extends "portal/hr/base.html" %}
{% block title %}سجلات الدوام{% endblock %}

{% block hr_content %}
<div class="p-4 bg-white rounded-3 shadow-sm mb-3" id="attEventsPrint">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
    <div>
      <h4 class="mb-1"><i class="bi bi-clock-history"></i> سجلات الدوام</h4>
      <div class="text-muted">عرض حركات الدوام (Raw Events) مع فلاتر البحث الأساسية.</div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-primary" href="{{ url_for('portal.hr_attendance_events', q=q, date_from=date_from, date_to=date_to, event_type=event_type, work_location_lookup_id=work_location_lookup_id, closing=closing, device_id=device_id, batch_id=batch_id, user_id=user_id, export='xlsx') }}">
        <i class="bi bi-download"></i> Excel
      </a>
      <button class="btn btn-outline-secondary" onclick="window.print()"><i class="bi bi-printer"></i> طباعة</button>
    </div>
  </div>
</div>

<div class="bg-white rounded-3 shadow-sm p-3 mb-3">
  <form method="get" class="row g-2 align-items-end">
    <div class="col-md-4">
      <label class="form-label">الموظف</label>
      <select class="form-select" name="user_id">
        <option value="">بدون تحديد</option>
        {% for u in users.values() %}
          <option value="{{ u.id }}" {% if user_id|int == u.id %}selected{% endif %}>{{ u.name or u.email }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-4">
      <label class="form-label">موقع الدوام</label>
      <select class="form-select" name="work_location_lookup_id">
        <option value="">بدون تحديد</option>
        {% for it in (locs or []) %}
          <option value="{{ it.id }}" {% if work_location_lookup_id|int == it.id %}selected{% endif %}>{{ it.name_ar or it.name_en or it.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label">من</label>
      <input class="form-control" type="date" name="date_from" value="{{ date_from }}">
    </div>

    <div class="col-md-2">
      <label class="form-label">إلى</label>
      <input class="form-control" type="date" name="date_to" value="{{ date_to }}">
    </div>

    <div class="col-md-3">
      <label class="form-label">نوع الحركات</label>
      <select class="form-select" name="event_type">
        <option value="">بدون تحديد</option>
        <option value="I" {% if event_type == 'I' %}selected{% endif %}>دخول</option>
        <option value="O" {% if event_type == 'O' %}selected{% endif %}>خروج</option>
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">الإغلاق</label>
      <select class="form-select" name="closing">
        <option value="" {% if not closing %}selected{% endif %}>بدون تحديد</option>
        <option value="OPEN" {% if closing == 'OPEN' %}selected{% endif %}>غير مغلق</option>
        <option value="CLOSED" {% if closing == 'CLOSED' %}selected{% endif %}>مغلق</option>
      </select>
      <div class="form-text">(حاليًا خيار واجهة فقط)</div>
    </div>

    <div class="col-md-4">
      <label class="form-label">بحث</label>
      <input class="form-control" name="q" value="{{ q }}" placeholder="اسم/إيميل/ID...">
    </div>

    <div class="col-md-2">
      <button class="btn btn-primary w-100" type="submit"><i class="bi bi-search"></i> عرض</button>
    </div>
  </form>
</div>

<div class="bg-white rounded-3 shadow-sm p-3">
  <div class="table-responsive">
    <table class="table table-sm align-middle">
      <thead>
        <tr>
          <th>#</th>
          <th>الموظف</th>
          <th>التاريخ/الوقت</th>
          <th>النوع</th>
          <th>الجهاز</th>
          <th>Batch</th>
          <th class="text-muted">Raw</th>
        </tr>
      </thead>
      <tbody>
        {% for e in events %}
          {% set u = users.get(e.user_id) %}
          <tr>
            <td>{{ e.id }}</td>
            <td>
              {# Jinja ternary syntax: A if cond else B #}
              <div class="fw-bold">{{ u.name if (u and u.name) else (u.email if (u and u.email) else e.user_id) }}</div>
              <div class="text-muted small">{{ u.email if (u and u.email) else '' }}</div>
            </td>
            <td class="text-muted">{{ e.event_dt.strftime('%Y-%m-%d %H:%M') if e.event_dt else '' }}</td>
            <td>
              {% if e.event_type == 'I' %}<span class="badge text-bg-success">دخول</span>
              {% elif e.event_type == 'O' %}<span class="badge text-bg-danger">خروج</span>
              {% else %}<span class="badge text-bg-secondary">{{ e.event_type }}</span>
              {% endif %}
            </td>
            <td class="text-muted">{{ e.device_id or '' }}</td>
            <td class="text-muted">{{ e.batch_id or '' }}</td>
            <td class="text-muted small" style="max-width: 420px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ e.raw_line or '' }}</td>
          </tr>
        {% endfor %}
        {% if not events %}
          <tr><td colspan="7" class="text-center text-muted py-4">لا توجد بيانات.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
