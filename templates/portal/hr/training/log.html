{% extends 'portal/hr/base.html' %}

{% block title %}سجل التدريبات{% endblock %}

{% block hr_content %}
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
    <h4 class="mb-0">سجل التدريبات</h4>
    <div class="d-flex gap-2">
      <button type="button" class="btn btn-outline-secondary d-print-none" onclick="wfPrintSmart('#wfPrintArea')">
        <i class="bi bi-printer"></i> طباعة
      </button>
      {% if can_manage %}
        <a class="btn btn-primary" href="{{ url_for('portal.hr_training_program_new') }}">إضافة تدريب</a>
        <a class="btn btn-outline-primary" href="{{ url_for('portal.hr_training_admin_dashboard') }}">لوحة التحكم</a>
      {% endif %}
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header">فلترة</div>
    <div class="card-body">
      <form method="get" class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label">التدريب</label>
          <select name="course_id" class="form-select">
            <option value="">-- الكل --</option>
            {% for c in courses %}
              <option value="{{ c.id }}" {% if filters.course_id|int == c.id %}selected{% endif %}>{{ c.name_ar }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">منشور</label>
          <select name="published" class="form-select">
            <option value="" {% if not filters.published %}selected{% endif %}>الكل</option>
            <option value="1" {% if filters.published=='1' %}selected{% endif %}>نعم</option>
            <option value="0" {% if filters.published=='0' %}selected{% endif %}>لا</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">مكان التدريب</label>
          <select name="place" class="form-select">
            <option value="" {% if not filters.place %}selected{% endif %}>الكل</option>
            <option value="IN" {% if filters.place=='IN' %}selected{% endif %}>داخل الوطن</option>
            <option value="OUT" {% if filters.place=='OUT' %}selected{% endif %}>خارج الوطن</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">السنة</label>
          <input type="number" name="year" class="form-control" value="{{ filters.year }}" placeholder="2026">
        </div>
        {% if can_manage %}
        <div class="col-md-2">
          <label class="form-label">الموظف</label>
          <select name="employee_id" class="form-select">
            <option value="">-- الكل --</option>
            {% for u in employees %}
              <option value="{{ u.id }}" {% if filters.employee_id|int == u.id %}selected{% endif %}>{{ u.full_name or u.email }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
        <div class="col-12">
          <button class="btn btn-outline-secondary">تطبيق</button>
          <a class="btn btn-link" href="{{ url_for('portal.hr_training_log') }}">إعادة تعيين</a>
        </div>
      </form>
    </div>
  </div>

  <div class="card" id="wfPrintArea">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover mb-0">
          <thead>
            <tr>
              <th>التدريب</th>
              <th>منشور</th>
              <th>مكان التدريب</th>
              <th>السنة</th>
              <th>الفترة</th>
              {% if not can_manage %}<th>حالة الانتساب</th>{% endif %}
              <th class="text-end">إجراءات</th>
            </tr>
          </thead>
          <tbody>
            {% for p in programs %}
              {% set my = my_map.get(p.id) %}
              <tr>
                <td>
                  <div class="fw-bold">{{ p.course.name_ar if p.course else ('تدريب #' ~ p.id) }}</div>
                  <div class="small text-muted">رقم: {{ p.program_no or ('#' ~ p.id) }}</div>
                </td>
                <td>
                  {% if p.is_published %}
                    {% if p.publish_conditions_only %}
                      <span class="badge bg-warning text-dark">حسب الشروط فقط</span>
                    {% else %}
                      <span class="badge bg-success">نعم</span>
                    {% endif %}
                  {% else %}
                    <span class="badge bg-secondary">لا</span>
                  {% endif %}
                </td>
                <td>{{ place_map.get(p.id, '-') }}</td>
                <td>{{ (p.start_date or p.end_date or '')[:4] or '-' }}</td>
                <td>{{ p.start_date or '-' }} → {{ p.end_date or '-' }}</td>
                {% if not can_manage %}
                  <td>
                    {% if my %}
                      <span class="badge bg-info">{{ my.status }}</span>
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                {% endif %}
                <td class="text-end">
                  {% if can_manage %}
                    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('portal.hr_training_program_info', program_id=p.id) }}">تعديل</a>
                    <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('portal.hr_training_program_enrollments', program_id=p.id) }}">المنتسبين</a>
                  {% else %}
                    {% if my and my.status != 'WITHDRAWN' %}
                      <form method="post" action="{{ url_for('portal.hr_training_program_withdraw', program_id=p.id) }}" class="d-inline">
                        <button class="btn btn-sm btn-outline-danger">انسحاب</button>
                      </form>
                    {% elif open_map.get(p.id) %}
                      <form method="post" action="{{ url_for('portal.hr_training_program_apply', program_id=p.id) }}" class="d-inline">
                        <button class="btn btn-sm btn-primary">انتساب</button>
                      </form>
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  {% endif %}
                </td>
              </tr>
            {% else %}
              <tr><td colspan="7" class="text-center text-muted p-4">لا يوجد بيانات.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

{% endblock %}
