{% extends "portal/hr/base.html" %}
{% block title %}ุชูุฑูุฑ ุงูุฅุฌุงุฒุงุช ุงูุดูุฑู{% endblock %}

{% block hr_content %}
<div class="p-4 bg-white rounded-3 shadow-sm mb-3">
  <h4 class="mb-1"><i class="bi bi-journal-text"></i> ุชูุฑูุฑ ุงูุฅุฌุงุฒุงุช ุงูุดูุฑู</h4>
  <div class="text-muted">ูุฑุตุฏ ุณุงุนุงุช ุงููุบุงุฏุฑุงุช ุงููุณุชุฎุฏูุฉ ุฎูุงู ุงูุดูุฑุ ุงูุณุงุนุงุช ุงููุณููุญุฉุ ููุง ูุฒูุฏ ุนููุง (ููุญููู ุฅูู ุฃูุงู ุฅุฌุงุฒุฉ ููู ุณุงุนุงุช ุงูููู)ุ
    ุจุงูุฅุถุงูุฉ ุฅูู ุฃูุงู ุงูุฅุฌุงุฒุงุช ุงููุนุชูุฏุฉ (ููู-ุจููู) ูุฑุตูุฏ ุงูุฅุฌุงุฒุงุช ุญุชู ููุงูุฉ ุงูุดูุฑ.</div>
</div>

<div class="bg-white rounded-3 shadow-sm p-3 mb-3">
  <form method="get" class="row g-2 align-items-end">
    <div class="col-12 col-md-5">
      <label class="form-label">ุงูููุธู</label>
      <select class="form-select" name="user_id">
        <option value="">โ ุงุฎุชุฑ โ</option>
        {% for u in users %}
          <option value="{{ u.id }}" {% if selected_user and selected_user.id == u.id %}selected{% endif %}>{{ u.full_name or u.name or u.email }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">ุงูุณูุฉ</label>
      <input class="form-control" type="number" name="year" value="{{ year }}" min="2000" max="2100">
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">ุงูุดูุฑ</label>
      <input class="form-control" type="number" name="month" value="{{ month }}" min="1" max="12">
    </div>
    <div class="col-12 col-md-2">
      <button class="btn btn-primary w-100" type="submit"><i class="bi bi-search"></i> ุนุฑุถ</button>
    </div>
  </form>
</div>

<div class="row g-3">
  <div class="col-12 col-lg-6">
    <div class="bg-white rounded-3 shadow-sm p-3 h-100">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0"><i class="bi bi-gear"></i> ุฅุนุฏุงุฏุงุช ุงูุชูุฑูุฑ</h5>
        <span class="badge bg-secondary">ุฅุนุฏุงุฏุงุช ุนุงูุฉ</span>
      </div>
      {% if can_manage %}
      <form method="post" action="{{ url_for('portal.hr_monthly_leave_report_settings_update') }}" class="row g-2">
        <input type="hidden" name="user_id" value="{{ selected_user.id if selected_user else '' }}">
        <input type="hidden" name="year" value="{{ year }}">
        <input type="hidden" name="month" value="{{ month }}">

        <div class="col-12 col-md-4">
          <label class="form-label">ุงูุณุงุนุงุช ุงููุณููุญุฉ ุงูุชุฑุงุถููุง</label>
          <input class="form-control" type="number" name="default_allowed_hours" min="0" value="{{ default_allowed_hours }}">
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">ุณุงุนุงุช ููู ุงูุนูู</label>
          <input class="form-control" type="number" name="workday_hours" min="1" value="{{ workday_hours }}">
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">ุฎุตู ุงูุฒูุงุฏุฉ ูู ููุน ุงูุฅุฌุงุฒุฉ</label>
          <select class="form-select" name="excess_leave_type_id">
            <option value="0">โ ุจุฏูู โ</option>
            {% for lt in leave_types %}
              <option value="{{ lt.id }}" {% if excess_leave_type_id == lt.id %}selected{% endif %}>{{ lt.name_ar }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12">
          <button class="btn btn-outline-primary w-100" type="submit"><i class="bi bi-save"></i> ุญูุธ ุงูุฅุนุฏุงุฏุงุช</button>
        </div>
        <div class="col-12">
          <div class="alert alert-info mb-0 small">
            <div>๐ธ ุฅุฐุง ูู ูุชู ุชุญุฏูุฏ ุณูุงุญ ุดูุฑู ููููุธู ุณูุชู ุงุณุชุฎุฏุงู <b>ุงูุณุงุนุงุช ุงููุณููุญุฉ ุงูุชุฑุงุถููุง</b>.</div>
            <div>๐ธ ุงูุฒูุงุฏุฉ ุชูุญููู ุฅูู ุฃูุงู ุนุจุฑ: <code>excess_days = excess_hours / workday_hours</code>.</div>
          </div>
        </div>
      </form>
      {% else %}
        <div class="text-muted small mb-2">ุนุฑุถ ููุท (ูุง ุชููู ุตูุงุญูุฉ ุงูุชุนุฏูู)</div>
        {% set _lt = (leave_types|selectattr('id','equalto',excess_leave_type_id)|list) %}
        <ul class="list-unstyled small mb-3">
          <li>ุงูุณุงุนุงุช ุงููุณููุญุฉ ุงูุชุฑุงุถููุง: <b>{{ default_allowed_hours }}</b></li>
          <li>ุณุงุนุงุช ููู ุงูุนูู: <b>{{ workday_hours }}</b></li>
          <li>ููุน ุงูุฅุฌุงุฒุฉ ููุฎุตู: <b>{{ _lt[0].name_ar if _lt|length>0 else 'ุบูุฑ ูุญุฏุฏ' }}</b></li>
        </ul>
        <div class="alert alert-info mb-0 small">
          <div>๐ธ ุฅุฐุง ูู ูุชู ุชุญุฏูุฏ ุณูุงุญ ุดูุฑู ููููุธู ุณูุชู ุงุณุชุฎุฏุงู <b>ุงูุณุงุนุงุช ุงููุณููุญุฉ ุงูุชุฑุงุถููุง</b>.</div>
          <div>๐ธ ุงูุฒูุงุฏุฉ ุชูุญููู ุฅูู ุฃูุงู ุนุจุฑ: <code>excess_days = excess_hours / workday_hours</code>.</div>
        </div>
      {% endif %}
    </div>
  </div>

  <div class="col-12 col-lg-6">
    <div class="bg-white rounded-3 shadow-sm p-3 h-100">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0"><i class="bi bi-person-check"></i> ุณูุงุญ ูุบุงุฏุฑุงุช ุดูุฑู ููููุธู</h5>
        <span class="badge bg-secondary">ุชุฎุตูุต</span>
      </div>

      {% if selected_user and can_manage %}
      <form method="post" action="{{ url_for('portal.hr_monthly_leave_report_set_allowance') }}" class="row g-2">
        <input type="hidden" name="user_id" value="{{ selected_user.id }}">
        <input type="hidden" name="year" value="{{ year }}">
        <input type="hidden" name="month" value="{{ month }}">

        <div class="col-12 col-md-8">
          <label class="form-label">ุนุฏุฏ ุณุงุนุงุช ุงูุณูุงุญ ููุฐุง ุงูุดูุฑ</label>
          <input class="form-control" type="number" name="allowed_hours" min="0" value="{{ report.allowed_hours if report else default_allowed_hours }}">
        </div>
        <div class="col-12 col-md-4 d-flex align-items-end">
          <button class="btn btn-success w-100" type="submit"><i class="bi bi-save"></i> ุญูุธ</button>
        </div>

        <div class="col-12">
          <div class="alert alert-light border mb-0 small">
            ุณูุชู ุชุทุจูู ุงูุณูุงุญ ุนูู ูุฐุง ุงูููุธู ููุท ูุดูุฑ <b>{{ year }}-{{ "%02d"|format(month) }}</b>.
          </div>
        </div>
      </form>
      {% elif selected_user and not can_manage %}
        <div class="text-muted small mb-2">ุนุฑุถ ููุท (ูุง ุชููู ุตูุงุญูุฉ ุงูุชุนุฏูู)</div>
        <div class="border rounded-3 p-3">
          <div class="text-muted small">ุงูุณูุงุญ ููุฐุง ุงูุดูุฑ</div>
          <div class="fs-4">
            {{ report.allowed_hours if report else default_allowed_hours }}
          </div>
          <div class="small text-muted mt-1">ุดูุฑ {{ year }}-{{ "%02d"|format(month) }}</div>
        </div>
      {% else %}
        <div class="text-muted">ุงุฎุชุฑ ููุธููุง ูุนุฑุถ ูุฐุง ุงูุฌุฒุก.</div>
      {% endif %}
    </div>
  </div>
</div>

{% if selected_user and report %}
<div class="row g-3 mt-1">
  <div class="col-12">
    <div class="bg-white rounded-3 shadow-sm p-3">
      <h5 class="mb-2"><i class="bi bi-clipboard-data"></i> ููุฎุต ุงูุดูุฑ</h5>
      <div class="row g-3">
        <div class="col-6 col-lg-3">
          <div class="border rounded-3 p-3 h-100">
            <div class="text-muted small">ุงูุณุงุนุงุช ุงููุณููุญุฉ</div>
            <div class="fs-4">{{ report.allowed_hours }}</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="border rounded-3 p-3 h-100">
            <div class="text-muted small">ุณุงุนุงุช ุงููุบุงุฏุฑุงุช ุงููุณุชุฎุฏูุฉ</div>
            <div class="fs-4">{{ report.used_permission_hours }}</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="border rounded-3 p-3 h-100">
            <div class="text-muted small">ุงูุฒูุงุฏุฉ (ุณุงุนุงุช)</div>
            <div class="fs-4">{{ report.excess_hours }}</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="border rounded-3 p-3 h-100">
            <div class="text-muted small">ุงูุฒูุงุฏุฉ (ุฃูุงู)</div>
            <div class="fs-4">{{ "%.2f"|format(report.excess_days) }}</div>
          </div>
        </div>
      </div>

      <div class="mt-3 alert alert-warning mb-0">
        <div class="d-flex flex-wrap justify-content-between gap-2">
          <div>
            <b>ูุชุฑุฉ ุงูุชูุฑูุฑ:</b> {{ report.start_str }} โ {{ report.end_str }}
            <span class="text-muted">(ุงูุงุญุชุณุงุจ ููู-ุจููู ุญุชู: {{ report.as_of.strftime("%Y-%m-%d") if report.as_of else '' }})</span>
          </div>
          <div>
            <b>ููุน ุงูุฅุฌุงุฒุฉ ููุฎุตู:</b>
            {% if report.excess_deduct_leave_type %}
              {{ report.excess_deduct_leave_type.name_ar }}
            {% else %}
              <span class="text-muted">ุบูุฑ ูุญุฏุฏ</span>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-6">
    <div class="bg-white rounded-3 shadow-sm p-3 h-100">
      <h5 class="mb-2"><i class="bi bi-calendar2-check"></i> ุฃูุงู ุงูุฅุฌุงุฒุงุช ุฎูุงู ุงูุดูุฑ</h5>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>ููุน ุงูุฅุฌุงุฒุฉ</th>
              <th class="text-end">ุฃูุงู</th>
            </tr>
          </thead>
          <tbody>
            {% for item in leave_days_in_month %}
              <tr>
                <td>{{ item.leave_type.name_ar }}</td>
                <td class="text-end">{{ "%.2f"|format(item.days) }}</td>
              </tr>
            {% endfor %}
            {% if leave_days_in_month|length == 0 %}
              <tr><td colspan="2" class="text-center text-muted py-3">ูุง ููุฌุฏ ุจูุงูุงุช.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-6">
    <div class="bg-white rounded-3 shadow-sm p-3 h-100">
      <h5 class="mb-2"><i class="bi bi-pie-chart"></i> ุฑุตูุฏ ุงูุฅุฌุงุฒุงุช (ุญุชู ููุงูุฉ ุงูุดูุฑ)</h5>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>ููุน ุงูุฅุฌุงุฒุฉ</th>
              <th class="text-end">ุงูุงุณุชุญูุงู</th>
              <th class="text-end">ุงููุณุชุฎุฏู</th>
              <th class="text-end">ุงููุชุจูู</th>
            </tr>
          </thead>
          <tbody>
            {% for b in balances %}
              <tr>
                <td>{{ b.leave_type.name_ar }}</td>
                <td class="text-end">{{ "%.2f"|format(b.total) }}</td>
                <td class="text-end">{{ "%.2f"|format(b.used) }}</td>
                <td class="text-end">{{ "%.2f"|format(b.remaining) }}</td>
              </tr>
            {% endfor %}
            {% if balances|length == 0 %}
              <tr><td colspan="4" class="text-center text-muted py-3">ูุง ููุฌุฏ ุจูุงูุงุช.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
      <div class="text-muted small">ููุงุญุธุฉ: ุงูุงุณุชุญูุงู ูููุฑุฃ ุฃููุงู ูู ุฑุตูุฏ ููุนุฑูู ููููุธู/ุงูุณูุฉุ ุซู ูู ุงุณุชุญูุงู ุงูุฏุฑุฌุฉุ ุซู ูู ุงูุฑุตูุฏ ุงูุณููู ุงูุงูุชุฑุงุถู ูููุน ุงูุฅุฌุงุฒุฉ.</div>
    </div>
  </div>
</div>
{% endif %}

{% endblock %}
