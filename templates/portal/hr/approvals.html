{% extends "portal/hr/base.html" %}
{% block title %}موافقات الموارد البشرية{% endblock %}

{% block hr_content %}
<div class="p-4 bg-white rounded-3 shadow-sm mb-3">
  <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
    <div>
      <h4 class="mb-1"><i class="bi bi-check2-square"></i> الموافقات</h4>
      <div class="text-muted">طلبات الإجازات والمغادرات المرسلة إليك للمراجعة.</div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <form method="get" class="d-flex gap-2">
        <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
          {% set st = status or 'SUBMITTED' %}
          <option value="SUBMITTED" {% if st == 'SUBMITTED' %}selected{% endif %}>بانتظار الاعتماد</option>
          <option value="APPROVED" {% if st == 'APPROVED' %}selected{% endif %}>المعتمدة</option>
          <option value="REJECTED" {% if st == 'REJECTED' %}selected{% endif %}>المرفوضة</option>
          <option value="CANCELLED" {% if st == 'CANCELLED' %}selected{% endif %}>الملغاة</option>
          <option value="ALL" {% if st == 'ALL' %}selected{% endif %}>الكل</option>
        </select>
        <noscript><button class="btn btn-sm btn-outline-primary" type="submit">تطبيق</button></noscript>
      </form>
      {% if can_view_all %}
        <span class="badge bg-info text-dark">عرض شامل</span>
      {% endif %}
    </div>
  </div>
</div>

<div class="row g-3">
  <div class="col-12 col-lg-6">
    <div class="bg-white rounded-3 shadow-sm p-3">
      <div class="fw-semibold mb-2"><i class="bi bi-calendar2-check"></i> إجازات</div>
      {% if leave_reqs and leave_reqs|length > 0 %}
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>#</th>
                <th>{{ portal_sort_link('الموظف', 'user') }}</th>
                <th>{{ portal_sort_link('النوع', 'leave_type') }}</th>
                <th>{{ portal_sort_link('الفترة', 'start_date') }}</th>
                <th>الحالة</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for r in leave_reqs %}
                {% set st = (r.status or '').upper() %}
                {% set badge = 'secondary' %}
                {% if st == 'SUBMITTED' %}{% set badge = 'warning' %}{% endif %}
                {% if st == 'APPROVED' %}{% set badge = 'success' %}{% endif %}
                {% if st == 'REJECTED' %}{% set badge = 'danger' %}{% endif %}
                {% if st == 'CANCELLED' %}{% set badge = 'secondary' %}{% endif %}
                <tr>
                  <td class="text-muted">{{ r.id }}</td>
                  <td class="fw-semibold">{{ r.user.full_name if r.user else '-' }}</td>
                  <td>{{ r.leave_type.name_ar if r.leave_type else '-' }}</td>
                  <td class="small">{{ r.start_date }} → {{ r.end_date }}</td>
                  <td><span class="badge bg-{{ badge }}">{{ st }}</span></td>
                  <td class="text-end">
                    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('portal.hr_approval_leave', req_id=r.id) }}">
                      فتح
                    </a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-muted">لا يوجد طلبات.</div>
      {% endif %}
    </div>
  </div>

  <div class="col-12 col-lg-6">
    <div class="bg-white rounded-3 shadow-sm p-3">
      <div class="fw-semibold mb-2"><i class="bi bi-door-open"></i> مغادرات</div>
      {% if perm_reqs and perm_reqs|length > 0 %}
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>#</th>
                <th>{{ portal_sort_link('الموظف', 'user') }}</th>
                <th>{{ portal_sort_link('النوع', 'permission_type') }}</th>
                <th>{{ portal_sort_link('التاريخ', 'day') }}</th>
                <th>الحالة</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for r in perm_reqs %}
                {% set st = (r.status or '').upper() %}
                {% set badge = 'secondary' %}
                {% if st == 'SUBMITTED' %}{% set badge = 'warning' %}{% endif %}
                {% if st == 'APPROVED' %}{% set badge = 'success' %}{% endif %}
                {% if st == 'REJECTED' %}{% set badge = 'danger' %}{% endif %}
                {% if st == 'CANCELLED' %}{% set badge = 'secondary' %}{% endif %}
                <tr>
                  <td class="text-muted">{{ r.id }}</td>
                  <td class="fw-semibold">{{ r.user.full_name if r.user else '-' }}</td>
                  <td>{{ r.permission_type.name_ar if r.permission_type else '-' }}</td>
                  <td class="small">{{ r.day }}</td>
                  <td><span class="badge bg-{{ badge }}">{{ st }}</span></td>
                  <td class="text-end">
                    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('portal.hr_approval_permission', req_id=r.id) }}">
                      فتح
                    </a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-muted">لا يوجد طلبات.</div>
      {% endif %}
    </div>
  </div>
</div>

<div class="mt-3">
  <a class="btn btn-outline-secondary" href="{{ url_for('portal.hr_me_home') }}"><i class="bi bi-arrow-right"></i> العودة</a>
</div>
{% endblock %}
