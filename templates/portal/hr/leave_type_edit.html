{% extends "portal/hr/base.html" %}
{% block title %}تعديل نوع إجازة{% endblock %}

{% block hr_content %}
<div class="p-4 bg-white rounded-3 shadow-sm mb-3">
  <h4 class="mb-1"><i class="bi bi-pencil-square"></i> تعديل نوع إجازة</h4>
  <div class="text-muted">قم بتعديل البيانات ثم احفظ.</div>
</div>

<div class="bg-white rounded-3 shadow-sm p-3 mb-3">
  <form method="post">
    <div class="row g-3">
      <div class="col-12 col-md-3">
        <label class="form-label">CODE</label>
        <input class="form-control" name="code" value="{{ row.code }}" required>
      </div>
      <div class="col-12 col-md-5">
        <label class="form-label">الاسم بالعربية</label>
        <input class="form-control" name="name_ar" value="{{ row.name_ar }}" required>
      </div>
      <div class="col-12 col-md-4">
        <label class="form-label">Name (EN)</label>
        <input class="form-control" name="name_en" value="{{ row.name_en or '' }}">
      </div>

      <div class="col-12 col-md-3">
        <label class="form-label">تحتاج موافقة</label>
        <select class="form-select" name="requires_approval">
          <option value="1" {% if row.requires_approval %}selected{% endif %}>نعم</option>
          <option value="0" {% if not row.requires_approval %}selected{% endif %}>لا</option>
        </select>
      </div>

      <div class="col-12 col-md-3">
        <label class="form-label">حد الأيام</label>
        <input class="form-control" name="max_days" type="number" min="0" value="{{ row.max_days or '' }}">
        <div class="form-text">الحد الطبيعي لكل طلب. اتركه فارغاً إن لم يوجد حد.</div>
      </div>

      <div class="col-12 col-md-3">
        <label class="form-label">حد استثنائي (أيام)</label>
        <input class="form-control" name="exception_max_days" type="number" min="0" value="{{ row.exception_max_days or '' }}" placeholder="مثال: 90">
        <div class="form-text">يسمح بتجاوز (حد الأيام) حتى هذا الحد للحالات الخاصة (مثل إجازة مرضية مستعصية).</div>
      </div>

      <div class="col-12 col-md-3">
        <label class="form-label">الاستثناء يتطلب HR</label>
        <select class="form-select" name="exception_requires_hr">
          <option value="1" {% if row.exception_requires_hr %}selected{% endif %}>نعم</option>
          <option value="0" {% if not row.exception_requires_hr %}selected{% endif %}>لا</option>
        </select>
      </div>

      <div class="col-12 col-md-3">
        <label class="form-label">ملاحظة إلزامية عند الاستثناء</label>
        <select class="form-select" name="exception_requires_note">
          <option value="0" {% if not row.exception_requires_note %}selected{% endif %}>لا</option>
          <option value="1" {% if row.exception_requires_note %}selected{% endif %}>نعم</option>
        </select>
      </div>

      <div class="col-12 col-md-3">
        <label class="form-label">الرصيد السنوي الافتراضي (أيام)</label>
        <input class="form-control" name="default_balance_days" type="number" min="0" value="{{ row.default_balance_days or '' }}">
        <div class="form-text">يُستخدم للتقارير والتنبيهات، ويمكن تجاوزه عبر استحقاق الدرجة أو رصيد مخصص لموظف.</div>
      </div>

      <div class="col-12 col-md-3">
        <label class="form-label">إجازة خارجية؟</label>
        <select class="form-select" name="is_external">
          <option value="0" {% if not row.is_external %}selected{% endif %}>لا</option>
          <option value="1" {% if row.is_external %}selected{% endif %}>نعم</option>
        </select>
      </div>

      <div class="col-12 col-md-3">
        <label class="form-label">مرفقات مطلوبة؟</label>
        <select class="form-select" name="requires_documents">
          <option value="0" {% if not row.requires_documents %}selected{% endif %}>لا</option>
          <option value="1" {% if row.requires_documents %}selected{% endif %}>نعم</option>
        </select>
      </div>

      <div class="col-12 col-md-6">
        <label class="form-label">ملاحظة/نوع المستند</label>
        <input class="form-control" name="documents_hint" placeholder="مثال: تقرير طبي مختوم" value="{{ row.documents_hint or '' }}">
        <div class="form-text">يمكنك كتابة تعليمات للموظف حول المستند المطلوب (إن وجد).</div>
      </div>

      <div class="col-12 col-md-3">
        <label class="form-label">نشط</label>
        <select class="form-select" name="is_active">
          <option value="1" {% if row.is_active %}selected{% endif %}>نعم</option>
          <option value="0" {% if not row.is_active %}selected{% endif %}>لا</option>
        </select>
      </div>

      <div class="col-12 d-flex gap-2 flex-wrap">
        <button class="btn btn-primary" type="submit"><i class="bi bi-save"></i> حفظ</button>
        <a class="btn btn-outline-secondary" href="{{ url_for('portal.hr_masterdata_index') }}"><i class="bi bi-arrow-right"></i> رجوع</a>
      </div>
    </div>
  </form>
</div>

<div class="bg-white rounded-3 shadow-sm p-3" id="entitlements">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2">
    <div>
      <h5 class="mb-0"><i class="bi bi-list-check"></i> استحقاق الأيام حسب الدرجة</h5>
      <div class="text-muted small">يتم استخدام استحقاق الدرجة (إن وُجد) بدل الرصيد السنوي الافتراضي. يتم تحديد الدرجة من ملف الموظف (EmployeeFile.grade).</div>
    </div>
  </div>

  <form method="post" action="{{ url_for('portal.hr_leave_type_entitlement_upsert', lt_id=row.id) }}" class="row g-2 mb-3">
    <div class="col-12 col-md-4">
      <label class="form-label">الدرجة</label>
      <input class="form-control" name="grade" placeholder="مثال: A1 / B2" required>
    </div>
    <div class="col-12 col-md-4">
      <label class="form-label">الأيام المسموحة سنوياً</label>
      <input class="form-control" name="allowed_days" type="number" min="0" required>
    </div>
    <div class="col-12 col-md-4 d-flex align-items-end">
      <button class="btn btn-success w-100" type="submit"><i class="bi bi-plus-circle"></i> إضافة/تحديث</button>
    </div>
  </form>

  <div class="table-responsive">
    <table class="table table-sm align-middle">
      <thead>
        <tr>
          <th>الدرجة</th>
          <th>الأيام المسموحة</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for e in entitlements %}
          <tr>
            <td><code>{{ e.grade }}</code></td>
            <td>{{ e.allowed_days }}</td>
            <td class="text-end">
              <form method="post" action="{{ url_for('portal.hr_leave_type_entitlement_delete', lt_id=row.id, ent_id=e.id) }}" class="d-inline" onsubmit="return confirm('حذف استحقاق هذه الدرجة؟');">
                <button class="btn btn-sm btn-outline-danger" type="submit"><i class="bi bi-trash"></i> حذف</button>
              </form>
            </td>
          </tr>
        {% endfor %}
        {% if entitlements|length == 0 %}
          <tr><td colspan="3" class="text-center text-muted py-3">لا يوجد استحقاقات للدرجات لهذا النوع.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
