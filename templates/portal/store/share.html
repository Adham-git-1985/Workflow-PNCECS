{% extends "portal/layout.html" %}
{% block title %}مشاركة ملف{% endblock %}

{% block content %}
<div class="p-4 bg-white rounded-3 shadow-sm mb-3">
  <div class="d-flex align-items-center gap-2">
    <button class="btn btn-sm btn-outline-secondary no-print" type="button" onclick="wfPrintSmart('#storeSharePrint')">
      <i class="bi bi-printer"></i> طباعة
    </button>
    <a class="btn btn-sm btn-outline-secondary no-print" href="{{ url_for('users.help_store_guide') }}" target="_blank">
      <i class="bi bi-question-circle"></i> الدليل
    </a>

    <h4 class="mb-0"><i class="bi bi-share"></i> مشاركة ملف</h4>
    <a class="btn btn-outline-secondary ms-auto" href="{{ url_for('portal.store_home') }}">
      <i class="bi bi-arrow-right"></i> العودة للمستودع
    </a>
  </div>
  <div class="mt-2">
    <div class="fw-semibold">{{ f.display_name }}</div>
    <div class="text-muted small">{{ f.original_name }}{% if f.file_ext %} • {{ f.file_ext }}{% endif %}</div>
  </div>
</div>

<div class="p-3 bg-white rounded-3 shadow-sm mb-3">
  <form method="post" class="row g-2" id="shareForm">
    <div class="col-md-3">
      <label class="form-label">نوع المشاركة</label>
      <select class="form-select" name="mode" id="mode">
        <option value="user">مستخدم (بريد)</option>
        <option value="role">دور</option>
      </select>
    </div>

    <div class="col-md-5" id="userBox">
      <label class="form-label">بريد المستخدم</label>
      <input class="form-control" name="user_email" placeholder="example@pncecs.ps">
      <div class="form-text">سيتم البحث عن المستخدم حسب البريد.</div>
    </div>

    <div class="col-md-5 d-none" id="roleBox">
      <label class="form-label">الدور</label>
      <select class="form-select" name="role">
        <option value="">اختر دوراً...</option>
        {% for r in role_list %}
          <option value="{{ r }}">{{ r }}</option>
        {% endfor %}
      </select>
      <div class="form-text">سيتم تطبيق المشاركة على جميع المستخدمين ضمن هذا الدور.</div>
    </div>

    <div class="col-md-2">
      <label class="form-label">تنزيل؟</label>
      <div class="form-check mt-2">
        <input class="form-check-input" type="checkbox" value="1" name="can_download" id="can_download" checked>
        <label class="form-check-label" for="can_download">مسموح</label>
      </div>
    </div>

    <div class="col-md-4">
      <label class="form-label">تاريخ انتهاء (اختياري)</label>
      <input class="form-control" type="datetime-local" name="expires_at">
    </div>

    <div class="col-md-8 d-grid align-items-end">
      <button class="btn btn-primary" type="submit"><i class="bi bi-check2-circle"></i> حفظ المشاركة</button>
    </div>
  </form>
</div>

<div class="bg-white rounded-3 shadow-sm overflow-hidden id="storeSharePrint"">
  <div class="p-3 border-bottom d-flex align-items-center">
    <div class="fw-semibold">المشاركات الحالية</div>
    <a class="btn btn-sm btn-outline-primary ms-auto" href="{{ url_for('portal.store_file_view', file_id=f.id) }}" target="_blank">
      <i class="bi bi-eye"></i> عرض الملف
    </a>
  </div>

  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>{{ portal_sort_link('المستفيد', 'user') }}</th>
          <th class="text-nowrap">تنزيل</th>
          <th class="text-nowrap">{{ portal_sort_link('انتهاء', 'expires_at') }}</th>
          <th class="text-nowrap">إجراءات</th>
        </tr>
      </thead>
      <tbody>
        {% if not perms %}
          <tr>
            <td colspan="4" class="text-center text-muted py-4">لا توجد مشاركات بعد.</td>
          </tr>
        {% else %}
          {% for p in perms %}
            <tr>
              <td>
                {% if p.user %}
                  <div class="fw-semibold">{{ p.user.full_name if p.user.full_name else p.user.email }}</div>
                  <div class="text-muted small">{{ p.user.email }}</div>
                {% else %}
                  <div class="fw-semibold">الدور: {{ p.role }}</div>
                {% endif %}
              </td>
              <td class="text-nowrap">
                {% if p.can_download %}
                  <span class="badge text-bg-success">مسموح</span>
                {% else %}
                  <span class="badge text-bg-secondary">عرض فقط</span>
                {% endif %}
              </td>
              <td class="text-nowrap">
                {{ p.expires_at.strftime('%Y-%m-%d %H:%M') if p.expires_at else '-' }}
              </td>
              <td class="text-nowrap">
                <form method="post" action="{{ url_for('portal.store_file_share_delete', file_id=f.id, perm_id=p.id) }}" class="d-inline" onsubmit="return confirm('إلغاء المشاركة؟');">
                  <button class="btn btn-sm btn-outline-danger" type="submit"><i class="bi bi-x-circle"></i> إلغاء</button>
                </form>
              </td>
            </tr>
          {% endfor %}
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<script>
  (function() {
    var mode = document.getElementById('mode');
    var userBox = document.getElementById('userBox');
    var roleBox = document.getElementById('roleBox');
    function sync(){
      var v = (mode.value || '').toLowerCase();
      if(v === 'role'){
        userBox.classList.add('d-none');
        roleBox.classList.remove('d-none');
      } else {
        roleBox.classList.add('d-none');
        userBox.classList.remove('d-none');
      }
    }
    mode.addEventListener('change', sync);
    sync();
  })();
</script>
{% endblock %}
